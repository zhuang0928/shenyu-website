"use strict";(self.webpackChunkshenyu_website=self.webpackChunkshenyu_website||[]).push([[8623],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return d}});var i=n(67294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),c=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=c(e.components);return i.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},h=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),h=c(n),d=a,g=h["".concat(s,".").concat(d)]||h[d]||u[d]||o;return n?i.createElement(g,r(r({ref:t},p),{},{components:n})):i.createElement(g,r({ref:t},p))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,r[1]=l;for(var c=2;c<o;c++)r[c]=n[c];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}h.displayName="MDXCreateElement"},94665:function(e,t,n){n.r(t),n.d(t,{contentTitle:function(){return s},default:function(){return h},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var i=n(87462),a=n(63366),o=(n(67294),n(3905)),r=["components"],l={title:"ShenYu Agent Source Code Analysis",author:"midnight2104",author_title:"Apache ShenYu Committer",author_url:"https://github.com/midnight2104",tags:["zookeeper","data sync","Apache ShenYu"]},s=void 0,c={permalink:"/blog/Agent-SourceCode-Analysis",editUrl:"https://github.com/apache/incubator-shenyu-website/edit/main/blog/Agent-SourceCode-Analysis.md",source:"@site/blog/Agent-SourceCode-Analysis.md",title:"ShenYu Agent Source Code Analysis",description:"Apache ShenYu is an asynchronous, high-performance, cross-language, responsive API gateway.",date:"2022-03-17T09:29:55.361Z",formattedDate:"March 17, 2022",tags:[{label:"zookeeper",permalink:"/blog/tags/zookeeper"},{label:"data sync",permalink:"/blog/tags/data-sync"},{label:"Apache ShenYu",permalink:"/blog/tags/apache-shen-yu"}],readingTime:23.57,truncated:!1,nextItem:{title:"Etcd Data Synchronization Source Code Analysis",permalink:"/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync"}},p=[{value:"AboutAOP",id:"aboutaop",children:[]},{value:"About Byte Buddy",id:"about-byte-buddy",children:[]},{value:"1. premain method",id:"1-premain-method",children:[]},{value:"2. Read Config File",id:"2-read-config-file",children:[]},{value:"3. Load Plugin",id:"3-load-plugin",children:[]},{value:"4. Create Agent",id:"4-create-agent",children:[]},{value:"5. Start Plugin",id:"5-start-plugin",children:[]},{value:"6. Summary",id:"6-summary",children:[]}],u={toc:p};function h(e){var t=e.components,l=(0,a.Z)(e,r);return(0,o.kt)("wrapper",(0,i.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},(0,o.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/zh/docs/index"},"Apache ShenYu")," is an asynchronous, high-performance, cross-language, responsive API gateway.")),(0,o.kt)("p",null,"In the ",(0,o.kt)("inlineCode",{parentName:"p"},"Apache ShenYu")," gateway, ",(0,o.kt)("inlineCode",{parentName:"p"},"Apache ShenYu")," use ",(0,o.kt)("inlineCode",{parentName:"p"},"Java Agent")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Bytecode Enhancement")," technologies to enable seamless burial, allowing users to access third-party observability systems for ",(0,o.kt)("inlineCode",{parentName:"p"},"Traces"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"Metrics")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"Logging")," without introducing dependencies."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"This article is based on ",(0,o.kt)("inlineCode",{parentName:"p"},"shenyu-2.4.2")," version for source code analysis, please refer to ",(0,o.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/docs/user-guide/observability/observability/"},"Observability")," .")),(0,o.kt)("p",null,"Specifically, the ",(0,o.kt)("inlineCode",{parentName:"p"},"shenyu-agent")," module, which is based on the ",(0,o.kt)("inlineCode",{parentName:"p"},"Java Agent")," mechanism, through the ",(0,o.kt)("inlineCode",{parentName:"p"},"ByteBuddy")," bytecode enhancement library, to enhance the object at class load time, belongs to the static proxy."),(0,o.kt)("h3",{id:"aboutaop"},"AboutAOP"),(0,o.kt)("p",null,"Before analyzing the source code, the following ",(0,o.kt)("inlineCode",{parentName:"p"},"AOP")," related terms are introduced to facilitate subsequent understanding."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"JoinPoint"),": the join point, the point in time when the program is running, such as the execution point of a method."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"PointCut"),": entry point, the condition that matches ",(0,o.kt)("inlineCode",{parentName:"li"},"JoinPoint"),"."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Advice"),": notification, the specific execution logic."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Target"),": target object."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"Proxy"),": proxy object.")),(0,o.kt)("h3",{id:"about-byte-buddy"},"About Byte Buddy"),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"Byte Buddy")," is a code generation and manipulation library that creates and modifies ",(0,o.kt)("inlineCode",{parentName:"p"},"Java")," classes during the runtime of a ",(0,o.kt)("inlineCode",{parentName:"p"},"Java")," application. It can be used to create any class, unlike the ",(0,o.kt)("inlineCode",{parentName:"p"},"JDK")," dynamic proxy that forces an interface. In addition, ",(0,o.kt)("inlineCode",{parentName:"p"},"Byte Buddy")," provides a convenient API for changing classes manually, using the ",(0,o.kt)("inlineCode",{parentName:"p"},"Java")," proxy, or during the build."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"provides a very convenient API interface to match powerful classes, methods, etc."),(0,o.kt)("li",{parentName:"ul"},"out-of-the-box , zero learning costs , shielding the underlying operational bytecode technology ."),(0,o.kt)("li",{parentName:"ul"},"powerful open customizability features, allowing custom bytecode for any implemented method."),(0,o.kt)("li",{parentName:"ul"},"the principle of minimal runtime code generation for efficient performance.")),(0,o.kt)("h3",{id:"1-premain-method"},"1. premain method"),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"premain() function")," is the entry function for the ",(0,o.kt)("inlineCode",{parentName:"p"},"javaagent"),", which is provided by ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentBootstrap")," in ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenYu")," and implements the entire ",(0,o.kt)("inlineCode",{parentName:"p"},"agent")," logic."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'/**\n * agent bootstrap\n */\npublic class ShenyuAgentBootstrap {\n    \n    /**\n     *  premain.\n     */\n    public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {\n        // 1. read config file\n        ShenyuAgentConfigUtils.setConfig(ShenyuAgentConfigLoader.load());\n        // 2. load all plugins\n        ShenyuAgentPluginLoader.getInstance().loadAllPlugins();\n        // 3. create agent\n        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED))\n                .ignore(ElementMatchers.isSynthetic())\n                .or(ElementMatchers.nameStartsWith("org.apache.shenyu.agent."));\n        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())\n                .transform(new ShenyuAgentTransformer())\n                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)\n                .with(new TransformListener()).installOn(instrumentation);\n        // 4. start plugin\n        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();\n        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());\n        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));\n    }\n}\n')),(0,o.kt)("p",null,"The core logic of the ",(0,o.kt)("inlineCode",{parentName:"p"},"premain function")," is the four-step operation above."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li"},(0,o.kt)("li",{parentName:"ol"},"reading the configuration file."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:2},(0,o.kt)("li",{parentName:"ol"},"loading all plugins."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:3},(0,o.kt)("li",{parentName:"ol"},"create the agent."))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("ol",{parentName:"li",start:4},(0,o.kt)("li",{parentName:"ol"},"start the plug-in.")))),(0,o.kt)("p",null,"The next source code analysis will analyze these four operations in turn."),(0,o.kt)("h3",{id:"2-read-config-file"},"2. Read Config File"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentConfigLoader#load()")),(0,o.kt)("p",null,"The processing of the configuration file is done by ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentConfigLoader")," and the code is implemented as follows."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public final class ShenyuAgentConfigLoader {\n    // config path\n    private static final String CONFIG_PATH = "config-path";\n    \n    /**\n     * load file.\n     */\n    public static ShenyuAgentConfig load() throws IOException {\n        // get file path\n        String configPath = System.getProperty(CONFIG_PATH);\n        // if there is no configuration, read the default file shenyu-agent.yaml\n        File configFile = StringUtils.isEmpty(configPath) ? ShenyuAgentLocator.locatorConf("shenyu-agent.yaml") : new File(configPath);\n        // read the configuration file and parse it\n        return ShenyuYamlEngine.agentConfig(configFile);\n    }\n}\n')),(0,o.kt)("p",null,"You can specify the path of the configuration file by ",(0,o.kt)("inlineCode",{parentName:"p"},"config-path"),", if not, the default configuration file ",(0,o.kt)("inlineCode",{parentName:"p"},"shenyu-agent.yaml")," will be read, and then the configuration file will be parsed by ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuYamlEngine"),"."),(0,o.kt)("p",null,"The format of the configuration file is ",(0,o.kt)("inlineCode",{parentName:"p"},"yaml")," format, please refer to the introduction of the official website for how to configure it ",(0,o.kt)("a",{parentName:"p",href:"https://shenyu.apache.org/docs/user-guide/observability/observability/"},"observability")," ."),(0,o.kt)("p",null,"The default configuration file ",(0,o.kt)("inlineCode",{parentName:"p"},"shenyu-agent.yaml")," has the following format."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},'appName: shenyu-agent  # app name\nsupports:  # what features are currently supported\n  tracing: # tracing plugin\n#    - jaeger   \n#    - opentelemetry\n     - zipkin\n  metrics:  # metrics plugin\n    - \n  logging:  # logging plugin\n    - \n  \nplugins:  # plugin info\n  tracing:   \n    jaeger:  \n      host: "localhost"\n      port: 5775\n      props:\n        SERVICE_NAME: "shenyu-agent"\n        JAEGER_SAMPLER_TYPE: "const"\n        JAEGER_SAMPLER_PARAM: "1"\n    opentelemetry:  \n      props:\n        otel.traces.exporter: jaeger #zipkin #otlp\n        otel.resource.attributes: "service.name=shenyu-agent"\n        otel.exporter.jaeger.endpoint: "http://localhost:14250/api/traces"\n    zipkin: \n      host: "localhost"\n      port: 9411\n      props:\n        SERVICE_NAME: "shenyu-agent"\n        URL_VERSION: "/api/v2/spans"\n        SAMPLER_TYPE: "const"\n        SAMPLER_PARAM: "1"\n  metrics:   \n    prometheus: \n      host: "localhost"\n      port: 8081\n      props:\n  logging:   \n    elasticSearch: \n      host: "localhost"\n      port: 8082\n      props:\n    kafka:   \n      host: "localhost"\n      port: 8082\n      props:\n')),(0,o.kt)("p",null,"Which plugin you need to enable, specify it in ",(0,o.kt)("inlineCode",{parentName:"p"},"supports"),", and then ",(0,o.kt)("inlineCode",{parentName:"p"},"plugins")," to specify the configuration information of the plugin."),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"So far, the latest version of ",(0,o.kt)("inlineCode",{parentName:"p"},"Apache ShenYu")," released is ",(0,o.kt)("inlineCode",{parentName:"p"},"2.4.2")," version, the plugins that can support ",(0,o.kt)("inlineCode",{parentName:"p"},"tracing")," are ",(0,o.kt)("inlineCode",{parentName:"p"},"jaeger"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"opentelemetry")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"zipkin"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"metrics")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"logging")," will be released in subsequent versions one after another.")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuYamlEngine#agentConfig()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuYamlEngine")," provides how to customize the loading of files in ",(0,o.kt)("inlineCode",{parentName:"p"},"yaml")," format."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'    public static ShenyuAgentConfig agentConfig(final File yamlFile) throws IOException {\n        try (\n               // file inputStream\n                FileInputStream fileInputStream = new FileInputStream(yamlFile);\n                InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream)\n        ) {\n            Constructor constructor = new Constructor(ShenyuAgentConfig.class);\n            TypeDescription customTypeDescription = new TypeDescription(AgentPluginConfig.class);\n            customTypeDescription.addPropertyParameters("plugins", Map.class);\n            constructor.addTypeDescription(customTypeDescription);\n            //read yaml files by the Yaml toolkit \n            return new Yaml(constructor, new Representer(DUMPER_OPTIONS)).loadAs(inputStreamReader, ShenyuAgentConfig.class);\n        }\n    }\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentConfig")," is the specified Class ."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public final class ShenyuAgentConfig {\n    // app name, default shenyu-agent \n    private String appName = "shenyu-agent";\n    // supports plugin\n    private Map<String, List<String>> supports = new LinkedHashMap<>();\n    // plugins info\n    private Map<String, Map<String, AgentPluginConfig>> plugins = new LinkedHashMap<>();\n    \n}\n')),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"AgentPluginConfig")," is the Class  that specifies the plugin."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"public final class AgentPluginConfig {\n    private String host;\n    private int port;\n    private String password;\n    private Properties props;\n}\n")),(0,o.kt)("p",null,"Through the configuration file, the user can specify which plug-in to enable and specify information about the properties of the plug-in."),(0,o.kt)("h3",{id:"3-load-plugin"},"3. Load Plugin"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentPluginLoader#loadAllPlugins()")),(0,o.kt)("p",null,"After reading the configuration file, you need to load the specified plugin according to the user-defined configuration information. This is done by ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentPluginLoader"),"."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentPluginLoader")," is a custom class loader that uses the singleton design pattern."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'// Custom ClassLoader, extends ClassLoader\npublic final class ShenyuAgentPluginLoader extends ClassLoader implements Closeable {\n    private static final ShenyuAgentPluginLoader AGENT_PLUGIN_LOADER = new ShenyuAgentPluginLoader();\n    private ShenyuAgentPluginLoader() {\n        super(ShenyuAgentPluginLoader.class.getClassLoader());\n    }\n    \n    public static ShenyuAgentPluginLoader getInstance() {\n        return AGENT_PLUGIN_LOADER;\n    }\n    \n    /**\n     * load all plugins.\n     */\n    public void loadAllPlugins() throws IOException {\n        // 1. locating the plugin path\n        File[] jarFiles = ShenyuAgentLocator.locatorPlugin().listFiles(file -> file.getName().endsWith(".jar"));\n        if (Objects.isNull(jarFiles)) {\n            return;\n        }\n        // 2.load plugin definition\n        Map<String, ShenyuAgentJoinPoint> pointMap = new HashMap<>();\n        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {\n            for (File each : jarFiles) {\n                outputStream.reset();\n                JarFile jar = new JarFile(each, true);\n                jars.add(new PluginJar(jar, each));\n            }\n        }\n       \n        loadAgentPluginDefinition(pointMap);\n        Map<String, ShenyuAgentJoinPoint> joinPointMap = ImmutableMap.<String, ShenyuAgentJoinPoint>builder().putAll(pointMap).build();\n        // 3.set join point\n        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);\n    }\n}\n')),(0,o.kt)("h4",{id:"31-locating-the-plugin-path"},"3.1 Locating the Plugin Path"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentLocator#locatorPlugin()")),(0,o.kt)("p",null,"After the entire ",(0,o.kt)("inlineCode",{parentName:"p"},"shenyu")," project has been packaged in ",(0,o.kt)("inlineCode",{parentName:"p"},"maven")," (by executing the ",(0,o.kt)("inlineCode",{parentName:"p"},"mvn clean install")," command), the ",(0,o.kt)("inlineCode",{parentName:"p"},"agent")," package directory is as follows."),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(25754).Z})),(0,o.kt)("p",null,"The plugin files are in the form of ",(0,o.kt)("inlineCode",{parentName:"p"},"jar")," packages."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"conf")," directory is the directory location for configuration files."),(0,o.kt)("li",{parentName:"ul"},"The ",(0,o.kt)("inlineCode",{parentName:"li"},"plugins")," directory is the directory location of individual plugins.")),(0,o.kt)("p",null,"The corresponding source code processing logic for locating the plugin path is as follows."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'// The default plugin is located in the /plugins directory\npublic static File locatorPlugin() {\n        return new File(String.join("", locatorAgent().getPath(), "/plugins"));\n}\n\n// Locate the absolute path to shenyu-agent.jar\npublic static File locatorAgent() {\n    // Find the class path (package name) where ShenyuAgentLocator is located\n        String classResourcePath = String.join("", ShenyuAgentLocator.class.getName().replaceAll("\\\\.", "/"), ".class");\n    // Find the absolute path to the class: disk path + class path\n        URL resource = ClassLoader.getSystemClassLoader().getResource(classResourcePath);\n        assert resource != null;\n        String url = resource.toString();\n    // Whether it is in the form of a jar package\n        int existFileInJarIndex = url.indexOf(\'!\');\n        boolean isInJar = existFileInJarIndex > -1;\n    // Find the path from the jar package or Find the path from the resource file\n        return isInJar ? getFileInJar(url, existFileInJarIndex) : getFileInResource(url, classResourcePath);\n    }\n\n  // Find the path from the jar package\n    private static File getFileInJar(final String url, final int fileInJarIndex) {\n        // The absolute path to the jar package\n        String realUrl = url.substring(url.indexOf("file:"), fileInJarIndex);\n        try {\n            // Create File objects with absolute paths\n            File agentJarFile = new File(new URL(realUrl).toURI());\n            // Get the parent file\n            return agentJarFile.exists() ? agentJarFile.getParentFile() : null;\n        } catch (final MalformedURLException | URISyntaxException ex) {\n            return null;\n        }\n    }\n')),(0,o.kt)("p",null,"After getting all the plugin files, it will go to load the plugin definition, i.e. the interception point."),(0,o.kt)("h4",{id:"32-load-agent-plugin-definition"},"3.2 Load Agent Plugin Definition"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentPluginLoader#loadAgentPluginDefinition()")),(0,o.kt)("p",null,"The default configuration for interception points is in the ",(0,o.kt)("inlineCode",{parentName:"p"},"conf/tracing-point.yaml")," file, with the following configuration format."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-yaml"},"pointCuts:\n  - targetClass: org.apache.shenyu.plugin.global.GlobalPlugin  \n    points:\n      - type: instanceMethod \n        name: execute  \n    handlers:  \n      jaeger:   \n        - org.apache.shenyu.agent.plugin.tracing.jaeger.handler.JaegerGlobalPluginHandler\n      opentelemetry: \n        - org.apache.shenyu.agent.plugin.tracing.opentelemetry.handler.OpenTelemetryGlobalPluginHandler\n      zipkin:    \n        - org.apache.shenyu.agent.plugin.tracing.zipkin.handler.ZipkinGlobalPluginHandler\n        \n        // ......\n")),(0,o.kt)("p",null,"The loading of interceptors is done by means of ",(0,o.kt)("inlineCode",{parentName:"p"},"SPI")," and then these interceptors are collected."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"}," private void loadAgentPluginDefinition(final Map<String, ShenyuAgentJoinPoint> pointMap) {\n        SPILoader.loadList(AgentPluginDefinition.class)  // SPI \n                .forEach(each -> each.collector().forEach(def -> {  // collect\n                    String classTarget = def.getClassTarget();\n                    if (pointMap.containsKey(classTarget)) {\n                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);\n                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); //constructor points\n                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // instance method points\n                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // static method points\n                    } else {\n                        pointMap.put(classTarget, def);\n                    }\n                }));\n    }\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"SPILoader.loadList(AgentPluginDefinition.class)")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"AgentPluginDefinition")," is the interception point interface, marked by ",(0,o.kt)("inlineCode",{parentName:"p"},"@SPI"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"@SPI // The interface is loaded via SPI\npublic interface AgentPluginDefinition {\n    \n    /**\n     * collect point \n     */\n    Collection<ShenyuAgentJoinPoint> collector();\n}\n\n")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"TracingAgentPluginDefinition")," is one of its implementation classes to define the interception points for link tracing."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"@Join \npublic final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {\n       \n    // create join point \n    @Override\n    protected Collection<JoinPointBuilder> joinPointBuilder() {\n       // ......\n    }\n}\n\npublic abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {\n    //  create join point \n    protected abstract Collection<JoinPointBuilder> joinPointBuilder();\n    \n    //  collect join point \n    @Override\n    public final Collection<ShenyuAgentJoinPoint> collector() {\n        //......\n    }\n}\n\n")),(0,o.kt)("p",null,"The inheritance relationship between classes is as follows."),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(79678).Z})),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"AgentPluginDefinition#collector()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"AgentPluginDefinition")," is just an interface that defines the operation methods for collecting interception points, and the concrete implementation is given to the subclasses."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"public abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {\n    \n    // Subclasses to implement how to create interception points\n    protected abstract Collection<JoinPointBuilder> joinPointBuilder();\n\n    @Override\n    public final Collection<ShenyuAgentJoinPoint> collector() {\n        // get JoinPointBuilder\n        Collection<JoinPointBuilder> joinPointBuilders = joinPointBuilder();\n        // create ShenyuAgentJoinPoint\n        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());\n    }\n}\n\n // create ShenyuAgentJoinPoint\npublic ShenyuAgentJoinPoint install() {\n    // The four construction parameters are: target object, constructor interceptor point, instance method interceptor point, static method interceptor point\n    return new ShenyuAgentJoinPoint(classTarget, constructorPoints, instanceMethodPoints, classStaticMethodPoints);\n}\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"TracingAgentPluginDefinition#joinPointBuilder()"),(0,o.kt)("p",{parentName:"li"},"Create intercept points for tracing."))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'@Join\npublic final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {\n    // create join point\n    @Override\n    protected Collection<JoinPointBuilder> joinPointBuilder() {\n        PointCutConfig config = null;\n        try {\n            // Read the default interception point configuration file\n            config = ShenyuYamlEngine.unmarshal(ShenyuAgentLocator.locatorConf("tracing-point.yaml"), PointCutConfig.class);\n        } catch (IOException e) {\n            LOG.error("Exception loader tracing point config is", e);\n        }\n        // create join point\n        return JoinPointBuilderFactory.create(config);\n    }\n}\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"JoinPointBuilderFactory#create()"),(0,o.kt)("p",{parentName:"li"},"Create an intercept point based on the specified profile ."))),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"public static Collection<JoinPointBuilder> create(final PointCutConfig config) {\n        //If there is no profile or it is empty, return the empty set\n        if (Objects.isNull(config) || config.getPointCuts().isEmpty()) {\n            return Collections.emptyList();\n        }\n        return config.getPointCuts().stream() // Get the interception point defined in the configuration file\n                .filter(pointCut -> StringUtils.isNotEmpty(pointCut.getTargetClass())\n                        && !pointCut.getPoints().isEmpty() && !pointCut.getHandlers().isEmpty()) // The intercept point must specify the target class, entry point, processor\n                .map(pointCut -> {\n                    JoinPointBuilder builder = ShenyuAgentJoinPoint.interceptClass(pointCut.getTargetClass()); // Set the target class to be intercepted\n                    Set<String> supports = ShenyuAgentConfigUtils.getSupports(); // Get which plugins are currently supported\n                    List<String> handlers = pointCut.getHandlers().entrySet().stream()\n                            .filter(entry -> supports.contains(entry.getKey())) // The specified processor must be a currently supportable plugin\n                            .flatMap(entry -> entry.getValue().stream())\n                            .collect(Collectors.toList());\n                    String[] instanceMethods = pointCut\n                            .getPoints()\n                            .stream()\n                            .filter(point -> PointType.INSTANCE_METHOD.getName().equals(point.getType()))\n                            .map(Point::getName) // intercept instance methods\n                            .toArray(String[]::new);\n                    if (instanceMethods.length > 0) {\n                        builder.aroundInstanceMethod(ElementMatchers.namedOneOf(instanceMethods)).handlers(handlers).build(); // \u4e3a\u5b9e\u4f8b\u65b9\u6cd5\u6dfb\u52a0\u5339\u914d\u5668\u7528\u4e8e\u540e\u7eed\u8fd0\u884c\u65f6\u52a8\u6001\u5339\u914d\uff0c\u5e76\u6dfb\u52a0\u5bf9\u5e94\u7684\u5904\u7406\u5668\n                    }\n                    String[] staticMethods = pointCut\n                            .getPoints()\n                            .stream()\n                            .filter(point -> PointType.STATIC_METHOD.getName().equals(point.getType()))\n                            .map(Point::getName)\n                            .toArray(String[]::new); // intercept static methods\n                    if (staticMethods.length > 0) {\n                        builder.aroundStaticMethod(ElementMatchers.namedOneOf(staticMethods)).handlers(handlers).build();// Add matchers to static methods for subsequent dynamic matching at runtime, and add corresponding handlers\n                    }\n                    String[] constructorPoints = pointCut\n                            .getPoints()\n                            .stream()\n                            .filter(point -> PointType.CONSTRUCTOR.getName().equals(point.getType()))\n                            .map(Point::getName)\n                            .toArray(String[]::new); // intercept constructor methods\n                    if (constructorPoints.length > 0) {\n                        builder.onConstructor(ElementMatchers.namedOneOf(constructorPoints)).handlers(handlers).build();// Add a matcher to the constructor for subsequent dynamic matching at runtime, and add the corresponding handler\n                    }\n                    return builder;\n                }).collect(Collectors.toList()); // return result\n    }\n")),(0,o.kt)("p",null,"The main implementation logic for creating an interception point is to read the configuration information according to the configuration file and add the corresponding handler for the target method of the specified target object. There are three types of handlers: instance method handlers, static method handlers, and constructor handlers."),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"ElementMatchers.namedOneOf()")," method is used here, which indicates that the method name is in the specified parameter to match on the method. ",(0,o.kt)("inlineCode",{parentName:"p"},"ElementMatchers")," is a class in ",(0,o.kt)("inlineCode",{parentName:"p"},"bytebuddy"),", and in ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenYu"),", the creation of ",(0,o.kt)("inlineCode",{parentName:"p"},"agent")," is also done through ",(0,o.kt)("inlineCode",{parentName:"p"},"bytebuddy"),"."),(0,o.kt)("p",null,"The collected intercept points are later created as the intercept point object ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentJoinPoint"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"    public final Collection<ShenyuAgentJoinPoint> collector() {\n        // join point\n        Collection<JoinPointBuilder> joinPointBuilders = joinPointBuilder();\n        // create ShenyuAgentJoinPoint\n        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());\n    }\n")),(0,o.kt)("p",null,"After collecting the intercept points, the intercept point information is saved with ",(0,o.kt)("inlineCode",{parentName:"p"},"Map"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"// pointMap: Key and Value denote target class, interception point respectively\nprivate void loadAgentPluginDefinition(final Map<String, ShenyuAgentJoinPoint> pointMap) {\n        SPILoader.loadList(AgentPluginDefinition.class)  // SPI \n                .forEach(each -> each.collector().forEach(def -> {  // collect\n                    String classTarget = def.getClassTarget();\n                    if (pointMap.containsKey(classTarget)) {\n                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);\n                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); // constructor method points\n                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // instance method points\n                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // static method points\n                    } else {\n                        pointMap.put(classTarget, def); // Save intercept point information to Map\n                    }\n                }));\n    }\n   \n")),(0,o.kt)("h4",{id:"33-set-joint-point"},"3.3 Set Joint Point"),(0,o.kt)("p",null,"The last step in the process of loading all plugins is to set the blocking point."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"     public void loadAllPlugins() throws IOException {\n        // 1.Locating the plugin path\n        // ......\n        // 2.Loading Plugin Definitions\n        // ......\n        // 3.Set intercept points\n        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);\n    }\n")),(0,o.kt)("p",null,"Setting intercept points is to save the set of intercept points to the ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentTypeMatcher")," class. It implements the ",(0,o.kt)("inlineCode",{parentName:"p"},"ElementMatcher")," interface for custom matching logic. ",(0,o.kt)("inlineCode",{parentName:"p"},"ElementMatcher")," is also an interface in ",(0,o.kt)("inlineCode",{parentName:"p"},"bytebuddy"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"public final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase<TypeDefinition> {\n    private static final ShenyuAgentTypeMatcher SHENYU_AGENT_TYPE_MATCHER = new ShenyuAgentTypeMatcher();\n    private Map<String, ShenyuAgentJoinPoint> joinPointMap;\n    \n    private ShenyuAgentTypeMatcher() {\n    }\n\n    public static ShenyuAgentTypeMatcher getInstance() {\n        return SHENYU_AGENT_TYPE_MATCHER;\n    }\n \n    //Customize the matching logic, the target class is matched successfully when it is in the set of interceptor points\n    @Override\n    public boolean matches(final TypeDefinition target) {\n        return joinPointMap.containsKey(target.getTypeName());\n    }\n    \n    /**\n     * Set the set of interception points\n     */\n    public void setJoinPointMap(final Map<String, ShenyuAgentJoinPoint> joinPointMap) {\n        this.joinPointMap = joinPointMap;\n    }\n}\n")),(0,o.kt)("h3",{id:"4-create-agent"},"4. Create Agent"),(0,o.kt)("p",null,"The agent created by is used to change the behavior of the target class."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},' public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {\n        // 1. Read configuration file\n        // ......\n        // 2. Load all plugins\n        // ......\n        // 3. Create Agent\n        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED)) // Create Agent with ByteBuddy and turn on type-checking\n                .ignore(ElementMatchers.isSynthetic()) // Ignore synthetic\n                .or(ElementMatchers.nameStartsWith("org.apache.shenyu.agent.")); // Ignore the class org.apache.shenyu.agent\n        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())//Matching load type, the matcher is ShenyuAgentTypeMatcher\n                .transform(new ShenyuAgentTransformer()) // If the match is successful, change its behavior through ShenyuAgentTransformer\n                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION) //Specifying redefinition policies\n                .with(new TransformListener()) /Specify a listener to listen for events during runtime\n                .installOn(instrumentation); // Apply the changes to the Instrumentation\n        // 4. Start Plugin\n        // ......\n    }\n')),(0,o.kt)("p",null,"In the process of creating an agent, two points need to be noted."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Whether the match is successful or not, determined by ",(0,o.kt)("inlineCode",{parentName:"li"},"ShenyuAgentTypeMatcher"),"."),(0,o.kt)("li",{parentName:"ul"},"the behavior of the successful match class, which is changed by ",(0,o.kt)("inlineCode",{parentName:"li"},"ShenyuAgentTransformer"),".")),(0,o.kt)("p",null,"Next we will focus on analyzing these two classes."),(0,o.kt)("h4",{id:"41-define-the-matching-logic"},"4.1 Define the matching logic"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTypeMatcher#matches()")),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentTypeMatcher")," uses the singleton design pattern, implements the ",(0,o.kt)("inlineCode",{parentName:"p"},"ElementMatcher")," interface and overrides the ",(0,o.kt)("inlineCode",{parentName:"p"},"matches()")," method."),(0,o.kt)("p",null,"The logic of whether the match is successful or not is: if the target class is in the ",(0,o.kt)("inlineCode",{parentName:"p"},"joinPointMap")," set of interceptor points, the match is successful."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"\npublic final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase<TypeDefinition> {\n    // ......\n    \n    private Map<String, ShenyuAgentJoinPoint> joinPointMap;\n\n    // Custom matching logic: if the target class is in the intercept point joinPointMap collection, the match is successful\n    @Override\n    public boolean matches(final TypeDefinition target) {\n        return joinPointMap.containsKey(target.getTypeName());\n    }\n    \n}\n")),(0,o.kt)("h4",{id:"42-changing-the-behavior-of-matching-classes"},"4.2 Changing the behavior of matching classes"),(0,o.kt)("p",null,"When loading the target class, if the match is successful, it will change its behavior through ",(0,o.kt)("inlineCode",{parentName:"p"},"ShenyuAgentTransformer"),", which implements the ",(0,o.kt)("inlineCode",{parentName:"p"},"Transformer")," interface and overrides the ",(0,o.kt)("inlineCode",{parentName:"p"},"transform()")," method, ",(0,o.kt)("inlineCode",{parentName:"p"},"Transformer")," is also an interface to ",(0,o.kt)("inlineCode",{parentName:"p"},"bytebuddy"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public final class ShenyuAgentTransformer implements Transformer {\n    //Define an additional field in the match class to pass contextual information\n    private static final String EXTRA_DATA = "_$EXTRA_DATA$_";\n    //Type Matcher    \n    private static final ShenyuAgentTypeMatcher MATCHER = ShenyuAgentTypeMatcher.getInstance();\n    \n    //Rewrite the transform method to redefine the behavior of the matching class\n    //Execute once during the load class\n    @Override\n    public Builder<?> transform(final Builder<?> builder, final TypeDescription typeDescription, final ClassLoader classLoader, final JavaModule module) {\n        //skip if not a matching class\n        if (!MATCHER.containsType(typeDescription)) {\n            return builder;\n        }\n        //add a new field for the class\n        Builder<?> result = builder.defineField(EXTRA_DATA, Object.class, Opcodes.ACC_PRIVATE | Opcodes.ACC_VOLATILE).implement(TargetObject.class).intercept(FieldAccessor.ofField(EXTRA_DATA));\n        // get join point\n        ShenyuAgentJoinPoint joinPoint = MATCHER.loadShenyuAgentJoinPoint(typeDescription);\n        //interceptor constructor point\n        result = interceptorConstructorPoint(typeDescription, joinPoint.getConstructorPoints(), result);\n        //interceptor static method point\n        result = interceptorStaticMethodPoint(typeDescription, joinPoint.getStaticMethodPoints(), result);\n        //interceptor instance method Point\n        result = interceptorInstanceMethodPoint(typeDescription, joinPoint.getInstanceMethodPoints(), result);\n        return result;\n    }\n\n    // ......\n}\n')),(0,o.kt)("p",null,"In the ",(0,o.kt)("inlineCode",{parentName:"p"},"transform()")," method, the behavior of the match class is redefined."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"New field, a subclass of ",(0,o.kt)("inlineCode",{parentName:"li"},"TargetObject"),", for passing the context."),(0,o.kt)("li",{parentName:"ul"},"Whether to intercept constructors, depending on the specified configuration."),(0,o.kt)("li",{parentName:"ul"},"Whether to intercept static methods, according to the specified configuration."),(0,o.kt)("li",{parentName:"ul"},"intercepting instance methods, according to the specified configuration.")),(0,o.kt)("h5",{id:"423-interceptor-instance-method-point"},"4.2.3 Interceptor Instance Method Point"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTransformer#interceptorInstanceMethodPoint()")),(0,o.kt)("p",null,"Constructs an instance method intercept point based on a cutscene to get a ",(0,o.kt)("inlineCode",{parentName:"p"},"Builder")," object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"    private Builder<?> interceptorInstanceMethodPoint(final TypeDescription description, final Collection<InstanceMethodPointCut> pointCuts, final Builder<?> builder) {\n        Collection<ShenyuAgentTransformerPoint<?>> points = description.getDeclaredMethods().stream()\n                .filter(each -> !(each.isAbstract() || each.isSynthetic())) //Filtering abstract methods, synthetic methods\n                .map(each -> buildInstanceMethodTransformationPoint(pointCuts, each)) //Constructing example method intercept points\n                .filter(Objects::nonNull)\n                .collect(Collectors.toList());\n        return getBuilder(description, builder, points); //get Builder\n    }\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTransformer#buildInstanceMethodTransformationPoint()")),(0,o.kt)("p",null,"Filter the matched methods, get the corresponding ",(0,o.kt)("inlineCode",{parentName:"p"},"handler")," handler for the method, and finally create an instance method interception point object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"    private ShenyuAgentTransformerPoint<?> buildInstanceMethodTransformationPoint(final Collection<InstanceMethodPointCut> pointCuts, final InDefinedShape methodDescription) {\n        List<InstanceMethodPointCut> points = pointCuts.stream().filter(point -> point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //Filter the methods that can match on\n        if (points.isEmpty()) {\n            return null;\n        }\n        List<InstanceMethodHandler> handlers = points.stream()\n                .flatMap(pointCut -> pointCut.getHandlers().stream())\n                .map(handler -> (InstanceMethodHandler) MATCHER.getOrCreateInstance(handler)) //Get the corresponding handler processor\n                .filter(Objects::nonNull)\n                .collect(Collectors.toList());\n        return new ShenyuAgentTransformerPoint<>(methodDescription, new InstanceMethodInterceptor(handlers));//Create instance method interceptor object, create instance method interceptor\n    }\n")),(0,o.kt)("p",null,"Whether the method matches successfully: whether the current method name is the method name configured in the ",(0,o.kt)("inlineCode",{parentName:"p"},"tracing-point.yaml")," file."),(0,o.kt)("p",null,(0,o.kt)("inlineCode",{parentName:"p"},"handler")," fetching: is based on the fully qualified name configured in the ",(0,o.kt)("inlineCode",{parentName:"p"},"tracing-point.yaml")," file to load the corresponding class."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"InstanceMethodInterceptor#intercept()")),(0,o.kt)("p",null,"The instance method interceptor ",(0,o.kt)("inlineCode",{parentName:"p"},"InstanceMethodInterceptor")," dynamically handles intercept methods during runtime."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'public class InstanceMethodInterceptor {\n    // ......\n    /**\n     * Intercept of target objects.\n     *\n     * @param target \n     * @param method \n     * @param args \n     * @param callable \n     * @return \n     * @throws \n     */\n    @RuntimeType //Define the runtime target method\n    public Object intercept(@This final Object target, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable<?> callable) throws Exception {\n        //Target method implementation results\n        Object result = null;\n        //Target Object\n        TargetObject instance = (TargetObject) target;\n        //instance method handler\n        for (InstanceMethodHandler handler : handlerList) {\n            MethodResult methodResult = new MethodResult();\n            // Pre-processing logic\n            try {\n                handler.before(instance, method, args, methodResult);\n            } catch (final Throwable ex) {\n                LOG.error("Failed to execute the before method of method {} in class {}", method.getName(), target.getClass(), ex);\n            }\n            //Calling the target method\n            try {\n                result = callable.call();\n            } catch (final Throwable ex) {\n               //Handling exception\n                try {\n                    handler.onThrowing(instance, method, args, ex);\n                } catch (final Throwable ignored) {\n                    LOG.error("Failed to execute the error handler of method {} in class {}", method.getName(), target.getClass(), ex);\n                    throw ex;\n                }\n            } finally {\n                //Post-processing logic\n                try {\n                    result = handler.after(instance, method, args, methodResult, result);\n                } catch (final Throwable ex) {\n                    LOG.error("Failed to execute the after method of method {} in class {}", method.getName(), target.getClass(), ex);\n                }\n            }\n        }\n        //Returns the result of the target method call\n        return result;\n    }\n}\n\n')),(0,o.kt)("p",null,"The instance method interceptor adds pre-processing logic, post-processing logic, and exception handling logic before the target method is called."),(0,o.kt)("p",null,"Several annotations of ",(0,o.kt)("inlineCode",{parentName:"p"},"Byte Buddy")," are used here."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"@RuntimeType"),": defines the target method at runtime, prompting ",(0,o.kt)("inlineCode",{parentName:"li"},"ByteBuddy")," to disable strict type checking."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"@This"),": the current intercepted, dynamically generated instance object."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"@Origin"),": the original method."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"@AllArguments"),": get all incoming parameters."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"@SuperCall"),": used to call the parent class version of the method.")),(0,o.kt)("p",null,"Instance method handler ",(0,o.kt)("inlineCode",{parentName:"p"},"InstanceMethodHandler")," only defines three interfaces, and the specific implementation logic is handled by the specific plugin."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"public interface InstanceMethodHandler {\n     // Pre-processing logic\n    default void before(final TargetObject target, final Method method, final Object[] args, final MethodResult result) {\n    }\n    \n    // Post-processing logic\n    default Object after(final TargetObject target, final Method method, final Object[] args, final MethodResult methodResult, final Object result) {\n        return result;\n    }\n   \n    // Exception handling logic\n    default void onThrowing(final TargetObject target, final Method method, final Object[] args, final Throwable throwable) {\n    }\n}\n\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTransformer#getBuilder()")),(0,o.kt)("p",null,"When the ",(0,o.kt)("inlineCode",{parentName:"p"},"Builder")," of the ",(0,o.kt)("inlineCode",{parentName:"p"},"Agent")," is acquired, the corresponding interceptor is specified for the specified target method, new logic is added to the original method, and the behavior of the original method is changed."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'    \n    private static Builder<?> getBuilder(final TypeDescription description, final Builder<?> builder, final Collection<ShenyuAgentTransformerPoint<?>> points) {\n        final Builder<?>[] result = {builder};\n        points.forEach(point -> {\n            try {\n                result[0] = builder.method(ElementMatchers.is(point.getDescription()))//Specify the target method\n                        .intercept(MethodDelegation.withDefaultConfiguration().to(point.getInterceptor()));//Specifying Interceptor\n                // CHECKSTYLE:OFF\n            } catch (final Throwable ex) {\n                // CHECKSTYLE:ON\n                LOG.error("Failed to load handler class: {}", description.getTypeName(), ex);\n            }\n        });\n        return result[0];\n    }\n')),(0,o.kt)("p",null,"With the above processing logic, it is possible to intercept the instance method without intrusion."),(0,o.kt)("p",null,"The processing logic of the intercept method ",(0,o.kt)("inlineCode",{parentName:"p"},"intercept()")," is"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Processing each ",(0,o.kt)("inlineCode",{parentName:"li"},"handler")," in turn."),(0,o.kt)("li",{parentName:"ul"},"Calling the predecessor method of ",(0,o.kt)("inlineCode",{parentName:"li"},"handler"),"."),(0,o.kt)("li",{parentName:"ul"},"Calling the target method."),(0,o.kt)("li",{parentName:"ul"},"calling the exception handling method of ",(0,o.kt)("inlineCode",{parentName:"li"},"handler")," if the target method has an exception."),(0,o.kt)("li",{parentName:"ul"},"Calling the post method of ",(0,o.kt)("inlineCode",{parentName:"li"},"handler"),".")),(0,o.kt)("p",null,"Next, look at intercepting static methods."),(0,o.kt)("h5",{id:"423-interceptor-static-method-point"},"4.2.3 Interceptor Static Method Point"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTransformer#interceptorStaticMethodPoint()")),(0,o.kt)("p",null,"Filter out static methods, then build static method intercept points for static methods."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"    private Builder<?> interceptorStaticMethodPoint(final TypeDescription description, final Collection<StaticMethodPointCut> pointCuts, final Builder<?> builder) {\n        Collection<ShenyuAgentTransformerPoint<?>> points = description.getDeclaredMethods().stream()\n                .filter(each -> each.isStatic() && !(each.isAbstract() || each.isSynthetic())) // The current method is a static method, not an abstract method, not a synthetic method\n                .map(methodDescription -> buildStaticMethodTransformationPoint(pointCuts, methodDescription)) // Building static method intercept points\n                .filter(Objects::nonNull)\n                .collect(Collectors.toList());\n        return getBuilder(description, builder, points);\n    }\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTransformer#buildStaticMethodTransformationPoint()")),(0,o.kt)("p",null,"Filter according to the configuration file to determine whether the current static method needs to be intercepted. Then get the corresponding handler and finally build the static method interceptor object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"    private ShenyuAgentTransformerPoint<?> buildStaticMethodTransformationPoint(final Collection<StaticMethodPointCut> pointCuts, final InDefinedShape methodDescription) {\n        List<StaticMethodPointCut> staticMethodPoints = pointCuts.stream().filter(point -> point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //Filter based on the configuration file to determine if the current static method needs to be intercepted\n        if (staticMethodPoints.isEmpty()) { // If there is no configuration, it returns directly\n            return null;\n        }\n        List<StaticMethodHandler> handlers = staticMethodPoints.stream()\n                .flatMap(pointCut -> pointCut.getHandlers().stream())\n                .map(handler -> (StaticMethodHandler) MATCHER.getOrCreateInstance(handler)) //Get the corresponding processor\n                .filter(Objects::nonNull)\n                .collect(Collectors.toList());\n        return new ShenyuAgentTransformerPoint<>(methodDescription, new StaticMethodInterceptor(handlers)); //Constructing static method interceptor objects\n    }\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"StaticMethodInterceptor#intercept()")),(0,o.kt)("p",null,"At runtime, the target method is intercepted and the processing logic of the interceptor is executed ."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\npublic class StaticMethodInterceptor {\n   //......  \n    \n    /**\n     * Intercept of target methods.\n     */\n    @RuntimeType\n    public Object intercept(@Origin final Class<?> klass, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable<?> callable) throws Exception {\n        Object result = null;\n        // handler\n        for (StaticMethodHandler handler : handlerList) {\n            MethodResult methodResult = new MethodResult();\n            try {\n                //Pre-processing method\n                handler.before(klass, method, args, new MethodResult());\n            } catch (final Throwable ex) {\n                LOG.error("Failed to execute the before method of method {} in class {}", method.getName(), klass, ex);\n            }\n            try {\n                // Calling the current method\n                result = callable.call();\n            } catch (final Throwable ex) {\n                try {\n                    //Exception logic handling\n                    handler.onThrowing(klass, method, args, ex);\n                } catch (final Throwable ignored) {\n                    LOG.error("Failed to execute the error handler of method {} in class {}", method.getName(), klass, ex);\n                    throw ex;\n                }\n            } finally {\n                try {\n                    // Post-processing method\n                    handler.after(klass, method, args, methodResult);\n                } catch (final Throwable ex) {\n                    LOG.error("Failed to execute the after method of method {} in class {}", method.getName(), klass, ex);\n                }\n            }\n        }\n        //return resullt\n        return result;\n    }\n}\n\n')),(0,o.kt)("p",null,"The processing logic of the intercept method ",(0,o.kt)("inlineCode",{parentName:"p"},"intercept()")," is"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"Process each ",(0,o.kt)("inlineCode",{parentName:"li"},"handler")," in turn."),(0,o.kt)("li",{parentName:"ul"},"Calling the predecessor method of ",(0,o.kt)("inlineCode",{parentName:"li"},"handler"),"."),(0,o.kt)("li",{parentName:"ul"},"Calling the target method."),(0,o.kt)("li",{parentName:"ul"},"calling the exception handling method of ",(0,o.kt)("inlineCode",{parentName:"li"},"handler")," if the target method has an exception."),(0,o.kt)("li",{parentName:"ul"},"call the post method of ",(0,o.kt)("inlineCode",{parentName:"li"},"handler"),".")),(0,o.kt)("p",null,"Finally, let's look at how to intercept constructors."),(0,o.kt)("h5",{id:"423-interceptor-constructor-point"},"4.2.3 Interceptor Constructor Point"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTransformer#interceptorConstructorPoint()")),(0,o.kt)("p",null,"Filter out constructors, then build interceptor points for constructors, and finally create ",(0,o.kt)("inlineCode",{parentName:"p"},"builder")," objects to add interceptors to constructor methods."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},' private Builder<?> interceptorConstructorPoint(final TypeDescription description, final Collection<ConstructorPointCut> constructorPoints, final Builder<?> builder) {\n        Collection<ShenyuAgentTransformerPoint<? extends ConstructorInterceptor>> constructorAdviceComposePoints = description.getDeclaredMethods().stream()\n                .filter(MethodDescription::isConstructor) //Filter out constructors\n                .map(each -> buildConstructorTransformerPoint(constructorPoints, each))//Interception points for constructing constructors\n                .filter(Objects::nonNull)\n                .collect(Collectors.toList());\n        final Builder<?>[] result = {builder};\n     // Create builder object, add interceptor to constructor method\n        constructorAdviceComposePoints.forEach(point -> {\n            try {\n                result[0] = builder.constructor(ElementMatchers.is(point.getDescription()))\n                        .intercept(SuperMethodCall.INSTANCE.andThen(MethodDelegation.withDefaultConfiguration()\n                                .to(point.getInterceptor())));//Call the parent class constructor first, then add the interceptor\n                // CHECKSTYLE:OFF\n            } catch (final Throwable ex) {\n                // CHECKSTYLE:ON\n                LOG.error("Failed to load handler class: {}", description.getTypeName(), ex);\n            }\n        });\n        return result[0];\n    }\n')),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ShenyuAgentTransformer#buildConstructorTransformerPoint()")),(0,o.kt)("p",null,"First get the constructor interceptor point, then create the ",(0,o.kt)("inlineCode",{parentName:"p"},"handler")," instance object for the interceptor point, and finally create the constructor interceptor object."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},"private ShenyuAgentTransformerPoint<? extends ConstructorInterceptor> buildConstructorTransformerPoint(\n            final Collection<ConstructorPointCut> constructorPoints, final InDefinedShape methodDescription) {\n    //Get constructor intercept points\n        List<ConstructorPointCut> constructorPointCutList = constructorPoints.stream().filter(each -> each.getMatcher().matches(methodDescription)).collect(Collectors.toList());\n        if (constructorPointCutList.isEmpty()) {\n            return null;\n        }\n        List<ConstructorHandler> handlers = constructorPointCutList.stream()\n                .flatMap(pointCut -> pointCut.getHandlers().stream())\n                .map(handler -> (ConstructorHandler) MATCHER.getOrCreateInstance(handler)) //Create the handler instance object of the interception point\n                .filter(Objects::nonNull)\n                .collect(Collectors.toList());\n        return new ShenyuAgentTransformerPoint<>(methodDescription, new ConstructorInterceptor(handlers));//Creating Constructor Interceptors\n    }\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"ConstructorInterceptor#intercept()")),(0,o.kt)("p",null,"Constructor interceptor: executes the processing logic for each ",(0,o.kt)("inlineCode",{parentName:"p"},"handler")," before calling the constructor of the target method."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\npublic class ConstructorInterceptor {\n    //......\n    \n    /**\n     * Interception methods.\n     */\n    @RuntimeType\n    public void intercept(@This final TargetObject target, @AllArguments final Object[] args) {\n        for (ConstructorHandler handler : handlerList) {\n            try {\n                // handler processing logic\n                handler.onConstructor(target, args);\n            } catch (final Throwable throwable) {\n                LOG.error("Constructor advice execution error. class: {}", target.getClass().getTypeName(), throwable);\n            }\n        }\n    }\n}\n\n')),(0,o.kt)("p",null,"At this point, we have finished analyzing the entire process of creating ",(0,o.kt)("inlineCode",{parentName:"p"},"agent"),"."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"defining the matching logic ",(0,o.kt)("inlineCode",{parentName:"li"},"ShenyuAgentTypeMatcher")," according to the configuration file."),(0,o.kt)("li",{parentName:"ul"},"defining the ",(0,o.kt)("inlineCode",{parentName:"li"},"ShenyuAgentTransformer")," object, which changes the behavior of the matching class."),(0,o.kt)("li",{parentName:"ul"},"intercepting instance object methods through ",(0,o.kt)("inlineCode",{parentName:"li"},"InstanceMethodInterceptor"),"."),(0,o.kt)("li",{parentName:"ul"},"intercepting static methods via ",(0,o.kt)("inlineCode",{parentName:"li"},"StaticMethodInterceptor"),"."),(0,o.kt)("li",{parentName:"ul"},"Intercepting constructors via ",(0,o.kt)("inlineCode",{parentName:"li"},"ConstructorInterceptor"),".")),(0,o.kt)("p",null,"The processing logic of each ",(0,o.kt)("inlineCode",{parentName:"p"},"handler")," is not mentioned here because the implementation logic of the ",(0,o.kt)("inlineCode",{parentName:"p"},"handler")," is customized by each plug-in. For example, the implementation classes of the current instance method interceptor ",(0,o.kt)("inlineCode",{parentName:"p"},"InstanceMethodHandler")," are ",(0,o.kt)("inlineCode",{parentName:"p"},"jaeger"),", ",(0,o.kt)("inlineCode",{parentName:"p"},"opentelemetry")," and ",(0,o.kt)("inlineCode",{parentName:"p"},"zipkin"),"."),(0,o.kt)("p",null,(0,o.kt)("img",{src:n(71973).Z})),(0,o.kt)("h3",{id:"5-start-plugin"},"5. Start Plugin"),(0,o.kt)("p",null,"After creating the ",(0,o.kt)("inlineCode",{parentName:"p"},"agent"),", start each plugin."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"}," public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {\n        // 1. Read configuration file\n        // ......\n        // 2. Load all plugins\n        // ......\n        // 3. Create agent\n       \n        // 4. Start Plugin\n        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();\n        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());\n        //Add hook function for closing the plugin\n        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));\n    }\n")),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"PluginLifecycleManager")),(0,o.kt)("p",null,"The ",(0,o.kt)("inlineCode",{parentName:"p"},"PluginLifecycleManager")," is responsible for the plugin lifecycle management, which is used to start the plugin and close it."),(0,o.kt)("p",null,"The startup of the plugin has to be specified in the configuration file."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-java"},'\npublic class PluginLifecycleManager {\n   //......      \n    /**\n     * Start Plugin.\n     */\n    public void startup(final Map<String, AgentPluginConfig> configMap) {\n        //Get the names of supported plugins from the configuration file\n        Set<String> support = ShenyuAgentConfigUtils.getSupports();\n        configMap.entrySet().stream()\n                .filter(entry -> support.contains(entry.getKey())) //Included in the configuration file\n                .forEach(entry -> Optional.ofNullable(SPILoader.load(AgentPluginBootService.class, entry.getKey())) //Loading plugin starter classes by SPI\n                        .ifPresent(bootService -> {\n                            try {\n                                LOG.info("start shenyu plugin: {}", entry.getKey());\n                                bootService.start(entry.getValue());  // Start the plugin: executing the specific launch logic of the plugin\n                            } catch (final Throwable ex) {\n                                LOG.error("Failed to start shenyu plugin", ex);\n                            }\n                        }));\n    }\n    \n    /**\n     * close\n     */\n    public void close() {\n        //Loading plugin starter classes by SPI\n        SPILoader.loadList(AgentPluginBootService.class).forEach(each -> {\n            try {\n                each.close(); // Close the plugin: execute the specific closing logic of the plugin\n            } catch (final Throwable ex) {\n                LOG.error("Failed to close shenyu agent plugin", ex);\n            }\n        });\n    }\n}\n')),(0,o.kt)("p",null,"Plugins are also started and closed with each plugin specifically to be implemented, and then loaded by ",(0,o.kt)("inlineCode",{parentName:"p"},"SPI"),"."),(0,o.kt)("h3",{id:"6-summary"},"6. Summary"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"the ",(0,o.kt)("inlineCode",{parentName:"li"},"shenyu-agent")," module is implemented mainly through the ",(0,o.kt)("inlineCode",{parentName:"li"},"Byte Buddy")," toolkit."),(0,o.kt)("li",{parentName:"ul"},"specifying the plugin information in the configuration file ",(0,o.kt)("inlineCode",{parentName:"li"},"shenyu-agent.yaml"),"."),(0,o.kt)("li",{parentName:"ul"},"the plugin loading process is done via ",(0,o.kt)("inlineCode",{parentName:"li"},"SPI"),"."),(0,o.kt)("li",{parentName:"ul"},"interception points are specified through the configuration file, with a flexible design."),(0,o.kt)("li",{parentName:"ul"},"Separate plugin interface definition and implementation, supporting multiple plugin types.")))}h.isMDXComponent=!0},25754:function(e,t,n){t.Z=n.p+"assets/images/agent-jar-ddf92b3d50f674dbb1a77f9636794437.png"},79678:function(e,t,n){t.Z=n.p+"assets/images/agent-plugin-definition-50a8aedfcfa2f611803acc40d646fe35.png"},71973:function(e,t,n){t.Z=n.p+"assets/images/instance_method_handler-309e74ac5f633743f57a9b60039f2486.png"}}]);