<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu (Incubating)" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed"><title data-react-helmet="true">ShenYu-Agent æºç åˆ†æ | Apache ShenYu (Incubating)</title><meta data-react-helmet="true" property="og:title" content="ShenYu-Agent æºç åˆ†æ | Apache ShenYu (Incubating)"><meta data-react-helmet="true" name="description" content="Apache ShenYu æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚"><meta data-react-helmet="true" property="og:description" content="Apache ShenYu æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ API ç½‘å…³ã€‚"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/Agent-SourceCode-Analysis"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="default"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/Agent-SourceCode-Analysis"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Agent-SourceCode-Analysis" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/Agent-SourceCode-Analysis" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/Agent-SourceCode-Analysis" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.c16418f4.css">
<link rel="preload" href="/zh/assets/js/runtime~main.138a9106.js" as="script">
<link rel="preload" href="/zh/assets/js/main.5c3e066b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/docs/index">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/subscribe-email">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/event/2.4.2-release">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/zh/docs/index">2.4.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/index">å½“å‰ç‰ˆæœ¬</a></li><li><a class="dropdown__link" href="/zh/docs/index">2.4.2</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.1/index">2.4.1</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.0/index">2.4.0</a></li><li><a class="dropdown__link" href="/zh/docs/2.3.0/index">2.3.0</a></li><li><a class="dropdown__link" href="/zh/versions">All versions</a></li></ul></div><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/Agent-SourceCode-Analysis" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/Agent-SourceCode-Analysis" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_SrOn thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_jISh margin-bottom--md">All Blog Posts</div><ul class="sidebarItemList_UfcF"><h4 class="categoryHeader_Xx2W">SPI</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-RateLimiter-SPI">RateLimiter SPI ä»£ç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalance SPI ä»£ç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy--åŸºäºSPIçš„ä»£ç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge-- åŸºäºSPIçš„è®¾è®¡å®ç°åˆ†æ</a></li><h4 class="categoryHeader_Xx2W">Start</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu å¯åŠ¨ç¤ºä¾‹</a></li><h4 class="categoryHeader_Xx2W">DataSync</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocketæ•°æ®åŒæ­¥æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeperæ•°æ®åŒæ­¥æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync">Nacosæ•°æ®åŒæ­¥æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Httpé•¿è½®è¯¢æ•°æ®åŒæ­¥æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-Etcd-Data-Sync">Etcdæ•°æ®åŒæ­¥æºç åˆ†æ</a></li><h4 class="categoryHeader_Xx2W">IntegrationTest</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/IntegrationTest-Analysis">é›†æˆæµ‹è¯•å‰–æ</a></li><h4 class="categoryHeader_Xx2W">Plugin</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Context-Pathæ’ä»¶æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin">Param-Mappingæ’ä»¶æºç åˆ†æ</a></li><h4 class="categoryHeader_Xx2W">RegisterCenter</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register">æ³¨å†Œä¸­å¿ƒå®ç°åŸç†ä¹‹Httpæ³¨å†Œ</a></li><h4 class="categoryHeader_Xx2W">Agent</h4><li class="sidebarItem_v502"><a aria-current="page" class="sidebarItemLink_yJnx sidebarItemLinkActive_Aygi" href="/zh/blog/Agent-SourceCode-Analysis">ShenYu-Agent æºç åˆ†æ</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="blogPostTitle_d4p0">ShenYu-Agent æºç åˆ†æ</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-03-17T06:40:52.662Z">2022å¹´3æœˆ17æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œ<code>Apache ShenYu</code> åˆ©ç”¨ <code>Java Agent</code> å’Œ <code>å­—èŠ‚ç å¢å¼º</code> æŠ€æœ¯å®ç°äº†æ— ç—•åŸ‹ç‚¹ï¼Œä½¿å¾—ç”¨æˆ·æ— éœ€å¼•å…¥ä¾èµ–å³å¯æ¥å…¥ç¬¬ä¸‰æ–¹å¯è§‚æµ‹æ€§ç³»ç»Ÿï¼Œè·å– <code>Traces</code>ã€<code>Metrics</code> å’Œ <code>Logging</code> ã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.2</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/docs/user-guide/observability/observability/" target="_blank" rel="noopener noreferrer">å¯è§‚æµ‹æ€§</a> ã€‚</p></blockquote><p>å…·ä½“è€Œè¨€ï¼Œå°±æ˜¯<code>shenyu-agent</code>æ¨¡å—ï¼Œå®ƒåŸºäº <code>Java Agent</code> æœºåˆ¶ï¼Œé€šè¿‡<code>ByteBuddy</code>å­—èŠ‚ç å¢å¼ºåº“ï¼Œåœ¨ç±»åŠ è½½æ—¶å¢å¼ºå¯¹è±¡ï¼Œå±äºé™æ€ä»£ç†ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="aopæœ¯è¯­"></a>AOPæœ¯è¯­<a class="hash-link" href="#aopæœ¯è¯­" title="Direct link to heading">#</a></h3><p>åœ¨åˆ†ææºç ä¹‹å‰ï¼Œä»‹ç»ä¸‹<code>AOP</code>ç›¸å…³çš„æœ¯è¯­ï¼Œä¾¿äºåç»­çš„ç†è§£ï¼š</p><ul><li><code>JoinPoint</code>ï¼šè¿æ¥ç‚¹ï¼Œç¨‹åºè¿è¡Œä¸­çš„æ—¶é—´ç‚¹ï¼Œæ¯”å¦‚æ–¹æ³•çš„æ‰§è¡Œç‚¹ï¼›</li><li><code>PointCut</code>ï¼šåˆ‡å…¥ç‚¹ï¼ŒåŒ¹é… <code>JoinPoint</code> çš„æ¡ä»¶ï¼›</li><li><code>Advice</code>ï¼šé€šçŸ¥ï¼Œå…·ä½“çš„æ‰§è¡Œé€»è¾‘ï¼›</li><li><code>Target</code>ï¼šç›®æ ‡å¯¹è±¡ï¼›</li><li><code>Proxy</code>ï¼šä»£ç†å¯¹è±¡ã€‚</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å…³äºbyte-buddy"></a>å…³äºByte Buddy<a class="hash-link" href="#å…³äºbyte-buddy" title="Direct link to heading">#</a></h3><p><code>Byte Buddy</code>æ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå’Œæ“ä½œåº“ï¼Œåœ¨<code>Java</code>åº”ç”¨ç¨‹åºçš„è¿è¡ŒæœŸé—´åˆ›å»ºå’Œä¿®æ”¹<code>Java</code>ç±»ã€‚å¯ä»¥åˆ©ç”¨å®ƒåˆ›å»ºä»»ä½•ç±»ï¼Œä¸åƒ<code>JDK</code>åŠ¨æ€ä»£ç†é‚£æ ·å¼ºåˆ¶å®ç°ä¸€ä¸ªæ¥å£ã€‚æ­¤å¤–ï¼Œ<code>Byte Buddy</code>æä¾›äº†æ–¹ä¾¿çš„APIï¼Œç”¨äºæ‰‹åŠ¨ã€ä½¿ç”¨<code>Java</code>ä»£ç†æˆ–åœ¨æ„å»ºæœŸé—´æ”¹å˜ç±»ã€‚</p><ul><li>æä¾›äº†éå¸¸æ–¹ä¾¿çš„APIæ¥å£ï¼Œä¸å¼ºå¤§çš„ç±»ï¼Œæ–¹æ³•ç­‰åŒ¹é…åŠŸèƒ½ï¼›</li><li>å¼€ç®±å³ç”¨ï¼Œé›¶å­¦ä¹ æˆæœ¬ï¼Œå±è”½äº†åº•å±‚æ“ä½œå­—èŠ‚ç æŠ€æœ¯ï¼›</li><li>å¼ºå¤§çš„å¼€æ”¾å®šåˆ¶æ€§åŠŸèƒ½ï¼Œå¯ä»¥ä¸ºä»»ä½•å®ç°çš„æ–¹æ³•è‡ªå®šä¹‰å­—èŠ‚ç ï¼›</li><li>æœ€å°‘è¿è¡Œæ—¶ç”Ÿæˆä»£ç åŸåˆ™ï¼Œæ€§èƒ½é«˜æ•ˆï¼›</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1--premainå…¥å£"></a>1.  premainå…¥å£<a class="hash-link" href="#1--premainå…¥å£" title="Direct link to heading">#</a></h3><p><code>premain()å‡½æ•°</code>æ˜¯<code>javaagent</code> çš„å…¥å£å‡½æ•°ï¼Œåœ¨ <code>ShenYu</code>ç”± <code>ShenyuAgentBootstrap</code> æä¾›å¹¶å®ç°æ•´ä¸ª<code>agent</code>çš„é€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * agent å¯åŠ¨å…¥å£ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ShenyuAgentBootstrap {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¥å£å‡½æ•° premain.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. è¯»å–é…ç½®æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentConfigUtils.setConfig(ShenyuAgentConfigLoader.load());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. åŠ è½½æ‰€æœ‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentPluginLoader.getInstance().loadAllPlugins();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. åˆ›å»º agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ignore(ElementMatchers.isSynthetic())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .or(ElementMatchers.nameStartsWith(&quot;org.apache.shenyu.agent.&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .transform(new ShenyuAgentTransformer())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(new TransformListener()).installOn(instrumentation);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. å¯åŠ¨æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>premainå‡½æ•°</code>çš„æ ¸å¿ƒé€»è¾‘ï¼Œå°±æ˜¯ä¸Šé¢çš„å››æ­¥æ“ä½œï¼š</p><ul><li><ol><li>è¯»å–é…ç½®æ–‡ä»¶ï¼›</li></ol></li><li><ol start="2"><li>åŠ è½½æ‰€æœ‰æ’ä»¶ï¼›</li></ol></li><li><ol start="3"><li>åˆ›å»º agentï¼›</li></ol></li><li><ol start="4"><li>å¯åŠ¨æ’ä»¶ã€‚</li></ol></li></ul><p>æ¥ä¸‹æ¥çš„æºç åˆ†æå°±ä¾æ¬¡åˆ†æè¿™å››ä¸ªæ“ä½œã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-è¯»å–é…ç½®æ–‡ä»¶"></a>2. è¯»å–é…ç½®æ–‡ä»¶<a class="hash-link" href="#2-è¯»å–é…ç½®æ–‡ä»¶" title="Direct link to heading">#</a></h3><ul><li>ShenyuAgentConfigLoader#load()</li></ul><p>é…ç½®æ–‡ä»¶çš„å¤„ç†ç”± <code>ShenyuAgentConfigLoader</code> å®Œæˆï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentConfigLoader {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é…ç½®æ–‡ä»¶è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String CONFIG_PATH = &quot;config-path&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åŠ è½½é…ç½®æ–‡ä»¶.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentConfig load() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯»å–é…ç½®æ–‡ä»¶è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String configPath = System.getProperty(CONFIG_PATH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°±è¯»å–é»˜è®¤çš„æ–‡ä»¶ shenyu-agent.yaml</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        File configFile = StringUtils.isEmpty(configPath) ? ShenyuAgentLocator.locatorConf(&quot;shenyu-agent.yaml&quot;) : new File(configPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¯»å–é…ç½®æ–‡ä»¶å¹¶è§£æ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuYamlEngine.agentConfig(configFile);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯ä»¥é€šè¿‡<code>config-path</code>æŒ‡å®šé…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œå°±è¯»å–é»˜è®¤çš„é…ç½®æ–‡ä»¶ <code>shenyu-agent.yaml</code>ï¼Œç„¶åé€šè¿‡<code>ShenyuYamlEngine</code>æ¥è§£æé…ç½®æ–‡ä»¶ã€‚</p><p>é…ç½®æ–‡ä»¶çš„æ ¼å¼æ˜¯<code>yaml</code>æ ¼å¼ï¼Œå¦‚ä½•é…ç½®ï¼Œè¯·å‚è€ƒå®˜ç½‘çš„ä»‹ç»  <a href="https://shenyu.apache.org/docs/user-guide/observability/observability/" target="_blank" rel="noopener noreferrer">å¯è§‚æµ‹æ€§</a> ã€‚</p><p>é»˜è®¤é…ç½®æ–‡ä»¶<code>shenyu-agent.yaml</code>çš„æ ¼å¼å†…å®¹å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI ya"><pre tabindex="0" class="prism-code language-ya codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">appName: shenyu-agent  # æŒ‡å®šä¸€ä¸ªåç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">supports:  # å½“å‰æ”¯æŒå“ªäº›åŠŸèƒ½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tracing: # é“¾è·¯è¿½è¸ªçš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">#    - jaeger   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">#    - opentelemetry</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     - zipkin</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  metrics:  # ç»Ÿè®¡åº¦é‡æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    - </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  logging:  # æ—¥å¿—ä¿¡æ¯æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    - </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">plugins:  # æ¯ä¸ªæ’ä»¶çš„å…·ä½“é…ç½®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  tracing:   # é“¾è·¯è¿½è¸ªçš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    jaeger:  # jaegerçš„ç›¸å…³é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 5775</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SERVICE_NAME: &quot;shenyu-agent&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JAEGER_SAMPLER_TYPE: &quot;const&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JAEGER_SAMPLER_PARAM: &quot;1&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    opentelemetry:  # opentelemetryçš„ç›¸å…³é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel.traces.exporter: jaeger #zipkin #otlp</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel.resource.attributes: &quot;service.name=shenyu-agent&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        otel.exporter.jaeger.endpoint: &quot;http://localhost:14250/api/traces&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    zipkin: # zipkinçš„ç›¸å…³é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 9411</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SERVICE_NAME: &quot;shenyu-agent&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL_VERSION: &quot;/api/v2/spans&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SAMPLER_TYPE: &quot;const&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SAMPLER_PARAM: &quot;1&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  metrics:   # ç»Ÿè®¡åº¦é‡æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    prometheus: # prometheusçš„ç›¸å…³é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 8081</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  logging:   # æ—¥å¿—ä¿¡æ¯æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    elasticSearch: # esçš„ç›¸å…³é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 8082</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    kafka:   # kafkaçš„ç›¸å…³é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      host: &quot;localhost&quot;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      port: 8082</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      props:</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>éœ€è¦å¼€å¯å“ªä¸ªæ’ä»¶ï¼Œå°±åœ¨<code>supports</code>ä¸­æŒ‡å®šï¼Œç„¶åå†<code>plugins</code>æŒ‡å®šæ’ä»¶çš„é…ç½®ä¿¡æ¯ã€‚</p><blockquote><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œ<code>Apache ShenYu</code> å‘å¸ƒçš„æœ€æ–°ç‰ˆæœ¬æ˜¯<code>2.4.2</code> ç‰ˆæœ¬ï¼Œå¯ä»¥æ”¯æŒ<code>tracing</code>çš„æ’ä»¶æœ‰<code>jaeger</code>ã€<code>opentelemetry</code>å’Œ<code>zipkin</code>ï¼Œ<code>metrics</code>å’Œ<code>logging</code>å°†åœ¨åç»­çš„ç‰ˆæœ¬ä¸­é™†ç»­å‘å¸ƒã€‚</p></blockquote><ul><li>ShenyuYamlEngine#agentConfig()</li></ul><p><code>ShenyuYamlEngine</code>æä¾›äº†å¦‚ä½•è‡ªå®šä¹‰åŠ è½½<code>yaml</code>æ ¼å¼çš„æ–‡ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentConfig agentConfig(final File yamlFile) throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // è¯»å–æ–‡ä»¶æµ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                FileInputStream fileInputStream = new FileInputStream(yamlFile);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                InputStreamReader inputStreamReader = new InputStreamReader(fileInputStream)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æŒ‡å®šå¯¹åº”çš„class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Constructor constructor = new Constructor(ShenyuAgentConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //æŒ‡å®šå±æ€§çš„class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            TypeDescription customTypeDescription = new TypeDescription(AgentPluginConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            customTypeDescription.addPropertyParameters(&quot;plugins&quot;, Map.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            constructor.addTypeDescription(customTypeDescription);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //é€šè¿‡Yamlå·¥å…·åŒ…è¯»å–yamlæ–‡ä»¶ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new Yaml(constructor, new Representer(DUMPER_OPTIONS)).loadAs(inputStreamReader, ShenyuAgentConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>ShenyuAgentConfig</code>æ˜¯æŒ‡å®šçš„Classç±»ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // appName æœåŠ¡åç§°ï¼Œé»˜è®¤æ˜¯ shenyu-agent </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String appName = &quot;shenyu-agent&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // supports æ”¯æŒå“ªäº›æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, List&lt;String&gt;&gt; supports = new LinkedHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // plugins æ’ä»¶çš„å±æ€§ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, Map&lt;String, AgentPluginConfig&gt;&gt; plugins = new LinkedHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>AgentPluginConfig</code>æ˜¯æŒ‡å®šæ’ä»¶çš„Classç±»ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class AgentPluginConfig {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æŒ‡å®šæ’ä»¶çš„ host</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String host;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // æŒ‡å®šæ’ä»¶çš„ port</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int port;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // æŒ‡å®šæ’ä»¶çš„ password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // æŒ‡å®šæ’ä»¶çš„ å…¶ä»–å±æ€§props </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Properties props;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯ä»¥æŒ‡å®šå¯ç”¨å“ªä¸ªæ’ä»¶ï¼ŒæŒ‡å®šæ’ä»¶çš„å±æ€§ä¿¡æ¯ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-åŠ è½½æ’ä»¶"></a>3. åŠ è½½æ’ä»¶<a class="hash-link" href="#3-åŠ è½½æ’ä»¶" title="Direct link to heading">#</a></h3><ul><li>ShenyuAgentPluginLoader#loadAllPlugins()</li></ul><p>è¯»å–é…ç½®æ–‡ä»¶åï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®ä¿¡æ¯ï¼ŒåŠ è½½æŒ‡å®šçš„æ’ä»¶ã€‚ç”±<code>ShenyuAgentPluginLoader</code>æ¥å®Œæˆã€‚</p><p><code>ShenyuAgentPluginLoader</code>æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œé‡‡ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œç»§æ‰¿ ClassLoader</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentPluginLoader extends ClassLoader implements Closeable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private static final ShenyuAgentPluginLoader AGENT_PLUGIN_LOADER = new ShenyuAgentPluginLoader();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentPluginLoader() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(ShenyuAgentPluginLoader.class.getClassLoader());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å…¬å¼€é™æ€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentPluginLoader getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return AGENT_PLUGIN_LOADER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åŠ è½½æ‰€æœ‰çš„æ’ä»¶.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void loadAllPlugins() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.å®šä½æ’ä»¶è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        File[] jarFiles = ShenyuAgentLocator.locatorPlugin().listFiles(file -&gt; file.getName().endsWith(&quot;.jar&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(jarFiles)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.åŠ è½½æ’ä»¶å®šä¹‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap = new HashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (File each : jarFiles) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                outputStream.reset();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                JarFile jar = new JarFile(each, true);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                jars.add(new PluginJar(jar, each));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        loadAgentPluginDefinition(pointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap = ImmutableMap.&lt;String, ShenyuAgentJoinPoint&gt;builder().putAll(pointMap).build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.è®¾ç½®æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-å®šä½æ’ä»¶è·¯å¾„"></a>3.1 å®šä½æ’ä»¶è·¯å¾„<a class="hash-link" href="#31-å®šä½æ’ä»¶è·¯å¾„" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentLocator#locatorPlugin()</li></ul><p>æ•´ä¸ª<code>shenyu</code>é¡¹ç›®ç»è¿‡<code>maven</code>æ‰“åŒ…åï¼ˆæ‰§è¡Œ<code>mvn clean install</code>å‘½ä»¤ï¼‰ï¼Œ<code>agent</code>æ‰“åŒ…ç›®å½•å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/agent-jar-ddf92b3d50f674dbb1a77f9636794437.png"></p><p>æ’ä»¶æ–‡ä»¶éƒ½æ˜¯<code>jar</code>åŒ…å½¢å¼å­˜åœ¨çš„ã€‚</p><ul><li><code>conf</code>ç›®å½•æ˜¯é…ç½®æ–‡ä»¶çš„ç›®å½•ä½ç½®ï¼›</li><li><code>plugins</code>ç›®å½•æ˜¯å„ä¸ªæ’ä»¶çš„ç›®å½•ä½ç½®ã€‚</li></ul><p>ç›¸åº”çš„å®šä½æ’ä»¶è·¯å¾„æºç å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// é»˜è®¤æ’ä»¶ä½äº   /plugins ç›®å½•ä¸‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static File locatorPlugin() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new File(String.join(&quot;&quot;, locatorAgent().getPath(), &quot;/plugins&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å®šä½shenyu-agent.jarçš„ç»å¯¹è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public static File locatorAgent() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰¾ ShenyuAgentLocator æ‰€åœ¨çš„ç±»è·¯å¾„ï¼ˆåŒ…åï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String classResourcePath = String.join(&quot;&quot;, ShenyuAgentLocator.class.getName().replaceAll(&quot;\\.&quot;, &quot;/&quot;), &quot;.class&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‰¾åˆ° ç±» çš„ç»å¯¹è·¯å¾„ï¼šç£ç›˜è·¯å¾„+ç±»è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        URL resource = ClassLoader.getSystemClassLoader().getResource(classResourcePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        assert resource != null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String url = resource.toString();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ˜¯å¦æ˜¯ä»¥jaråŒ…å½¢å¼å­˜åœ¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int existFileInJarIndex = url.indexOf(&#x27;!&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean isInJar = existFileInJarIndex &gt; -1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»jaråŒ…æ‰¾åˆ°è·¯å¾„ æˆ– ä»èµ„æºæ–‡ä»¶ä¸­æ‰¾è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return isInJar ? getFileInJar(url, existFileInJarIndex) : getFileInResource(url, classResourcePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ä»jaråŒ…æ‰¾åˆ°è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static File getFileInJar(final String url, final int fileInJarIndex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // jaråŒ…æ‰€åœ¨çš„ç»å¯¹è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String realUrl = url.substring(url.indexOf(&quot;file:&quot;), fileInJarIndex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä»¥ç»å¯¹è·¯å¾„åˆ›å»ºFileå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            File agentJarFile = new File(new URL(realUrl).toURI());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è·å–çˆ¶æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return agentJarFile.exists() ? agentJarFile.getParentFile() : null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (final MalformedURLException | URISyntaxException ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ‹¿åˆ°æ‰€æœ‰çš„æ’ä»¶æ–‡ä»¶åï¼Œä¼šå»åŠ è½½æ’ä»¶å®šä¹‰ï¼Œå³æ‹¦æˆªç‚¹ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-åŠ è½½æ‹¦æˆªç‚¹"></a>3.2 åŠ è½½æ‹¦æˆªç‚¹<a class="hash-link" href="#32-åŠ è½½æ‹¦æˆªç‚¹" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentPluginLoader#loadAgentPluginDefinition()</li></ul><p>æ‹¦æˆªç‚¹çš„é»˜è®¤é…ç½®æ˜¯åœ¨ <code>conf/tracing-point.yaml</code>æ–‡ä»¶ä¸­ï¼Œé…ç½®æ ¼å¼å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">pointCuts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">targetClass</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.apache.shenyu.plugin.global.GlobalPlugin  </span><span class="token comment" style="color:#999988;font-style:italic"># æ‹¦æˆªç›®æ ‡ç±»</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">points</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> instanceMethod </span><span class="token comment" style="color:#999988;font-style:italic"># æ‹¦æˆªç‚¹ç±»å‹</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> execute  </span><span class="token comment" style="color:#999988;font-style:italic"># æ‹¦æˆªç›®æ ‡æ–¹æ³•</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">handlers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># å¤„ç†å™¨</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">jaeger</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># ç”¨äºé“¾è·¯è¿½è¸ªçš„jaegeræ’ä»¶</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.jaeger.handler.JaegerGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">opentelemetry</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># ç”¨äºé“¾è·¯è¿½è¸ªçš„opentelemetryæ’ä»¶</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.opentelemetry.handler.OpenTelemetryGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">zipkin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ç”¨äºé“¾è·¯è¿½è¸ªçš„zipkinæ’ä»¶</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> org.apache.shenyu.agent.plugin.tracing.zipkin.handler.ZipkinGlobalPluginHandler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // </span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åŠ è½½æ‹¦æˆªç‚¹çš„æ–¹å¼æ˜¯é€šè¿‡<code>SPI</code>çš„æ–¹å¼è¿›è¡ŒåŠ è½½çš„ï¼Œç„¶åå†æ”¶é›†è¿™äº›æ‹¦æˆªç‚¹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private void loadAgentPluginDefinition(final Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginDefinition.class)  // SPI åŠ è½½æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(each -&gt; each.collector().forEach(def -&gt; {  // æ”¶é›†æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String classTarget = def.getClassTarget();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (pointMap.containsKey(classTarget)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); // æ„é€ å™¨ç±»å‹æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // å®ä¾‹æ–¹æ³•ç±»å‹æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // é™æ€æ–¹æ³•ç±»å‹æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pointMap.put(classTarget, def);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>SPILoader.loadList(AgentPluginDefinition.class)</li></ul><p><code>AgentPluginDefinition</code>æ˜¯æ‹¦æˆªç‚¹æ¥å£ï¼Œç”±<code>@SPI</code>æ ‡è®°ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@SPI // è¯¥æ¥å£é€šè¿‡SPIè¿›è¡ŒåŠ è½½</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ”¶é›†æ‹¦æˆªç‚¹ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Collection&lt;ShenyuAgentJoinPoint&gt; collector();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>TracingAgentPluginDefinition</code>æ˜¯å®ƒçš„ä¸€ä¸ªå®ç°ç±»ï¼Œç”¨äºå®šä¹‰é“¾è·¯è¿½è¸ªçš„æ‹¦æˆªç‚¹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join // SPIçš„å®ç°ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºæ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Collection&lt;JoinPointBuilder&gt; joinPointBuilder() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºæ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Collection&lt;JoinPointBuilder&gt; joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ”¶é›†æ‹¦æˆªç‚¹ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/agent-plugin-definition-50a8aedfcfa2f611803acc40d646fe35.png"></p><ul><li><p>AgentPluginDefinition#collector()</p><p><code>AgentPluginDefinition</code>åªæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†æ”¶é›†æ‹¦æˆªç‚¹çš„æ“ä½œæ–¹æ³•ï¼Œå…·ä½“å®ç°äº¤ç»™äº†å­ç±»ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public abstract class AbstractAgentPluginDefinition implements AgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å­ç±»å»å®ç°å¦‚ä½•åˆ›å»ºæ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected abstract Collection&lt;JoinPointBuilder&gt; joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ‹¦æˆªç‚¹æ„å»ºå™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;JoinPointBuilder&gt; joinPointBuilders = joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæ‹¦æˆªç‚¹å¯¹è±¡ ShenyuAgentJoinPoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> // åˆ›å»ºæ‹¦æˆªç‚¹å¯¹è±¡ ShenyuAgentJoinPoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public ShenyuAgentJoinPoint install() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å››ä¸ªæ„é€ å‚æ•°åˆ†åˆ«æ˜¯ï¼šç›®æ ‡å¯¹è±¡ï¼Œæ„é€ å™¨æ‹¦æˆªç‚¹ï¼Œå®ä¾‹æ–¹æ³•æ‹¦æˆªç‚¹ï¼Œé™æ€æ–¹æ³•æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ShenyuAgentJoinPoint(classTarget, constructorPoints, instanceMethodPoints, classStaticMethodPoints);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>TracingAgentPluginDefinition#joinPointBuilder()</p><p>åˆ›å»ºç”¨äºé“¾è·¯è¿½è¸ªçš„æ‹¦æˆªç‚¹ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Join</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class TracingAgentPluginDefinition extends AbstractAgentPluginDefinition {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºæ‹¦æˆªç‚¹    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected Collection&lt;JoinPointBuilder&gt; joinPointBuilder() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PointCutConfig config = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è¯»å–é»˜è®¤çš„æ‹¦æˆªç‚¹é…ç½®æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            config = ShenyuYamlEngine.unmarshal(ShenyuAgentLocator.locatorConf(&quot;tracing-point.yaml&quot;), PointCutConfig.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Exception loader tracing point config is&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæ‹¦æˆªç‚¹  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return JoinPointBuilderFactory.create(config);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>JoinPointBuilderFactory#create()</p><p>æ ¹æ®æŒ‡å®šçš„é…ç½®æ–‡ä»¶åˆ›å»ºæ‹¦æˆªç‚¹ ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public static Collection&lt;JoinPointBuilder&gt; create(final PointCutConfig config) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¦‚æœæ²¡æœ‰é…ç½®æ–‡ä»¶æˆ–ä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºé›†åˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (Objects.isNull(config) || config.getPointCuts().isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Collections.emptyList();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return config.getPointCuts().stream() // è·å–é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(pointCut -&gt; StringUtils.isNotEmpty(pointCut.getTargetClass())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        &amp;&amp; !pointCut.getPoints().isEmpty() &amp;&amp; !pointCut.getHandlers().isEmpty()) // æ‹¦æˆªç‚¹å¿…é¡»è¦æŒ‡å®šç›®æ ‡ç±»ï¼Œåˆ‡å…¥ç‚¹ï¼Œå¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(pointCut -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    JoinPointBuilder builder = ShenyuAgentJoinPoint.interceptClass(pointCut.getTargetClass()); // è®¾ç½®éœ€è¦æ‹¦æˆªçš„ç›®æ ‡ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Set&lt;String&gt; supports = ShenyuAgentConfigUtils.getSupports(); // è·å–å½“å‰æ”¯æŒå“ªäº›æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;String&gt; handlers = pointCut.getHandlers().entrySet().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(entry -&gt; supports.contains(entry.getKey())) // æŒ‡å®šçš„å¤„ç†å™¨å¿…é¡»æ˜¯å½“å‰å¯æ”¯æŒçš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .flatMap(entry -&gt; entry.getValue().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] instanceMethods = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.INSTANCE_METHOD.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName) // æ‹¦æˆªå®ä¾‹æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (instanceMethods.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.aroundInstanceMethod(ElementMatchers.namedOneOf(instanceMethods)).handlers(handlers).build(); // ä¸ºå®ä¾‹æ–¹æ³•æ·»åŠ åŒ¹é…å™¨ç”¨äºåç»­è¿è¡Œæ—¶åŠ¨æ€åŒ¹é…ï¼Œå¹¶æ·»åŠ å¯¹åº”çš„å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] staticMethods = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.STATIC_METHOD.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new); // æ‹¦æˆªé™æ€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (staticMethods.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.aroundStaticMethod(ElementMatchers.namedOneOf(staticMethods)).handlers(handlers).build();// ä¸ºé™æ€æ–¹æ³•æ·»åŠ åŒ¹é…å™¨ç”¨äºåç»­è¿è¡Œæ—¶åŠ¨æ€åŒ¹é…ï¼Œå¹¶æ·»åŠ å¯¹åº”çš„å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String[] constructorPoints = pointCut</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getPoints()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(point -&gt; PointType.CONSTRUCTOR.getName().equals(point.getType()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .map(Point::getName)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .toArray(String[]::new); // æ‹¦æˆªæ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (constructorPoints.length &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        builder.onConstructor(ElementMatchers.namedOneOf(constructorPoints)).handlers(handlers).build();// ä¸ºæ„é€ å™¨æ·»åŠ åŒ¹é…å™¨ç”¨äºåç»­è¿è¡Œæ—¶åŠ¨æ€åŒ¹é…ï¼Œå¹¶æ·»åŠ å¯¹åº”çš„å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    return builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }).collect(Collectors.toList()); // è¿”å›åŒ¹é…ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ›å»ºæ‹¦æˆªç‚¹çš„ä¸»è¦å®ç°é€»è¾‘æ˜¯ï¼šæ ¹æ®é…ç½®æ–‡ä»¶è¯»å–é…ç½®ä¿¡æ¯ï¼Œä¸ºæŒ‡å®šçš„ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•æ·»åŠ ç›¸åº”çš„å¤„ç†å™¨ã€‚å¤„ç†å™¨æœ‰ä¸‰ç§ï¼šå®ä¾‹æ–¹æ³•å¤„ç†å™¨ï¼Œé™æ€æ–¹æ³•å¤„ç†å™¨ï¼Œæ„é€ å‡½æ•°å¤„ç†å™¨ã€‚</p><p>è¿™é‡Œç”¨åˆ°äº†<code>ElementMatchers.namedOneOf()</code> æ–¹æ³•ï¼Œå®ƒè¡¨ç¤ºæ–¹æ³•åç§°åœ¨æŒ‡å®šçš„å‚æ•°ä¸­ï¼Œå°±å¯ä»¥åŒ¹é…ä¸Šè¿™ä¸ªæ–¹æ³•ã€‚<code>ElementMatchers</code>æ˜¯<code>bytebuddy</code>ä¸­çš„ä¸€ä¸ªç±»ï¼Œåœ¨<code>ShenYu</code>ä¸­ï¼Œ<code>agent</code>çš„åˆ›å»ºä¹Ÿé€šè¿‡<code>bytebuddy</code>å®Œæˆçš„ã€‚</p><p>åç»­å°†æ”¶é›†åˆ°çš„æ‹¦æˆªç‚¹åˆ›å»ºä¸ºæ‹¦æˆªç‚¹å¯¹è±¡<code>ShenyuAgentJoinPoint</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public final Collection&lt;ShenyuAgentJoinPoint&gt; collector() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;JoinPointBuilder&gt; joinPointBuilders = joinPointBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæ‹¦æˆªç‚¹å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointBuilders.stream().map(JoinPointBuilder::install).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ”¶é›†å®Œæ‹¦æˆªç‚¹ä¹‹åï¼Œç”¨<code>Map</code>ä¿å­˜äº†è¿™äº›æ‹¦æˆªç‚¹ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// pointMap: Keyå’ŒValueåˆ†åˆ«è¡¨ç¤ºç›®æ ‡ç±»ï¼Œæ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void loadAgentPluginDefinition(final Map&lt;String, ShenyuAgentJoinPoint&gt; pointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginDefinition.class)  // SPI åŠ è½½æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(each -&gt; each.collector().forEach(def -&gt; {  // æ”¶é›†æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String classTarget = def.getClassTarget();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    if (pointMap.containsKey(classTarget)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ShenyuAgentJoinPoint pluginInterceptorPoint = pointMap.get(classTarget);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getConstructorPoints().addAll(def.getConstructorPoints()); // æ„é€ å™¨ç±»å‹æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getInstanceMethodPoints().addAll(def.getInstanceMethodPoints()); // å®ä¾‹æ–¹æ³•ç±»å‹æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pluginInterceptorPoint.getStaticMethodPoints().addAll(def.getStaticMethodPoints()); // é™æ€æ–¹æ³•ç±»å‹æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        pointMap.put(classTarget, def); // å°†æ‹¦æˆªç‚¹ä¿¡æ¯ä¿å­˜åˆ°Mapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-è®¾ç½®æ‹¦æˆªç‚¹"></a>3.3 è®¾ç½®æ‹¦æˆªç‚¹<a class="hash-link" href="#33-è®¾ç½®æ‹¦æˆªç‚¹" title="Direct link to heading">#</a></h4><p>åœ¨åŠ è½½æ‰€æœ‰æ’ä»¶çš„è¿‡ç¨‹ä¸­æœ€åä¸€æ­¥æ˜¯è®¾ç½®æ‹¦æˆªç‚¹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     public void loadAllPlugins() throws IOException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.å®šä½æ’ä»¶è·¯å¾„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.åŠ è½½æ’ä»¶å®šä¹‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.è®¾ç½®æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentTypeMatcher.getInstance().setJoinPointMap(joinPointMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è®¾ç½®æ‹¦æˆªç‚¹å°±æ˜¯å°†æ‹¦æˆªç‚¹é›†åˆä¿å­˜åˆ°<code>ShenyuAgentTypeMatcher</code>ç±»ä¸­ã€‚å®ƒå®ç°äº†<code>ElementMatcher</code>æ¥å£ï¼Œç”¨äºè‡ªå®šä¹‰åŒ¹é…é€»è¾‘ã€‚<code>ElementMatcher</code>ä¹Ÿæ˜¯<code>bytebuddy</code>ä¸­çš„æ¥å£ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ä½¿ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase&lt;TypeDefinition&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åˆ›å»ºå®ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuAgentTypeMatcher SHENYU_AGENT_TYPE_MATCHER = new ShenyuAgentTypeMatcher();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ‹¦æˆªç‚¹é›†åˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTypeMatcher() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è·å–å•ä¾‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static ShenyuAgentTypeMatcher getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return SHENYU_AGENT_TYPE_MATCHER;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è‡ªå®šä¹‰åŒ¹é…é€»è¾‘ï¼Œç›®æ ‡ç±»åœ¨æ‹¦æˆªç‚¹é›†åˆä¸­å°±åŒ¹é…æˆåŠŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(final TypeDefinition target) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointMap.containsKey(target.getTypeName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è®¾ç½®æ‹¦æˆªç‚¹é›†åˆ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setJoinPointMap(final Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.joinPointMap = joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-åˆ›å»º-agent"></a>4. åˆ›å»º agent<a class="hash-link" href="#4-åˆ›å»º-agent" title="Direct link to heading">#</a></h3><p>é€šè¿‡åˆ›å»ºçš„agentï¼Œç”¨äºæ”¹å˜ç›®æ ‡ç±»çš„è¡Œä¸ºã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. è¯»å–é…ç½®æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. åŠ è½½æ‰€æœ‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. åˆ›å»º agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        AgentBuilder agentBuilder = new AgentBuilder.Default().with(new ByteBuddy().with(TypeValidation.ENABLED)) // é€šè¿‡ByteBuddyåˆ›å»ºAgentï¼Œå¼€å¯ç±»å‹æ ¡éªŒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ignore(ElementMatchers.isSynthetic()) // å¿½ç•¥åˆæˆç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .or(ElementMatchers.nameStartsWith(&quot;org.apache.shenyu.agent.&quot;)); // å¿½ç•¥org.apache.shenyu.agent çš„ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        agentBuilder.type(ShenyuAgentTypeMatcher.getInstance())//åŒ¹é…åŠ è½½ç±»å‹ï¼ŒåŒ¹é…å™¨æ˜¯ShenyuAgentTypeMatcher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .transform(new ShenyuAgentTransformer()) // åŒ¹é…æˆåŠŸçš„ï¼Œé€šè¿‡ShenyuAgentTransformeræ”¹å˜å…¶è¡Œä¸º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION) //æŒ‡å®šé‡å®šä¹‰ç­–ç•¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .with(new TransformListener()) //æŒ‡å®šä¸€ä¸ªç›‘å¬å™¨ï¼Œç›‘å¬è¿è¡Œè¿‡ç¨‹ä¸­çš„äº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .installOn(instrumentation); // å°†ä¿®æ”¹åº”ç”¨åˆ°instrumentationä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. å¯åŠ¨æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨åˆ›å»ºagentçš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦æ³¨æ„ä¸¤ä¸ªç‚¹ï¼š</p><ul><li>æ˜¯å¦åŒ¹é…æˆåŠŸï¼Œç”±<code>ShenyuAgentTypeMatcher</code>å†³å®šï¼›</li><li>åŒ¹é…æˆåŠŸçš„ç±»ï¼Œé€šè¿‡<code>ShenyuAgentTransformer</code>æ”¹å˜å…¶è¡Œä¸ºï¼›</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥ç€é‡åˆ†æè¿™ä¸¤ä¸ªç±»ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="41-å®šä¹‰åŒ¹é…é€»è¾‘"></a>4.1 å®šä¹‰åŒ¹é…é€»è¾‘<a class="hash-link" href="#41-å®šä¹‰åŒ¹é…é€»è¾‘" title="Direct link to heading">#</a></h4><ul><li>ShenyuAgentTypeMatcher#matches()</li></ul><p><code>ShenyuAgentTypeMatcher</code>ä½¿ç”¨å•ä¾‹çš„è®¾è®¡æ¨¡å¼ï¼Œå®ç°äº†<code>ElementMatcher</code>æ¥å£ï¼Œé‡å†™äº†<code>matches()</code>æ–¹æ³•ã€‚</p><p>æ˜¯å¦èƒ½å¤ŸåŒ¹é…æˆåŠŸçš„é€»è¾‘æ˜¯ï¼šå¦‚æœç›®æ ‡ç±»åœ¨æ‹¦æˆªç‚¹<code>joinPointMap</code>é›†åˆä¸­ï¼Œå°±åŒ¹é…æˆåŠŸã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTypeMatcher extends ElementMatcher.Junction.AbstractBase&lt;TypeDefinition&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Map&lt;String, ShenyuAgentJoinPoint&gt; joinPointMap;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è‡ªå®šä¹‰åŒ¹é…é€»è¾‘ï¼šå¦‚æœç›®æ ‡ç±»åœ¨æ‹¦æˆªç‚¹joinPointMapé›†åˆä¸­ï¼Œå°±åŒ¹é…æˆåŠŸ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean matches(final TypeDefinition target) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return joinPointMap.containsKey(target.getTypeName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="42-æ”¹å˜åŒ¹é…ç±»çš„è¡Œä¸º"></a>4.2 æ”¹å˜åŒ¹é…ç±»çš„è¡Œä¸º<a class="hash-link" href="#42-æ”¹å˜åŒ¹é…ç±»çš„è¡Œä¸º" title="Direct link to heading">#</a></h4><p>åœ¨åŠ è½½ç›®æ ‡ç±»æ—¶ï¼Œå¦‚æœåŒ¹é…æˆåŠŸï¼Œä¼šé€šè¿‡<code>ShenyuAgentTransformer</code>æ”¹å˜å…¶è¡Œä¸ºï¼Œå®ƒå®ç°äº†<code>Transformer</code>æ¥å£ï¼Œé‡å†™äº†<code>transform()</code>æ–¹æ³•ï¼Œ<code>Transformer</code>ä¹Ÿæ˜¯<code>bytebuddy</code>çš„ä¸€ä¸ªæ¥å£ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class ShenyuAgentTransformer implements Transformer {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åœ¨åŒ¹é…ç±»ä¸­é¢å¤–å®šä¹‰ä¸€ä¸ªå­—æ®µï¼Œä¼ é€’ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final String EXTRA_DATA = &quot;_$EXTRA_DATA$_&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //ç±»å‹åŒ¹é…å™¨    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ShenyuAgentTypeMatcher MATCHER = ShenyuAgentTypeMatcher.getInstance();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //é‡å†™transformæ–¹æ³•ï¼Œé‡æ–°å®šä¹‰åŒ¹é…ç±»çš„è¡Œä¸º</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //åŠ è½½ç±»æœŸé—´ï¼Œæ‰§è¡Œä¸€æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Builder&lt;?&gt; transform(final Builder&lt;?&gt; builder, final TypeDescription typeDescription, final ClassLoader classLoader, final JavaModule module) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¸æ˜¯åŒ¹é…çš„ç±»å°±è·³è¿‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (!MATCHER.containsType(typeDescription)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return builder;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¸ºè¯¥ç±»æ–°å¢åŠ ä¸€ä¸ªå­—æ®µ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Builder&lt;?&gt; result = builder.defineField(EXTRA_DATA, Object.class, Opcodes.ACC_PRIVATE | Opcodes.ACC_VOLATILE).implement(TargetObject.class).intercept(FieldAccessor.ofField(EXTRA_DATA));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è·å–æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ShenyuAgentJoinPoint joinPoint = MATCHER.loadShenyuAgentJoinPoint(typeDescription);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‹¦æˆªæ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorConstructorPoint(typeDescription, joinPoint.getConstructorPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‹¦æˆªé™æ€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorStaticMethodPoint(typeDescription, joinPoint.getStaticMethodPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ‹¦æˆªå®ä¾‹æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        result = interceptorInstanceMethodPoint(typeDescription, joinPoint.getInstanceMethodPoints(), result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>transform()</code>æ–¹æ³•ä¸­ï¼Œé‡æ–°å®šä¹‰äº†åŒ¹é…ç±»çš„è¡Œä¸ºï¼š</p><ul><li>æ–°å¢äº†å­—æ®µï¼Œæ˜¯<code>TargetObject</code>çš„å­ç±»ï¼Œç”¨äºä¼ é€’ä¸Šä¸‹æ–‡ï¼›</li><li>æ ¹æ®æŒ‡å®šé…ç½®ï¼Œæ˜¯å¦æ‹¦æˆªæ„é€ å™¨ï¼›</li><li>æ ¹æ®æŒ‡å®šé…ç½®ï¼Œæ˜¯å¦æ‹¦æˆªé™æ€æ–¹æ³•ï¼›</li><li>æ ¹æ®æŒ‡å®šé…ç½®ï¼Œæ‹¦æˆªå®ä¾‹æ–¹æ³•ï¼›</li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-æ‹¦æˆªå®ä¾‹æ–¹æ³•"></a>4.2.3 æ‹¦æˆªå®ä¾‹æ–¹æ³•<a class="hash-link" href="#423-æ‹¦æˆªå®ä¾‹æ–¹æ³•" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorInstanceMethodPoint()</li></ul><p>æ ¹æ®åˆ‡é¢æ„å»ºå®ä¾‹æ–¹æ³•æ‹¦æˆªç‚¹ï¼Œè·å–<code>Builder</code>å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Builder&lt;?&gt; interceptorInstanceMethodPoint(final TypeDescription description, final Collection&lt;InstanceMethodPointCut&gt; pointCuts, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(each -&gt; !(each.isAbstract() || each.isSynthetic())) //è¿‡æ»¤æŠ½è±¡æ–¹æ³•ï¼Œåˆæˆæ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(each -&gt; buildInstanceMethodTransformationPoint(pointCuts, each)) //æ„å»ºå®ä¾‹æ–¹æ³•æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getBuilder(description, builder, points); //è·å–Builderå¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildInstanceMethodTransformationPoint()</li></ul><p>è¿‡æ»¤åŒ¹é…ä¸Šçš„æ–¹æ³•ï¼Œä¸ºæ–¹æ³•è·å–å¯¹åº”çš„<code>handler</code>å¤„ç†å™¨ï¼Œæœ€ååˆ›å»ºå®ä¾‹æ–¹æ³•æ‹¦æˆªç‚¹å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTransformerPoint&lt;?&gt; buildInstanceMethodTransformationPoint(final Collection&lt;InstanceMethodPointCut&gt; pointCuts, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;InstanceMethodPointCut&gt; points = pointCuts.stream().filter(point -&gt; point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //è¿‡æ»¤èƒ½å¤ŸåŒ¹é…ä¸Šçš„æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (points.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;InstanceMethodHandler&gt; handlers = points.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (InstanceMethodHandler) MATCHER.getOrCreateInstance(handler)) //è·å–å¯¹åº”çš„handlerå¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new InstanceMethodInterceptor(handlers));//åˆ›å»ºå®ä¾‹æ–¹æ³•æ‹¦æˆªç‚¹å¯¹è±¡ï¼Œåˆ›å»ºå®ä¾‹æ–¹æ³•æ‹¦æˆªå™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ–¹æ³•èƒ½å¦åŒ¹é…æˆåŠŸï¼šå½“å‰æ–¹æ³•åç§°æ˜¯å¦æ˜¯åœ¨<code>tracing-point.yaml</code>æ–‡ä»¶ä¸­é…ç½®çš„æ–¹æ³•åç§°ï¼›</p><p><code>handler</code>çš„è·å–ï¼šæ˜¯æ ¹æ®<code>tracing-point.yaml</code>æ–‡ä»¶ä¸­é…ç½®çš„å…¨é™å®šåå»åŠ è½½å¯¹åº”çš„ç±»ã€‚</p><ul><li>InstanceMethodInterceptor#intercept()</li></ul><p>å®ä¾‹æ–¹æ³•æ‹¦æˆªå™¨<code>InstanceMethodInterceptor</code>ä¼šåœ¨è¿è¡ŒæœŸé—´åŠ¨æ€å¤„ç†æ‹¦æˆªæ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class InstanceMethodInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ‹¦æˆªç›®æ ‡å¯¹è±¡.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param target å½“å‰è¢«æ‹¦æˆªçš„ç›®æ ‡å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param method ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param args ç›®æ ‡æ–¹æ³•çš„å‚æ•°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param callable ç›®æ ‡æ–¹æ³•è°ƒç”¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ç›®æ ‡æ–¹æ³•è°ƒç”¨ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws å¼‚å¸¸ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType //å®šä¹‰è¿è¡Œæ—¶çš„ç›®æ ‡æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object intercept(@This final Object target, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable&lt;?&gt; callable) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ç›®æ ‡æ–¹æ³•æ‰§è¡Œç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object result = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ç›®æ ‡å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        TargetObject instance = (TargetObject) target;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¾æ¬¡è°ƒç”¨handler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (InstanceMethodHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MethodResult methodResult = new MethodResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å‰ç½®å¤„ç†é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.before(instance, method, args, methodResult);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to execute the before method of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //è°ƒç”¨ç›®æ ‡æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = callable.call();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               //å¤„ç†å¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.onThrowing(instance, method, args, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the error handler of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //åç½®å¤„ç†é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    result = handler.after(instance, method, args, methodResult, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the after method of method {} in class {}&quot;, method.getName(), target.getClass(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¿”å›ç›®æ ‡æ–¹æ³•è°ƒç”¨ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å®ä¾‹æ–¹æ³•æ‹¦æˆªå™¨åœ¨ç›®æ ‡æ–¹æ³•è°ƒç”¨å‰ï¼Œå¢åŠ äº†å‰ç½®å¤„ç†é€»è¾‘ï¼Œåç½®å¤„ç†é€»è¾‘ï¼Œä»¥åŠå¼‚å¸¸å¤„ç†é€»è¾‘ã€‚</p><p>è¿™é‡Œç”¨åˆ°äº†<code>Byte Buddy</code>çš„å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><code>@RuntimeType</code>ï¼š	å®šä¹‰è¿è¡Œæ—¶çš„ç›®æ ‡æ–¹æ³•ï¼Œæç¤º<code>ByteBuddy</code>ç¦ç”¨ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥ï¼›</li><li><code>@This</code>ï¼šå½“å‰è¢«æ‹¦æˆªçš„ã€åŠ¨æ€ç”Ÿæˆçš„å®ä¾‹å¯¹è±¡ï¼›</li><li><code>@Origin</code>ï¼šåŸæœ‰æ–¹æ³•ï¼›</li><li><code>@AllArguments</code>ï¼šè·å–æ‰€æœ‰å…¥å‚ï¼›</li><li><code>@SuperCall</code>ï¼šç”¨äºè°ƒç”¨çˆ¶ç±»ç‰ˆæœ¬çš„æ–¹æ³•ã€‚</li></ul><p>å®ä¾‹æ–¹æ³•å¤„ç†å™¨<code>InstanceMethodHandler</code>åªæ˜¯å®šä¹‰äº†ä¸‰ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°é€»è¾‘ç”±å…·ä½“æ’ä»¶å»å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public interface InstanceMethodHandler {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å‰ç½®å¤„ç†é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void before(final TargetObject target, final Method method, final Object[] args, final MethodResult result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // åç½®å¤„ç†é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default Object after(final TargetObject target, final Method method, final Object[] args, final MethodResult methodResult, final Object result) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // å¼‚å¸¸å¤„ç†é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    default void onThrowing(final TargetObject target, final Method method, final Object[] args, final Throwable throwable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>ShenyuAgentTransformer#getBuilder()</p><p>åœ¨<code>Agent</code>çš„<code>Builder</code>è·å–æ—¶ï¼Œä¸ºæŒ‡å®šçš„ç›®æ ‡æ–¹æ³•æŒ‡å®šå¯¹åº”çš„æ‹¦æˆªå™¨ï¼Œåœ¨åŸæœ‰æ–¹æ³•ä¸Šæ·»åŠ æ–°çš„é€»è¾‘ï¼Œæ”¹å˜åŸæœ‰æ–¹æ³•è¡Œä¸ºã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static Builder&lt;?&gt; getBuilder(final TypeDescription description, final Builder&lt;?&gt; builder, final Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Builder&lt;?&gt;[] result = {builder};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        points.forEach(point -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result[0] = builder.method(ElementMatchers.is(point.getDescription()))//æŒ‡å®šç›®æ ‡æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .intercept(MethodDelegation.withDefaultConfiguration().to(point.getInterceptor()));//æŒ‡å®šæ‹¦æˆªå™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:OFF</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:ON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to load handler class: {}&quot;, description.getTypeName(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>é€šè¿‡ä»¥ä¸Šçš„å¤„ç†é€»è¾‘ï¼Œå°±å¯ä»¥å®ç°æ— ä¾µå…¥æ‹¦æˆªå®ä¾‹æ–¹æ³•äº†ã€‚</p><p>æ‹¦æˆªæ–¹æ³•<code>intercept()</code>çš„å¤„ç†é€»è¾‘æ˜¯ï¼š</p><ul><li>ä¾æ¬¡å¤„ç†æ¯ä¸ª<code>handler</code>ï¼›</li><li>è°ƒç”¨<code>handler</code>çš„å‰ç½®æ–¹æ³•ï¼›</li><li>è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼›</li><li>å¦‚æœç›®æ ‡æ–¹æ³•æœ‰å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨<code>handler</code>çš„å¼‚å¸¸å¤„ç†æ–¹æ³•ï¼›</li><li>è°ƒç”¨<code>handler</code>çš„åç½®æ–¹æ³•ã€‚</li></ul><p>æ¥ä¸‹æ¥çœ‹çœ‹æ‹¦æˆªé™æ€æ–¹æ³•ã€‚</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-æ‹¦æˆªé™æ€æ–¹æ³•"></a>4.2.3 æ‹¦æˆªé™æ€æ–¹æ³•<a class="hash-link" href="#423-æ‹¦æˆªé™æ€æ–¹æ³•" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorStaticMethodPoint()</li></ul><p>è¿‡æ»¤å‡ºé™æ€æ–¹æ³•ï¼Œç„¶åä¸ºé™æ€æ–¹æ³•æ„å»ºé™æ€æ–¹æ³•æ‹¦æˆªç‚¹ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private Builder&lt;?&gt; interceptorStaticMethodPoint(final TypeDescription description, final Collection&lt;StaticMethodPointCut&gt; pointCuts, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;?&gt;&gt; points = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(each -&gt; each.isStatic() &amp;&amp; !(each.isAbstract() || each.isSynthetic())) // å½“å‰æ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼Œä¸æ˜¯æŠ½è±¡æ–¹æ³•ï¼Œä¸æ˜¯åˆæˆæ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(methodDescription -&gt; buildStaticMethodTransformationPoint(pointCuts, methodDescription)) // æ„å»ºé™æ€æ–¹æ³•æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return getBuilder(description, builder, points);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildStaticMethodTransformationPoint()</li></ul><p>æ ¹æ®é…ç½®æ–‡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œåˆ¤æ–­å½“å‰çš„é™æ€æ–¹æ³•æ˜¯å¦éœ€è¦æ‹¦æˆªã€‚ç„¶åè·å–å¯¹åº”çš„å¤„ç†å™¨ï¼Œæœ€åæ„å»ºé™æ€æ–¹æ³•æ‹¦æˆªå™¨å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private ShenyuAgentTransformerPoint&lt;?&gt; buildStaticMethodTransformationPoint(final Collection&lt;StaticMethodPointCut&gt; pointCuts, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;StaticMethodPointCut&gt; staticMethodPoints = pointCuts.stream().filter(point -&gt; point.getMatcher().matches(methodDescription)).collect(Collectors.toList()); //æ ¹æ®é…ç½®æ–‡ä»¶è¿›è¡Œè¿‡æ»¤ï¼Œåˆ¤æ–­å½“å‰çš„é™æ€æ–¹æ³•æ˜¯å¦éœ€è¦æ‹¦æˆª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (staticMethodPoints.isEmpty()) { // å¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°±ç›´æ¥è¿”å›äº†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;StaticMethodHandler&gt; handlers = staticMethodPoints.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (StaticMethodHandler) MATCHER.getOrCreateInstance(handler)) //è·å–å¯¹åº”çš„å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new StaticMethodInterceptor(handlers)); //æ„å»ºé™æ€æ–¹æ³•æ‹¦æˆªå™¨å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>StaticMethodInterceptor#intercept()</li></ul><p>åœ¨è¿è¡Œæ—¶ï¼Œä¼šæ‹¦æˆªç›®æ ‡æ–¹æ³•ï¼Œæ‰§è¡Œæ‹¦æˆªå™¨çš„å¤„ç†é€»è¾‘ ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StaticMethodInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //......  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ‹¦æˆªç›®æ ‡æ–¹æ³•.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object intercept(@Origin final Class&lt;?&gt; klass, @Origin final Method method, @AllArguments final Object[] args, @SuperCall final Callable&lt;?&gt; callable) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Object result = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // handlerå¾ªç¯å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (StaticMethodHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            MethodResult methodResult = new MethodResult();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //å‰ç½®æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.before(klass, method, args, new MethodResult());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to execute the before method of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // è°ƒç”¨å½“å‰æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ç›®æ ‡æ–¹æ³•æ˜¯ä¸æ˜¯åº”è¯¥åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Ÿ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result = callable.call();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    //å¼‚å¸¸é€»è¾‘å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.onThrowing(klass, method, args, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ignored) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the error handler of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw ex;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } finally {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // åç½®æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    handler.after(klass, method, args, methodResult);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    LOG.error(&quot;Failed to execute the after method of method {} in class {}&quot;, method.getName(), klass, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¿”å›æ–¹æ³•è°ƒç”¨ç»“æœ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ‹¦æˆªæ–¹æ³•<code>intercept()</code>çš„å¤„ç†é€»è¾‘æ˜¯ï¼š</p><ul><li>ä¾æ¬¡å¤„ç†æ¯ä¸ª<code>handler</code>ï¼›</li><li>è°ƒç”¨<code>handler</code>çš„å‰ç½®æ–¹æ³•ï¼›</li><li>è°ƒç”¨ç›®æ ‡æ–¹æ³•ï¼›</li><li>å¦‚æœç›®æ ‡æ–¹æ³•æœ‰å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨<code>handler</code>çš„å¼‚å¸¸å¤„ç†æ–¹æ³•ï¼›</li><li>è°ƒç”¨<code>handler</code>çš„åç½®æ–¹æ³•ã€‚</li></ul><p>æœ€åå†çœ‹çœ‹å¦‚ä½•æ‹¦æˆªæ„é€ å™¨ã€‚</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="423-æ‹¦æˆªæ„é€ å™¨"></a>4.2.3 æ‹¦æˆªæ„é€ å™¨<a class="hash-link" href="#423-æ‹¦æˆªæ„é€ å™¨" title="Direct link to heading">#</a></h5><ul><li>ShenyuAgentTransformer#interceptorConstructorPoint()</li></ul><p>è¿‡æ»¤å‡ºæ„é€ å™¨ï¼Œç„¶åæ„å»ºæ„é€ å™¨çš„æ‹¦æˆªç‚¹ï¼Œæœ€ååˆ›å»º<code>builder</code>å¯¹è±¡ï¼Œä¸ºæ„é€ æ–¹æ³•æ·»åŠ æ‹¦æˆªå™¨ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> private Builder&lt;?&gt; interceptorConstructorPoint(final TypeDescription description, final Collection&lt;ConstructorPointCut&gt; constructorPoints, final Builder&lt;?&gt; builder) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collection&lt;ShenyuAgentTransformerPoint&lt;? extends ConstructorInterceptor&gt;&gt; constructorAdviceComposePoints = description.getDeclaredMethods().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(MethodDescription::isConstructor) //è¿‡æ»¤å‡ºæ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(each -&gt; buildConstructorTransformerPoint(constructorPoints, each))//æ„å»ºæ„é€ å™¨çš„æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Builder&lt;?&gt;[] result = {builder};</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // åˆ›å»ºbuilderå¯¹è±¡ï¼Œä¸ºæ„é€ æ–¹æ³•æ·»åŠ æ‹¦æˆªå™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        constructorAdviceComposePoints.forEach(point -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                result[0] = builder.constructor(ElementMatchers.is(point.getDescription()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .intercept(SuperMethodCall.INSTANCE.andThen(MethodDelegation.withDefaultConfiguration()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .to(point.getInterceptor())));//å…ˆè°ƒç”¨çˆ¶ç±»æ„é€ å™¨ï¼Œç„¶åæ·»åŠ æ‹¦æˆªå™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:OFF</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // CHECKSTYLE:ON</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to load handler class: {}&quot;, description.getTypeName(), ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ShenyuAgentTransformer#buildConstructorTransformerPoint()</li></ul><p>å…ˆè·å–åˆ°æ„é€ å™¨æ‹¦æˆªç‚¹ï¼Œç„¶åä¸ºæ‹¦æˆªç‚¹åˆ›å»º<code>handler</code>å®ä¾‹å¯¹è±¡ï¼Œæœ€ååˆ›å»ºæ„é€ å™¨æ‹¦æˆªå™¨å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private ShenyuAgentTransformerPoint&lt;? extends ConstructorInterceptor&gt; buildConstructorTransformerPoint(</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final Collection&lt;ConstructorPointCut&gt; constructorPoints, final InDefinedShape methodDescription) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //è·å–æ„é€ å™¨æ‹¦æˆªç‚¹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConstructorPointCut&gt; constructorPointCutList = constructorPoints.stream().filter(each -&gt; each.getMatcher().matches(methodDescription)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (constructorPointCutList.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConstructorHandler&gt; handlers = constructorPointCutList.stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(pointCut -&gt; pointCut.getHandlers().stream())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(handler -&gt; (ConstructorHandler) MATCHER.getOrCreateInstance(handler)) //åˆ›å»ºæ‹¦æˆªç‚¹çš„handlerå®ä¾‹å¯¹è±¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(Objects::nonNull)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ShenyuAgentTransformerPoint&lt;&gt;(methodDescription, new ConstructorInterceptor(handlers));//åˆ›å»ºæ„é€ å™¨æ‹¦æˆªå™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>ConstructorInterceptor#intercept()</li></ul><p>æ„é€ å™¨æ‹¦æˆªå™¨ï¼šåœ¨è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„æ„é€ å™¨ä¹‹å‰ï¼Œæ‰§è¡Œæ¯ä¸ª<code>handler</code>çš„å¤„ç†é€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConstructorInterceptor {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ‹¦æˆªæ–¹æ³•.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RuntimeType</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void intercept(@This final TargetObject target, @AllArguments final Object[] args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConstructorHandler handler : handlerList) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // handlerå¤„ç†é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                handler.onConstructor(target, args);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable throwable) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Constructor advice execution error. class: {}&quot;, target.getClass().getTypeName(), throwable);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ†æåˆ°æ­¤ï¼Œæˆ‘ä»¬åˆ†æå®Œäº†åˆ›å»º<code>agent</code>çš„æ•´ä¸ªè¿‡ç¨‹ï¼š</p><ul><li>æ ¹æ®é…ç½®æ–‡ä»¶ï¼Œå®šä¹‰åŒ¹é…é€»è¾‘<code>ShenyuAgentTypeMatcher</code>ï¼›</li><li>å®šä¹‰<code>ShenyuAgentTransformer</code>å¯¹è±¡ï¼Œæ”¹å˜åŒ¹é…ç±»çš„è¡Œä¸ºï¼›</li><li>é€šè¿‡<code>InstanceMethodInterceptor</code>æ‹¦æˆªå®ä¾‹å¯¹è±¡æ–¹æ³•ï¼›</li><li>é€šè¿‡<code>StaticMethodInterceptor</code>æ‹¦æˆªé™æ€æ–¹æ³•ï¼›</li><li>é€šè¿‡<code>ConstructorInterceptor</code>æ‹¦æˆªæ„é€ å™¨ã€‚</li></ul><p>è¿™é‡Œæ²¡æœ‰æåˆ°æ¯ä¸ª<code>handler</code>çš„å¤„ç†é€»è¾‘ï¼Œæ˜¯å› ä¸º<code>handler</code>çš„å®ç°é€»è¾‘ç”±æ¯ä¸ªæ’ä»¶è‡ªå®šä¹‰ã€‚æ¯”å¦‚ï¼Œå½“å‰å®ä¾‹æ–¹æ³•æ‹¦æˆªå™¨<code>InstanceMethodHandler</code>çš„å®ç°ç±»å°±æœ‰<code>jaeger</code>ï¼Œ<code>opentelemetry</code>å’Œ<code>zipkin</code>ã€‚</p><p><img src="/zh/assets/images/instance_method_handler-309e74ac5f633743f57a9b60039f2486.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-å¯åŠ¨æ’ä»¶"></a>5. å¯åŠ¨æ’ä»¶<a class="hash-link" href="#5-å¯åŠ¨æ’ä»¶" title="Direct link to heading">#</a></h3><p>åˆ›å»ºå®Œ <code>agent</code>ä¹‹åï¼Œå¯åŠ¨å„ä¸ªæ’ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> public static void premain(final String arguments, final Instrumentation instrumentation) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. è¯»å–é…ç½®æ–‡ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. åŠ è½½æ‰€æœ‰æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. åˆ›å»º agent</span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. å¯åŠ¨æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginLifecycleManager lifecycleManager = new PluginLifecycleManager();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        lifecycleManager.startup(ShenyuAgentConfigUtils.getPluginConfigMap());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ·»åŠ hookå‡½æ•°ç”¨äºå…³é—­æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Runtime.getRuntime().addShutdownHook(new Thread(lifecycleManager::close));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li><p>PluginLifecycleManager</p><p><code>PluginLifecycleManager</code>è´Ÿè´£æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œç”¨äºå¯åŠ¨æ’ä»¶å’Œå…³é—­æ’ä»¶ã€‚</p><p>æ’ä»¶çš„å¯åŠ¨ï¼Œå¿…é¡»è¦åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class PluginLifecycleManager {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //......      </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¯åŠ¨æ’ä»¶.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void startup(final Map&lt;String, AgentPluginConfig&gt; configMap) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä»é…ç½®æ–‡ä»¶ä¸­è·å–æ”¯æŒçš„æ’ä»¶åç§°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Set&lt;String&gt; support = ShenyuAgentConfigUtils.getSupports();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        configMap.entrySet().stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .filter(entry -&gt; support.contains(entry.getKey())) //åŒ…å«åœ¨é…ç½®æ–‡ä»¶ä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .forEach(entry -&gt; Optional.ofNullable(SPILoader.load(AgentPluginBootService.class, entry.getKey())) //é€šè¿‡SPIåŠ è½½æ’ä»¶å¯åŠ¨ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .ifPresent(bootService -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOG.info(&quot;start shenyu plugin: {}&quot;, entry.getKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                bootService.start(entry.getValue());  // å¯åŠ¨æ’ä»¶ï¼šæ‰§è¡Œæ’ä»¶çš„å…·ä½“å¯åŠ¨é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                LOG.error(&quot;Failed to start shenyu plugin&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…³é—­æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //é€šè¿‡SPIåŠ è½½æ’ä»¶å¯åŠ¨ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SPILoader.loadList(AgentPluginBootService.class).forEach(each -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                each.close(); // å…³é—­æ’ä»¶ï¼šæ‰§è¡Œæ’ä»¶çš„å…·ä½“å…³é—­é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (final Throwable ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LOG.error(&quot;Failed to close shenyu agent plugin&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ’ä»¶çš„å¯åŠ¨å’Œå…³é—­ä¹Ÿæ˜¯æœ‰æ¯ä¸ªæ’ä»¶å…·ä½“å»å®ç°çš„ï¼Œç„¶åé€šè¿‡<code>SPI</code>å»åŠ è½½ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-æ€»ç»“"></a>6. æ€»ç»“<a class="hash-link" href="#6-æ€»ç»“" title="Direct link to heading">#</a></h3><ul><li><code>shenyu-agent</code>æ¨¡å—çš„å®ç°ä¸»è¦æ˜¯é€šè¿‡<code>Byte Buddy</code>å·¥å…·åŒ…ï¼›</li><li>åœ¨é…ç½®æ–‡ä»¶<code>shenyu-agent.yaml</code>ä¸­ï¼ŒæŒ‡å®šæ’ä»¶ä¿¡æ¯ï¼›</li><li>æ’ä»¶åŠ è½½è¿‡ç¨‹é€šè¿‡<code>SPI</code>å®Œæˆï¼›</li><li>æ‹¦æˆªç‚¹é€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šï¼Œè®¾è®¡çµæ´»ï¼›</li><li>æ’ä»¶æ¥å£å®šä¹‰å’Œå®ç°åˆ†å¼€ï¼Œæ”¯æŒå¤šç§æ’ä»¶ç±»å‹ã€‚</li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/agent">Agent</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div><div class="col margin-top--sm"><a href="https://github.com/apache/incubator-shenyu-website/edit/main/i18n/zh/docusaurus-plugin-content-blog/Agent-SourceCode-Analysis.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>ç¼–è¾‘æœ¬æ–‡æ¡£</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog/DataSync-SourceCode-Analysis-Nacos-Data-Sync"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Nacosæ•°æ®åŒæ­¥æºç åˆ†æ</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Httpé•¿è½®è¯¢æ•°æ®åŒæ­¥æºç åˆ†æ Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#aopæœ¯è¯­" class="table-of-contents__link">AOPæœ¯è¯­</a></li><li><a href="#å…³äºbyte-buddy" class="table-of-contents__link">å…³äºByte Buddy</a></li><li><a href="#1--premainå…¥å£" class="table-of-contents__link">1.  premainå…¥å£</a></li><li><a href="#2-è¯»å–é…ç½®æ–‡ä»¶" class="table-of-contents__link">2. è¯»å–é…ç½®æ–‡ä»¶</a></li><li><a href="#3-åŠ è½½æ’ä»¶" class="table-of-contents__link">3. åŠ è½½æ’ä»¶</a></li><li><a href="#4-åˆ›å»º-agent" class="table-of-contents__link">4. åˆ›å»º agent</a></li><li><a href="#5-å¯åŠ¨æ’ä»¶" class="table-of-contents__link">5. å¯åŠ¨æ’ä»¶</a></li><li><a href="#6-æ€»ç»“" class="table-of-contents__link">6. æ€»ç»“</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ShenYu</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/download">ä¸‹è½½</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/index">æ–‡æ¡£</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/news">æ–°é—»</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog">åšå®¢</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>ç‰ˆæœ¬<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">ç¤¾åŒº</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/community/subscribe-email">ç¤¾åŒº</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">è®¢é˜…é‚®ä»¶ç»„</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/community/subscribe-email">å¦‚ä½•è®¢é˜…</a></li><li class="footer__item"><a href="mailto://dev-subscribe@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>è®¢é˜…é‚®ä»¶<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>é‚®ä»¶å½’æ¡£<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div><img style="height:50px" alt="Apache Software Foundation" src="/img/incubator-logo.png"><p style="color:#ffffffcf;font-size:14px;text-align:left">Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
      <p style="color:white;font-size:14px;"> Copyright Â© 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
      <div></div></div></div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.138a9106.js"></script>
<script src="/zh/assets/js/main.5c3e066b.js"></script>
</body>
</html>