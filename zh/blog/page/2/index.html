<!doctype html>
<html lang="zh" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.4">
<link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed">
<link rel="search" type="application/opensearchdescription+xml" title="Apache ShenYu (Incubating)" href="/zh/opensearch.xml">
<link rel="alternate" type="application/rss+xml" href="/zh/news/rss.xml" title="Apache ShenYu (Incubating) Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/news/atom.xml" title="Apache ShenYu (Incubating) Blog Atom Feed"><title data-react-helmet="true">Blog | Apache ShenYu (Incubating)</title><meta data-react-helmet="true" property="og:title" content="Blog | Apache ShenYu (Incubating)"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" property="og:url" content="https://shenyu.apache.org//zh/blog/page/2"><meta data-react-helmet="true" name="docsearch:language" content="zh"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-react-helmet="true" rel="shortcut icon" href="/zh/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://shenyu.apache.org//zh/blog/page/2"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//zh/blog/page/2" hreflang="zh"><link data-react-helmet="true" rel="alternate" href="https://shenyu.apache.org//blog/page/2" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/zh/assets/css/styles.2b831628.css">
<link rel="preload" href="/zh/assets/js/runtime~main.0e06cfab.js" as="script">
<link rel="preload" href="/zh/assets/js/main.b8c1dc42.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh/"><img src="/zh/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--light_4Vu1 navbar__logo"><img src="/zh/img/logo.png" alt="Apache ShenYu Logo" class="themedImage_TMUO themedImage--dark_uzRr navbar__logo"></a><a class="navbar__item navbar__link" href="/zh/download">ä¸‹è½½</a><a class="navbar__item navbar__link" href="/zh/docs/index">æ–‡æ¡£</a><a class="navbar__item navbar__link" href="/zh/community/subscribe-email">ç¤¾åŒº</a><a class="navbar__item navbar__link" href="/zh/event/2.4.2-release">äº‹ä»¶</a><a class="navbar__item navbar__link" href="/zh/news">æ–°é—»</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/blog">åšå®¢</a><a class="navbar__item navbar__link" href="/zh/users">ç”¨æˆ·</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__item navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/zh/docs/index">2.4.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh/docs/next/index">å½“å‰ç‰ˆæœ¬</a></li><li><a class="dropdown__link" href="/zh/docs/index">2.4.2</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.1/index">2.4.1</a></li><li><a class="dropdown__link" href="/zh/docs/2.4.0/index">2.4.0</a></li><li><a class="dropdown__link" href="/zh/docs/2.3.0/index">2.3.0</a></li><li><a class="dropdown__link" href="/zh/versions">All versions</a></li></ul></div><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1631348384596" class="icon" viewBox="0 0 1024 1024" version="1.1" style="vertical-align:text-bottom;margin-right:5px" p-id="557" width="20" height="20"><path d="M547.797333 638.208l-104.405333-103.168 1.237333-1.28a720.170667 720.170667 0 0 0 152.490667-268.373333h120.448V183.082667h-287.744V100.906667H347.605333v82.218666H59.818667V265.386667h459.178666a648.234667 648.234667 0 0 1-130.304 219.946666 643.242667 643.242667 0 0 1-94.976-137.728H211.541333a722.048 722.048 0 0 0 122.453334 187.434667l-209.194667 206.378667 58.368 58.368 205.525333-205.525334 127.872 127.829334 31.232-83.84m231.424-208.426667h-82.218666l-184.96 493.312h82.218666l46.037334-123.306667h195.242666l46.464 123.306667h82.218667l-185.002667-493.312m-107.690666 287.744l66.56-178.005333 66.602666 178.005333z" fill="currentColor" p-id="558"></path></svg><span>ç®€ä½“ä¸­æ–‡</span></span></a><ul class="dropdown__menu"><li><a href="/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/zh/blog/page/2" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">ç®€ä½“ä¸­æ–‡</a></li></ul></div><div class="react-toggle toggle_2i4l react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_iYfV">ğŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV">ğŸŒ</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_Bc3W"><button type="button" class="DocSearch DocSearch-Button" aria-label="æœç´¢"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">æœç´¢</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_SrOn thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_jISh margin-bottom--md">All Blog Posts</div><ul class="sidebarItemList_UfcF"><h4 class="categoryHeader_Xx2W">DataSync</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-WebSocket-Data-Sync">WebSocketæ•°æ®åŒæ­¥æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-ZooKeeper-Data-Sync">ZooKeeperæ•°æ®åŒæ­¥æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Httpé•¿è½®è¯¢æ•°æ®åŒæ­¥æºç åˆ†æ</a></li><h4 class="categoryHeader_Xx2W">IntegrationTest</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/IntegrationTest-Analysis">é›†æˆæµ‹è¯•å‰–æ</a></li><h4 class="categoryHeader_Xx2W">Plugin</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Plugin-SourceCode-Analysis-Context-Path-Plugin">Context-Pathæ’ä»¶æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Plugin-SourceCode-Analysis-Param-Mapping-Plugin">Param-Mappingæ’ä»¶æºç åˆ†æ</a></li><h4 class="categoryHeader_Xx2W">RegisterCenter</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/RegisterCenter-SourceCode-Analysis-Http-Register">æ³¨å†Œä¸­å¿ƒå®ç°åŸç†ä¹‹Httpæ³¨å†Œ</a></li><h4 class="categoryHeader_Xx2W">SPI</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-LoadBalance-SPI">LoadBalance SPI ä»£ç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-MatchStrategy-SPI">MatchStrategy--åŸºäºSPIçš„ä»£ç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/SPI-SourceCode-Analysis-PredicateJudge-SPI">PredicateJudge-- åŸºäºSPIçš„è®¾è®¡å®ç°åˆ†æ</a></li><h4 class="categoryHeader_Xx2W">code</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/code-analysis-ratelimiter-spi">RateLimiter SPI ä»£ç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/code-analysis-nacos-data-sync">Nacosæ•°æ®åŒæ­¥æºç åˆ†æ</a></li><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/code-analysis-etcd-data-sync">Etcd Data Synchronization Source Code Analysis</a></li><h4 class="categoryHeader_Xx2W">Start</h4><li class="sidebarItem_v502"><a class="sidebarItemLink_yJnx" href="/zh/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu å¯åŠ¨ç¤ºä¾‹</a></li></ul></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/code-analysis-nacos-data-sync">Nacosæ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-02-20T14:25:01.584Z">2022å¹´2æœˆ20æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>Etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>Nacos</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-å…³äºnacos"></a>1. å…³äºNacos<a class="hash-link" href="#1-å…³äºnacos" title="Direct link to heading">#</a></h3><p><a href="https://github.com/alibaba/nacos" target="_blank" rel="noopener noreferrer"><code>Nacos</code></a> å¹³å°ç”¨äºåŠ¨æ€æœåŠ¡å‘ç°ï¼Œä»¥åŠé…ç½®å’ŒæœåŠ¡ç®¡ç†ã€‚ <code>Shenyu</code>ç½‘å…³å¯é€‰æ‹©ä½¿ç”¨<code>Nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-adminæ•°æ®åŒæ­¥"></a>2. Adminæ•°æ®åŒæ­¥<a class="hash-link" href="#2-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªå®é™…æ¡ˆä¾‹è¿›è¡Œæºç è¿½è¸ªï¼Œæ¯”å¦‚åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼š</p><p><img src="/zh/assets/images/update-selector-zh-1f49b39fb8e5ce2c26a80018669619ea.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-æ¥æ”¶æ•°æ®"></a>2.1 æ¥æ”¶æ•°æ®<a class="hash-link" href="#21-æ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>è¿›å…¥<code>SelectorController</code>ç±»ä¸­çš„<code>updateSelector()</code>æ–¹æ³•ï¼Œå®ƒè´Ÿè´£æ•°æ®çš„æ ¡éªŒï¼Œæ·»åŠ æˆ–æ›´æ–°æ•°æ®ï¼Œè¿”å›ç»“æœä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è®¾ç½®å½“å‰é€‰æ‹©å™¨æ•°æ®id</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºæˆ–æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // è¿”å›ç»“æœä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å¤„ç†æ•°æ®"></a>2.2 å¤„ç†æ•°æ®<a class="hash-link" href="#22-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>åœ¨<code>SelectorServiceImpl</code>ç±»ä¸­é€šè¿‡<code>createOrUpdate()</code>æ–¹æ³•å®Œæˆæ•°æ®çš„è½¬æ¢ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œå‘å¸ƒäº‹ä»¶ï¼Œæ›´æ–°<code>upstream</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è´Ÿè´£äº‹ä»¶å‘å¸ƒçš„eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ•°æ® DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ¤æ–­æ˜¯æ·»åŠ è¿˜æ˜¯æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’å…¥é€‰æ‹©å™¨ä¸­çš„æ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æƒé™æ£€æŸ¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ›´æ–°æ•°æ®ï¼Œå…ˆåˆ é™¤å†æ–°å¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒäº‹ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>Service</code>ç±»å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ“ä½œï¼Œå³ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“ï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±ä¸æ·±å…¥è¿½è¸ªäº†ã€‚å…³äºæ›´æ–°<code>upstream</code>æ“ä½œï¼Œæ”¾åˆ°åé¢å¯¹åº”çš„ç« èŠ‚ä¸­è¿›è¡Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨å‘å¸ƒäº‹ä»¶çš„æ“ä½œï¼Œå®ƒä¼šæ‰§è¡Œæ•°æ®åŒæ­¥ã€‚</p><p><code>publishEvent()</code>æ–¹æ³•çš„é€»è¾‘æ˜¯ï¼šæ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶ï¼Œæ„å»ºæ¡ä»¶æ•°æ®ï¼Œå‘å¸ƒå˜æ›´æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">     private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰¾åˆ°é€‰æ‹©å™¨å¯¹åº”çš„æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ„å»ºæ¡ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å‘å¸ƒå˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‘å¸ƒå˜æ›´æ•°æ®é€šè¿‡<code>eventPublisher.publishEvent()</code>å®Œæˆï¼Œè¿™ä¸ª<code>eventPublisher</code>å¯¹è±¡æ˜¯ä¸€ä¸ª<code>ApplicationEventPublisher</code>ç±»ï¼Œè¿™ä¸ªç±»çš„å…¨é™å®šåæ˜¯<code>org.springframework.context.ApplicationEventPublisher</code>ã€‚çœ‹åˆ°è¿™å„¿ï¼Œæˆ‘ä»¬çŸ¥é“äº†å‘å¸ƒæ•°æ®æ˜¯é€šè¿‡<code>Spring</code>ç›¸å…³çš„åŠŸèƒ½æ¥å®Œæˆçš„ã€‚</p><blockquote><p>å…³äº<code>ApplicationEventPublisher</code>ï¼š</p><p>å½“æœ‰çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå‘å¸ƒè€…è°ƒç”¨ <code>ApplicationEventPublisher</code> çš„ <code>publishEvent</code> æ–¹æ³•å‘å¸ƒä¸€ä¸ªäº‹ä»¶ï¼Œ<code>Spring</code>å®¹å™¨å¹¿æ’­äº‹ä»¶ç»™æ‰€æœ‰è§‚å¯Ÿè€…ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„ <code>onApplicationEvent</code> æ–¹æ³•æŠŠäº‹ä»¶å¯¹è±¡ä¼ é€’ç»™è§‚å¯Ÿè€…ã€‚è°ƒç”¨ <code>publishEvent</code>æ–¹æ³•æœ‰ä¸¤ç§é€”å¾„ï¼Œä¸€ç§æ˜¯å®ç°æ¥å£ç”±å®¹å™¨æ³¨å…¥ <code>ApplicationEventPublisher</code> å¯¹è±¡ç„¶åè°ƒç”¨å…¶æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯ç›´æ¥è°ƒç”¨å®¹å™¨çš„æ–¹æ³•ï¼Œä¸¤ç§æ–¹æ³•å‘å¸ƒäº‹ä»¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ã€‚</p><ul><li><code>ApplicationEventPublisher</code>ï¼šå‘å¸ƒäº‹ä»¶ï¼›</li><li><code>ApplicationEvent</code>ï¼š<code>Spring</code> äº‹ä»¶ï¼Œè®°å½•äº‹ä»¶æºã€æ—¶é—´å’Œæ•°æ®ï¼›</li><li><code>ApplicationListener</code>ï¼šäº‹ä»¶ç›‘å¬è€…ï¼Œè§‚å¯Ÿè€…ï¼›</li></ul></blockquote><p>åœ¨<code>Spring</code>çš„äº‹ä»¶å‘å¸ƒæœºåˆ¶ä¸­ï¼Œæœ‰ä¸‰ä¸ªå¯¹è±¡ï¼Œ</p><p>ä¸€ä¸ªæ˜¯å‘å¸ƒäº‹ä»¶çš„<code>ApplicationEventPublisher</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡æ„é€ å™¨æ³¨å…¥äº†ä¸€ä¸ª<code>eventPublisher</code>ã€‚</p><p>å¦ä¸€ä¸ªå¯¹è±¡æ˜¯<code>ApplicationEvent</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEvent</code>ç»§æ‰¿äº†å®ƒï¼Œè¡¨ç¤ºäº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ€åä¸€ä¸ªæ˜¯ <code>ApplicationListener</code>ï¼Œåœ¨<code>ShenYu</code>ä¸­é€šè¿‡<code>DataChangedEventDispatcher</code>ç±»å®ç°äº†è¯¥æ¥å£ï¼Œä½œä¸ºäº‹ä»¶çš„ç›‘å¬è€…ï¼Œè´Ÿè´£å¤„ç†äº‹ä»¶å¯¹è±¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-åˆ†å‘æ•°æ®"></a>2.3 åˆ†å‘æ•°æ®<a class="hash-link" href="#23-åˆ†å‘æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>å½“äº‹ä»¶å‘å¸ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨è¿›å…¥åˆ°<code>DataChangedEventDispatcher</code>ç±»ä¸­çš„<code>onApplicationEvent()</code>æ–¹æ³•ï¼Œè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨<code>onApplicationEvent</code>æ–¹æ³•ï¼Œç„¶åéå†æ‰€æœ‰æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼Œåˆ¤æ–­æ˜¯å“ªç§æ•°æ®ç±»å‹ï¼Œäº¤ç»™ç›¸åº”çš„æ•°æ®ç›‘å¬å™¨è¿›è¡Œå¤„ç†ã€‚</p><p><code>ShenYu</code>å°†æ‰€æœ‰æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æ˜¯äº”ç§ï¼šè®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯å’Œå…ƒæ•°æ®ã€‚</p><p>è¿™é‡Œçš„æ•°æ®å˜æ›´ç›‘å¬å™¨ï¼ˆ<code>DataChangedListener</code>ï¼‰ï¼Œå°±æ˜¯æ•°æ®åŒæ­¥ç­–ç•¥çš„æŠ½è±¡ï¼Œå®ƒçš„å…·ä½“å®ç°æœ‰ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>è¿™å‡ ä¸ªå®ç°ç±»å°±æ˜¯å½“å‰<code>ShenYu</code>æ”¯æŒçš„åŒæ­¥ç­–ç•¥ï¼š</p><ul><li><code>WebsocketDataChangedListener</code>ï¼šåŸºäº<code>websocket</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ZookeeperDataChangedListener</code>ï¼šåŸºäº<code>zookeeper</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>ConsulDataChangedListener</code>ï¼šåŸºäº<code>consul</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>EtcdDataDataChangedListener</code>ï¼šåŸºäº<code>etcd</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>HttpLongPollingDataChangedListener</code>ï¼šåŸºäº<code>httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥ï¼›</li><li><code>NacosDataChangedListener</code>ï¼šåŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼›</li></ul><p>æ—¢ç„¶æœ‰è¿™ä¹ˆå¤šç§å®ç°ç­–ç•¥ï¼Œé‚£ä¹ˆå¦‚ä½•ç¡®å®šä½¿ç”¨å“ªä¸€ç§å‘¢ï¼Ÿ</p><p>å› ä¸ºæœ¬æ–‡æ˜¯åŸºäº<code>Nacos</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æï¼Œæ‰€ä»¥è¿™é‡Œä»¥<code>NacosDataChangedListener</code>ä¸ºä¾‹ï¼Œåˆ†æå®ƒæ˜¯å¦‚ä½•è¢«åŠ è½½å¹¶å®ç°çš„ã€‚</p><p>é€šè¿‡æŸ¥çœ‹å¯¹<code>NacosDataChangedListener</code>ç±»çš„è°ƒç”¨ï¼Œå¯ä»¥å‘ç°ï¼Œå®ƒæ˜¯åœ¨<code>DataSyncConfiguration</code>ç±»è¿›è¡Œé…ç½®çš„ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Nacos listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Import(NacosConfiguration.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class NacosListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Data changed listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener nacosDataChangedListener(final ConfigService configService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataChangedListener(configService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Nacos data init zookeeper data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param configService the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the nacos data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(NacosDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public NacosDataInit nacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new NacosDataInit(configService, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–ä»£ç ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªé…ç½®ç±»æ˜¯é€šè¿‡<code>SpringBoot</code>æ¡ä»¶è£…é…ç±»å®ç°çš„ã€‚åœ¨<code>NacosListener</code>ç±»ä¸Šé¢æœ‰å‡ ä¸ªæ³¨è§£ï¼š</p><ul><li><p><code>@Configuration</code>ï¼šé…ç½®æ–‡ä»¶ï¼Œåº”ç”¨ä¸Šä¸‹æ–‡ï¼›</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>ï¼šå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šé‡‡ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@Import(NacosConfiguration.class)</code>ï¼šå¯¼å…¥å¦ä¸€ä¸ªé…ç½®ç±»<code>NacosConfiguration</code>ï¼Œ<code>NacosConfiguration</code>æä¾›äº†ä¸€ä¸ªæ–¹æ³•<code>ConfigService nacosConfigService(final NacosProperties nacosProp)</code>ï¼Œå°†Nacoså±æ€§è½¬æ¢ä¸º<code>ConfigService</code>ç±»å‹çš„beanï¼Œè€ŒNacoså±æ€§æ˜¯é€šè¿‡<code>@EnableConfigurationProperties(NacosProperties.class)</code> å¯¼å…¥çš„ã€‚æˆ‘ä»¬å…ˆçœ‹ConfigServiceç±»å‹çš„beanå®šä¹‰ã€‚å†åˆ†æå±æ€§é…ç½®ç±»å’Œå¯¹åº”çš„å±æ€§é…ç½®æ–‡ä»¶ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableConfigurationProperties(NacosProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * register configService in spring ioc.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosProp the nacos configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return ConfigService {@linkplain ConfigService}</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnMissingBean(ConfigService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosProperties nacosProp) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosProp.getAcm() != null &amp;&amp; nacosProp.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use aliyun ACM service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosProp.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Use subaccount ACM administrative authority</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosProp.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosProp.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosProp.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosProp.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getUsername())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosProp.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosProp.getPassword())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosProp.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™ä¸ªæ–¹æ³•ä¸»è¦åˆ†æˆä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥æ ¹æ®æ˜¯å¦ä½¿ç”¨äº†aliyunçš„ACMæœåŠ¡ï¼Œä»NacosPropertiesä¸­è·å–ä¸åŒçš„nacosè·¯å¾„å’Œé‰´æƒä¿¡æ¯ï¼Œç¬¬äºŒæ­¥æ ¹æ®è·å–åˆ°çš„è¿™äº›å±æ€§ï¼Œä½¿ç”¨Nacoså®˜æ–¹çš„å·¥å‚æ–¹æ³•ï¼Œä½¿ç”¨åå°„çš„æ–¹å¼ï¼Œåˆ›å»ºconfigServiceã€‚</p><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬åˆ†æä¸€ä¸‹Nacosçš„å±æ€§é…ç½®å’Œå¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private NacosACMProperties acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUrl() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the url.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param url url</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUrl(final String url) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.url = url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the username.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param username username</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setUsername(final String username) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.username = username;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the password.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param password password</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setPassword(final String password) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.password = password;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets the value of acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the value of acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosACMProperties getAcm() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Sets the acm.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param acm acm</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void setAcm(final NacosACMProperties acm) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.acm = acm;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class NacosACMProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private boolean enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public boolean isEnabled() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the enabled.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param enabled enabled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEnabled(final boolean enabled) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.enabled = enabled;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getEndpoint() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the endpoint.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param endpoint endpoint</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setEndpoint(final String endpoint) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.endpoint = endpoint;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getNamespace() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the namespace.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param namespace namespace</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setNamespace(final String namespace) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.namespace = namespace;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getAccessKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the accessKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param accessKey accessKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setAccessKey(final String accessKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.accessKey = accessKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Gets the value of secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the value of secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public String getSecretKey() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Sets the secretKey.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param secretKey secretKey</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void setSecretKey(final String secretKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.secretKey = secretKey;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†<code>shenyu.sync.nacos.url</code>å±æ€§æ—¶ï¼Œå°†é‡‡ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œæ­¤æ—¶é…ç½®ç±»<code>NacosListener</code>ä¼šç”Ÿæ•ˆï¼Œå¹¶ç”Ÿæˆ<code>NacosDataChangedListener</code>å’Œ<code>NacosDataInit</code>ç±»å‹çš„beanã€‚</p><ul><li>ç”Ÿæˆ<code>NacosDataChangedListener</code>ç±»å‹çš„beanï¼Œ<code>nacosDataChangedListener</code>ï¼Œè¿™ä¸ªbeanå°†<code>ConfigService</code>ç±»å‹çš„beanä½œä¸ºæˆå‘˜å˜é‡ï¼Œ<code>ConfigService</code>æ˜¯nacoså®˜æ–¹æä¾›çš„apiï¼Œå½“<code>nacosDataChangedListener</code>ç›‘å¬åˆ°äº‹ä»¶æ—¶ï¼Œè¿›è¡Œå›è°ƒæ“ä½œï¼Œå¯ä»¥é€šè¿‡è¯¥apiç›´æ¥ä¸nacosæœåŠ¡å™¨äº¤äº’ï¼Œä¿®æ”¹é…ç½®ã€‚</li><li>ç”Ÿæˆ<code>NacosDataInit</code>ç±»å‹çš„beanï¼Œ<code>nacosDataInit</code>ï¼Œè¿™ä¸ªbeanå°†bean<code>configService</code>å’Œbean<code>syncDataService</code>ä½œä¸ºæˆå‘˜å˜é‡ï¼Œè°ƒç”¨<code>Nacos</code>çš„api <code>configService</code>åˆ¤æ–­é…ç½®æ˜¯å¦æœªåˆå§‹åŒ–ï¼Œæœªåˆå§‹åŒ–åˆ™è°ƒç”¨<code>syncDataService</code>è¿›è¡Œåˆ·æ–°æ“ä½œï¼Œå°†åœ¨ä¸‹æ–‡è¯¦è¿°ã€‚
æ ¹æ®ä¸Šæ–‡æ‰€è¿°ï¼Œåœ¨äº‹ä»¶å¤„ç†æ–¹æ³•<code>onApplicationEvent()</code>ä¸­ï¼Œä¼šè§¦å‘ç›¸åº”çš„<code>listener</code>çš„æ“ä½œã€‚åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œæ˜¯å¯¹ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæ•°æ®åŒæ­¥é‡‡ç”¨çš„æ˜¯<code>nacos</code>ï¼Œæ‰€ä»¥ï¼Œä»£ç ä¼šè¿›å…¥åˆ°<code>NacosDataChangedListener</code>è¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    //DataChangedEventDispatcher.java</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // åœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œä¼šè¿›å…¥åˆ°NacosDataChangedListenerè¿›è¡Œé€‰æ‹©å™¨æ•°æ®å˜æ›´å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-nacosæ•°æ®å˜æ›´ç›‘å¬å™¨"></a>2.4 Nacosæ•°æ®å˜æ›´ç›‘å¬å™¨<a class="hash-link" href="#24-nacosæ•°æ®å˜æ›´ç›‘å¬å™¨" title="Direct link to heading">#</a></h4><ul><li><p>NacosDataChangedListener.onSelectorChanged()</p><p>åœ¨<code>onSelectorChanged()</code>æ–¹æ³•ä¸­ï¼Œåˆ¤æ–­æ“ä½œç±»å‹ï¼Œæ˜¯åˆ·æ–°åŒæ­¥è¿˜æ˜¯æ›´æ–°æˆ–åˆ›å»ºåŒæ­¥ã€‚æ ¹æ®å½“å‰é€‰æ‹©å™¨æ•°æ®ä¿¡æ¯åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨<code>etcd</code>ä¸­ã€‚</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Use nacos to push data changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // é€‰æ‹©å™¨ä¿¡æ¯å‘ç”Ÿæ”¹å˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateSelectorMap(getConfig(NacosPathConstants.SELECTOR_DATA_ID));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case DELETE:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case REFRESH:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case MYSELF:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SELECTOR_MAP.keySet().removeAll(SELECTOR_MAP.keySet());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changed.forEach(selector -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;SelectorData&gt; ls = SELECTOR_MAP</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .getOrDefault(selector.getPluginName(), new ArrayList&lt;&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .stream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .filter(s -&gt; !s.getId().equals(selector.getId()))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .sorted(SELECTOR_DATA_COMPARATOR)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ls.add(selector);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    SELECTOR_MAP.put(selector.getPluginName(), ls);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishConfig(NacosPathConstants.SELECTOR_DATA_ID, SELECTOR_MAP);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™éƒ¨åˆ†æ˜¯æ ¸å¿ƒã€‚<code>changed</code>è¡¨ç¤ºéœ€æ›´æ–°çš„<code>SelectorData</code>åˆ—è¡¨ï¼Œ<code>eventType</code>è¡¨ç¤ºäº‹ä»¶ç±»å‹ã€‚<code>SELECTOR_MAP</code>çš„ç±»å‹æ˜¯<code>ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt;</code>ï¼Œè¯¥mapçš„keyä¸ºselectoræ‰€å±çš„pluginçš„åç§°ï¼Œvalueä¸ºè¯¥pluginä¸‹çš„selectoråˆ—è¡¨ã€‚<code>NacosPathConstants.SELECTOR_DATA_ID</code>çš„å€¼ä¸º<code>shenyu.selector.json</code>ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼Œç¬¬ä¸€æ­¥ï¼Œä½¿ç”¨<code>getConfig</code>æ–¹æ³•è°ƒç”¨<code>Nacos</code>çš„apiï¼Œä»<code>Nacos</code>è·å–<code>group</code>ä¸º<code>shenyu.selector.json</code>çš„é…ç½®ä¿¡æ¯ï¼Œ<code>updateSelectorMap</code>æ–¹æ³•ä½¿ç”¨è¿™äº›é…ç½®ä¿¡æ¯æ›´æ–°<code>SELECTOR_MAP</code>ï¼Œè¿™æ ·å°±åŒæ­¥åˆ°äº†<code>Nacos</code>ä¸Šæœ€æ–°çš„selectorä¿¡æ¯ã€‚ç¬¬äºŒæ­¥ï¼Œå†æ ¹æ®äº‹ä»¶ç±»å‹æ¥æ›´æ–°<code>SELECTOR_MAP</code>ï¼Œæœ€åä½¿ç”¨<code>publishConfig</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>Nacos</code>çš„apiï¼Œå°†<code>Nacos</code>ä¸Šï¼Œ<code>group</code>ä¸º<code>shenyu.selector.json</code>çš„é…ç½®è¿›è¡Œå…¨é‡æ›¿æ¢ã€‚</p><p>åªè¦å°†å˜åŠ¨çš„æ•°æ®æ­£ç¡®å†™å…¥åˆ°<code>Nacos</code>ä¸Šï¼Œ<code>admin</code>è¿™è¾¹çš„æ“ä½œå°±æ‰§è¡Œå®Œæˆäº†ã€‚</p><p>åœ¨æˆ‘ä»¬å½“å‰çš„æ¡ˆä¾‹ä¸­ï¼Œå¯¹<code>Divide</code>æ’ä»¶ä¸­çš„ä¸€æ¡é€‰æ‹©å™¨æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå°†æƒé‡æ›´æ–°ä¸º90ï¼Œå°±ä¼šå¯¹å›¾ä¸­çš„ç‰¹å®šèŠ‚ç‚¹æ›´æ–°ã€‚</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>æˆ‘ä»¬ç”¨æ—¶åºå›¾å°†ä¸Šé¢çš„æ›´æ–°æµç¨‹ä¸²è”èµ·æ¥ã€‚</p><p><img src="/zh/assets/images/nacos-sync-sequence-admin-zh-73003e7cb52938c5528bbfcc58adfc17.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-ç½‘å…³æ•°æ®åŒæ­¥"></a>3. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#3-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>å‡è®¾<code>ShenYu</code>ç½‘å…³å·²ç»åœ¨æ­£å¸¸è¿è¡Œï¼Œä½¿ç”¨çš„æ•°æ®åŒæ­¥æ–¹å¼ä¹Ÿæ˜¯<code>nacos</code>ã€‚é‚£ä¹ˆå½“åœ¨<code>admin</code>ç«¯æ›´æ–°é€‰æ‹©å™¨æ•°æ®åï¼Œå¹¶ä¸”å‘<code>nacos</code>å‘é€äº†å˜æ›´çš„æ•°æ®ï¼Œé‚£ç½‘å…³æ˜¯å¦‚ä½•æ¥æ”¶å¹¶å¤„ç†æ•°æ®çš„å‘¢ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±ç»§ç»­è¿›è¡Œæºç åˆ†æï¼Œä¸€æ¢ç©¶ç«Ÿã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-nacossyncdataserviceæ¥æ”¶æ•°æ®"></a>3.1 <code>NacosSyncDataService</code>æ¥æ”¶æ•°æ®<a class="hash-link" href="#31-nacossyncdataserviceæ¥æ”¶æ•°æ®" title="Direct link to heading">#</a></h4><p>ç½‘å…³æ˜¯é€šè¿‡<code>NacosSyncDataService</code>å¯¹<code>nacos</code>è¿›è¡Œç›‘å¬å¹¶è·å–æ•°æ®æ›´æ–°çš„ï¼Œä½†æ˜¯åœ¨è¿™éƒ¨åˆ†å†…å®¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<code>NacosSyncDataService</code>ç±»å‹çš„beanæ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚ç­”æ¡ˆæ˜¯åœ¨Springé…ç½®ç±»<code>NacosSyncDataConfiguration</code>ä¸­å®šä¹‰çš„ã€‚æˆ‘ä»¬çœ‹åˆ°<code>NacosSyncDataConfiguration</code>ç±»ä¸Šçš„æ³¨è§£ï¼Œ<code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</code>ï¼Œè¿™ä¸ªæ³¨è§£æˆ‘ä»¬åœ¨ä¸Šæ–‡å¯¹<code>ShenYu</code>çš„Adminç«¯ä¸­çš„<code>NacosListener</code>ç±»è¿›è¡Œåˆ†ææ—¶çœ‹åˆ°è¿‡ï¼Œæ˜¯ä¸€ä¸ªå±æ€§æ¡ä»¶åˆ¤æ–­ï¼Œæ»¡è¶³æ¡ä»¶ï¼Œè¯¥é…ç½®ç±»æ‰ä¼šç”Ÿæ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬åœ¨<code>Shenyu</code>ç½‘å…³ç«¯æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±è¡¨ç¤º<code>Shenyu</code>ç½‘å…³ç«¯é‡‡ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œ<code>NacosSyncDataConfiguration</code>è¿™ä¸ªé…ç½®ç±»ç”Ÿæ•ˆã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     nacos:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:8848</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Nacos sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(NacosSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.nacos&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOGGER = LoggerFactory.getLogger(NacosSyncDataConfiguration.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService     the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber the plugin subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers   the meta subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers   the auth subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Nacos config service config service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param nacosConfig the nacos config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @throws Exception the exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigService nacosConfigService(final NacosConfig nacosConfig) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties properties = new Properties();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (nacosConfig.getAcm() != null &amp;&amp; nacosConfig.getAcm().isEnabled()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ENDPOINT, nacosConfig.getAcm().getEndpoint());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getAcm().getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.ACCESS_KEY, nacosConfig.getAcm().getAccessKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SECRET_KEY, nacosConfig.getAcm().getSecretKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            properties.put(PropertyKeyConst.SERVER_ADDR, nacosConfig.getUrl());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.isNotBlank(nacosConfig.getNamespace())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.NAMESPACE, nacosConfig.getNamespace());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getUsername() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.USERNAME, nacosConfig.getUsername());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (nacosConfig.getPassword() != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                properties.put(PropertyKeyConst.PASSWORD, nacosConfig.getPassword());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return NacosFactory.createConfigService(properties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http config http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.nacos&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosConfig nacosConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹ä¸Šé¢ä»£ç ä¸­<code>nacosSyncDataService</code>è¿™ä¸ªbeançš„ç”Ÿæˆï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public SyncDataService nacosSyncDataService(final ObjectProvider&lt;ConfigService&gt; configService, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LOGGER.info(&quot;you use nacos sync shenyu data.......&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new NacosSyncDataService(configService.getIfAvailable(), pluginSubscriber.getIfAvailable(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æ˜¯ç›´æ¥è°ƒç”¨<code>NacosSyncDataService</code>çš„æ„é€ æ–¹æ³•newäº†ä¸€ä¸ªè¯¥ç±»å‹çš„å¯¹è±¡ã€‚æˆ‘ä»¬ç»§ç»­çœ‹æ„é€ æ–¹æ³•ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public NacosSyncDataService(final ConfigService configService, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(configService, pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.PLUGIN_DATA_ID, this::updatePluginMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.SELECTOR_DATA_ID, this::updateSelectorMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.RULE_DATA_ID, this::updateRuleMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.META_DATA_ID, this::updateMetaDataMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData(NacosPathConstants.AUTH_DATA_ID, this::updateAuthMap);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void watcherData(final String dataId, final OnChange oc) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Listener listener = new Listener() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void receiveConfigInfo(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                oc.change(configInfo);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Executor getExecutor() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        oc.change(getConfigAndSignListener(dataId, listener));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        LISTENERS.computeIfAbsent(dataId, key -&gt; new ArrayList&lt;&gt;()).add(listener);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>start</code>æ–¹æ³•ï¼Œå¹¶ä¸”é€šè¿‡<code>watcherData</code>æ–¹æ³•åˆ›å»ºäº†ç›‘å¬å™¨ï¼Œå¹¶ä¸”å…³è”äº†å›è°ƒå‡½æ•°ocï¼Œç”±äºæˆ‘ä»¬æ­£åœ¨åˆ†æselectorç±»å‹ç»„ä»¶çš„å˜åŒ–ï¼Œå¯¹åº”çš„å›è°ƒå‡½æ•°æ˜¯<code>updateSelectorMap</code>ã€‚è¿™ä¸ªå›è°ƒå‡½æ•°ç”¨äºå¤„ç†æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-å¤„ç†æ•°æ®"></a>3.2 å¤„ç†æ•°æ®<a class="hash-link" href="#32-å¤„ç†æ•°æ®" title="Direct link to heading">#</a></h4><ul><li>NacosCacheHandler.updateSelectorMap()</li></ul><p>ç»è¿‡åˆ¤ç©ºé€»è¾‘ä¹‹åï¼Œç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„æ“ä½œåˆäº¤ç»™äº†<code>PluginDataSubscriber</code>å¤„ç†ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateSelectorMap(final String configInfo) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; selectorDataList = GsonUtils.getInstance().toObjectMapList(configInfo, SelectorData.class).values().stream().flatMap(Collection::stream).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorDataList.forEach(selectorData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.unSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                subscriber.onSelectorSubscribe(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (JsonParseException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;sync selector data have error:&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåªæœ‰ä¸€ä¸ª<code>CommonPluginDataSubscriber</code>å®ç°ç±»ï¼Œè´Ÿè´£å¤„ç†æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™æ•°æ®ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…"></a>3.3 é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…<a class="hash-link" href="#33-é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>å®ƒæ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>subscribeDataHandler()</code>æ–¹æ³•ã€‚åœ¨æ–¹æ³•ä¸­ï¼Œæ›´å…·æ•°æ®ç±»å‹ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨æˆ–è§„åˆ™ï¼‰ï¼Œæ“ä½œç±»å‹ï¼ˆæ›´æ–°æˆ–åˆ é™¤ï¼‰ï¼Œå»æ‰§è¡Œä¸åŒé€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šç”¨æ’ä»¶æ•°æ®è®¢é˜…è€…ï¼Œè´Ÿè´£å¤„ç†æ‰€æœ‰æ’ä»¶ã€é€‰æ‹©å™¨å’Œè§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Common plugin data subscriber.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // å¤„ç†é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // è®¢é˜…æ•°æ®å¤„ç†å™¨ï¼Œå¤„ç†æ•°æ®çš„æ›´æ–°æˆ–åˆ é™¤</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // åˆ é™¤æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // ä»ç½‘å…³å†…å­˜ç§»é™¤æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜"></a>3.4 æ•°æ®ç¼“å­˜åˆ°å†…å­˜<a class="hash-link" href="#34-æ•°æ®ç¼“å­˜åˆ°å†…å­˜" title="Direct link to heading">#</a></h4><p>é‚£ä¹ˆæ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³å†…å­˜</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸€æ˜¯å°†æ•°æ®ä¿å­˜åˆ°ç½‘å…³çš„å†…å­˜ä¸­ã€‚<code>BaseDataCache</code>æ˜¯æœ€ç»ˆç¼“å­˜æ•°æ®çš„ç±»ï¼Œé€šè¿‡å•ä¾‹æ¨¡å¼å®ç°ã€‚é€‰æ‹©å™¨æ•°æ®å°±å­˜åˆ°äº†<code>SELECTOR_MAP</code>è¿™ä¸ª<code>Map</code>ä¸­ã€‚åœ¨åç»­ä½¿ç”¨çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ä»è¿™é‡Œæ‹¿æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰å˜é‡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ç§æœ‰æ„é€ å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  å…¬å¼€æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    *  ç¼“å­˜é€‰æ‹©å™¨æ•°æ®çš„Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç¼“å­˜é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // æ›´æ–°æ“ä½œï¼Œå…ˆåˆ é™¤å†æ’å…¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // æ–°å¢æ“ä½œï¼Œç›´æ¥æ”¾åˆ°Mapä¸­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>äºŒæ˜¯å¦‚æœæ¯ä¸ªæ’ä»¶è¿˜æœ‰è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆå°±å»å¤„ç†ã€‚  é€šè¿‡<code>idea</code>ç¼–è¾‘å™¨å¯ä»¥çœ‹åˆ°ï¼Œå½“æ–°å¢ä¸€æ¡é€‰æ‹©å™¨åï¼Œæœ‰å¦‚ä¸‹çš„æ’ä»¶è¿˜æœ‰å¤„ç†ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä¸å†å±•å¼€äº†ã€‚</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>ç»è¿‡ä»¥ä¸Šçš„æºç è¿½è¸ªï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…çš„æ¡ˆä¾‹ï¼Œåœ¨<code>admin</code>ç«¯æ–°å¢æ›´æ–°ä¸€æ¡é€‰æ‹©å™¨æ•°æ®ï¼Œå°±å°†<code>nacos</code>æ•°æ®åŒæ­¥çš„æµç¨‹åˆ†ææ¸…æ¥šäº†ã€‚</p><p>æˆ‘ä»¬è¿˜æ˜¯é€šè¿‡æ—¶åºå›¾å°†ç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æµç¨‹ä¸²è”ä¸€ä¸‹ï¼š</p><p><img src="/zh/assets/images/nacos-sync-sequence-gateway-zh-bdc1404f8b15c4ebb82baaa4485660ac.png"></p><p>æ•°æ®åŒæ­¥çš„æµç¨‹å·²ç»åˆ†æå®Œäº†ï¼Œä¸ºäº†ä¸è®©åŒæ­¥æµç¨‹è¢«æ‰“æ–­ï¼Œåœ¨åˆ†æè¿‡ç¨‹ä¸­å°±å¿½ç•¥äº†å…¶ä»–é€»è¾‘ã€‚ç½‘å…³åŒæ­¥æ“ä½œåˆå§‹åŒ–çš„æµç¨‹åœ¨<code>NacosSyncDataService</code>çš„<code>start</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡åˆ†æ<code>ç½‘å…³æ•°æ®åŒæ­¥</code>æ—¶åˆ†æè¿‡äº†ï¼Œä¸‹é¢åˆ†æ<code>Admin</code>çš„åŒæ­¥æ•°æ®åˆå§‹åŒ–ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–"></a>4. AdminåŒæ­¥æ•°æ®åˆå§‹åŒ–<a class="hash-link" href="#4-adminåŒæ­¥æ•°æ®åˆå§‹åŒ–" title="Direct link to heading">#</a></h3><p><code>admin</code>ç«¯ï¼Œ<code>NacosDataInit</code>ç±»å‹çš„beanï¼Œåœ¨<code>NacosListener</code>ä¸­è¿›è¡Œå®šä¹‰å’Œç”Ÿæˆï¼Œå¦‚æœ<code>admin</code>çš„é…ç½®ä¸­æŒ‡å®šäº†ä½¿ç”¨<code>nacos</code>è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œå½“<code>admin</code>å¯åŠ¨åï¼Œä¼šå°†å½“å‰çš„æ•°æ®ä¿¡æ¯å…¨é‡åŒæ­¥åˆ°<code>nacos</code>ä¸­ï¼Œå®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NacosDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger LOG = LoggerFactory.getLogger(NacosDataInit.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ConfigService configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Nacos data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param configService the nacos config service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public NacosDataInit(final ConfigService configService, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.configService = configService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void run(final String... args) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginDataId = NacosPathConstants.PLUGIN_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String authDataId = NacosPathConstants.AUTH_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String metaDataId = NacosPathConstants.META_DATA_ID;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (dataIdNotExist(pluginDataId) &amp;&amp; dataIdNotExist(authDataId) &amp;&amp; dataIdNotExist(metaDataId)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean dataIdNotExist(final String pluginDataId) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String group = NacosPathConstants.GROUP;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long timeout = NacosPathConstants.DEFAULT_TIME_OUT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return configService.getConfig(pluginDataId, group, timeout) == null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (NacosException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            LOG.error(&quot;Get data from nacos error.&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆ¤æ–­<code>nacos</code>ä¸­æ˜¯å¦å­˜åœ¨æ•°æ®ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŒæ­¥ã€‚</p><p><code>NacosDataInit</code>å®ç°äº†<code>CommandLineRunner</code>æ¥å£ã€‚å®ƒæ˜¯<code>springboot</code>æä¾›çš„æ¥å£ï¼Œä¼šåœ¨æ‰€æœ‰ <code>Spring Beans</code>åˆå§‹åŒ–ä¹‹åæ‰§è¡Œ<code>run()</code>æ–¹æ³•ï¼Œå¸¸ç”¨äºé¡¹ç›®ä¸­åˆå§‹åŒ–çš„æ“ä½œã€‚</p><ul><li>SyncDataService.syncAll()</li></ul><p>ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œç„¶åè¿›è¡Œå…¨é‡æ•°æ®åŒæ­¥ï¼Œæ‰€æœ‰çš„è®¤è¯ä¿¡æ¯ã€æ’ä»¶ä¿¡æ¯ã€é€‰æ‹©å™¨ä¿¡æ¯ã€è§„åˆ™ä¿¡æ¯å’Œå…ƒæ•°æ®ä¿¡æ¯ã€‚ä¸»è¦æ˜¯é€šè¿‡<code>eventPublisher</code>å‘å¸ƒåŒæ­¥äº‹ä»¶ã€‚è¿™é‡Œå°±è·Ÿå‰é¢æåˆ°çš„åŒæ­¥é€»è¾‘å°±åˆè”ç³»èµ·æ¥äº†ï¼Œ<code>eventPublisher</code>é€šè¿‡<code>publishEvent()</code>å‘å¸ƒå®Œäº‹ä»¶åï¼Œæœ‰<code>ApplicationListener</code>æ‰§è¡Œäº‹ä»¶å˜æ›´æ“ä½œï¼Œåœ¨<code>ShenYu</code>ä¸­å°±æ˜¯å‰é¢æåˆ°çš„<code>DataChangedEventDispatcher</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // äº‹ä»¶å‘å¸ƒ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡æ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åŒæ­¥å…ƒæ•°æ®ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-æ€»ç»“"></a>5. æ€»ç»“<a class="hash-link" href="#5-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡é€šè¿‡ä¸€ä¸ªå®é™…æ¡ˆä¾‹ï¼Œå¯¹<code>nacos</code>çš„æ•°æ®åŒæ­¥åŸç†è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li>åŸºäº<code>nacos</code>çš„æ•°æ®åŒæ­¥ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>watch</code>æœºåˆ¶å®ç°ï¼›</li><li>é€šè¿‡<code>Spring</code>å®Œæˆäº‹ä»¶å‘å¸ƒå’Œç›‘å¬ï¼›</li><li>é€šè¿‡æŠ½è±¡<code>DataChangedListener</code>æ¥å£ï¼Œæ”¯æŒå¤šç§åŒæ­¥ç­–ç•¥ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼›</li><li>ä½¿ç”¨å•ä¾‹è®¾è®¡æ¨¡å¼å®ç°ç¼“å­˜æ•°æ®ç±»<code>BaseDataCache</code>ï¼›</li><li>é€šè¿‡<code>SpringBoot</code>çš„æ¡ä»¶è£…é…å’Œ<code>starter</code>åŠ è½½æœºåˆ¶å®ç°é…ç½®ç±»çš„åŠ è½½ã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/nacos">nacos</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/Start-SourceCode-Analysis-Start-Demo">Apache ShenYu å¯åŠ¨ç¤ºä¾‹</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-02-20T14:25:01.584Z">2022å¹´2æœˆ20æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars1.githubusercontent.com/u/62384022?v=4" alt="Kunshuai Zhu"></a><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/JooKS-me" target="_blank" rel="noopener noreferrer">Kunshuai Zhu</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡<a class="hash-link" href="#ç¯å¢ƒå‡†å¤‡" title="Direct link to heading">#</a></h3><ul><li>æœ¬åœ°æ­£ç¡®å®‰è£…JDK1.8+</li><li>æœ¬åœ°æ­£ç¡®å®‰è£…Git</li><li>æœ¬åœ°æ­£ç¡®å®‰è£…Maven</li><li>é€‰æ‹©ä¸€æ¬¾å¼€å‘å·¥å…·ï¼Œæ¯”å¦‚IDEA</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æ‹‰å–shenyuä»£ç "></a>æ‹‰å–ShenYuä»£ç <a class="hash-link" href="#æ‹‰å–shenyuä»£ç " title="Direct link to heading">#</a></h3><p>ä½¿ç”¨Gitæ‹‰å–ä»£ç </p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone https://github.com/apache/incubator-shenyu.git</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ç¼–è¯‘ä»£ç "></a>ç¼–è¯‘ä»£ç <a class="hash-link" href="#ç¼–è¯‘ä»£ç " title="Direct link to heading">#</a></h3><p>ä½¿ç”¨Mavenè¿›è¡Œç¼–è¯‘</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><pre tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin class-name">cd</span><span class="token plain"> incubator-shenyu</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mvn clean </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> -Dmaven.javadoc.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -B -Drat.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -Djacoco.skip</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true -DskipITs -DskipTests</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨ç½‘å…³æœåŠ¡"></a>å¯åŠ¨ç½‘å…³æœåŠ¡<a class="hash-link" href="#å¯åŠ¨ç½‘å…³æœåŠ¡" title="Direct link to heading">#</a></h3><p>ä½¿ç”¨å¼€å‘å·¥å…·ï¼Œä»¥IDEAä¸ºä¾‹ã€‚</p><p>å¯åŠ¨ <code>shenyu-admin</code> æ§åˆ¶å°ï¼ˆé»˜è®¤ä½¿ç”¨H2æ•°æ®åº“ï¼‰</p><p><img alt="start-demo-admin" src="/zh/assets/images/start-demo-admin-debdd1ee5e979a4892f26e4d54572ead.png"></p><p>å¯åŠ¨ <code>shenyu-bootstrap</code></p><p><img alt="start-demo-bootstrap" src="/zh/assets/images/start-demo-bootstrap-cafa4d22b0d69bb6ee82c01e7b45d239.png"></p><blockquote><p>åˆ°è¿™ä¸€æ­¥ï¼Œshenyuç½‘å…³å·²ç»å¯åŠ¨ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®adminæ§åˆ¶å°ï¼š<a href="http://localhost:9095/" target="_blank" rel="noopener noreferrer">http://localhost:9095/</a></p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="å¯åŠ¨åº”ç”¨æœåŠ¡"></a>å¯åŠ¨åº”ç”¨æœåŠ¡<a class="hash-link" href="#å¯åŠ¨åº”ç”¨æœåŠ¡" title="Direct link to heading">#</a></h3><p>Apache ShenYuæä¾›äº†Httpã€Dubboã€SpringCloudç­‰åº”ç”¨æ¥å…¥shenyuç½‘å…³çš„æ ·ä¾‹ï¼Œä½äº <code>shenyu-example</code> æ¨¡å—ï¼Œè¿™é‡Œä»¥HttpæœåŠ¡ä¸ºä¾‹ã€‚</p><p>è‹¥ <code>shenyu-example</code> æœªè¢«IDEAæ ‡è®°ä¸ºMavené¡¹ç›®ï¼Œå¯ä»¥å³é”®ç‚¹å‡» <code>shenyu-example</code> ç›®å½•ä¸‹çš„ <code>pom.xml</code> æ–‡ä»¶ï¼Œå°†å…¶æ·»åŠ ä¸ºMavené¡¹ç›®ã€‚</p><p><img alt="start-demo-maven" src="/zh/assets/images/start-demo-maven-a52eeb99414c79d32a127312a5d22d6f.png"></p><p>å¯åŠ¨ <code>shenyu-examples-http</code>ã€‚</p><p><img alt="start-demo-examples-http" src="/zh/assets/images/start-demo-examples-http-a42235638d82a4be8aeefbb819d419be.png"></p><p>è¿™æ—¶ï¼Œ<code>shenyu-examples-http</code> ä¼šè‡ªåŠ¨æŠŠåŠ  <code>@ShenyuSpringMvcClient</code> æ³¨è§£çš„æ¥å£æ–¹æ³•ï¼Œä»¥åŠapplication.ymlä¸­çš„ç›¸å…³é…ç½®æ³¨å†Œåˆ°ç½‘å…³ã€‚æˆ‘ä»¬æ‰“å¼€adminæ§åˆ¶å°ï¼Œå³å¯åœ¨divideã€context_pathä¸­çœ‹åˆ°ç›¸å…³é…ç½®ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="æµ‹è¯•httpè¯·æ±‚"></a>æµ‹è¯•Httpè¯·æ±‚<a class="hash-link" href="#æµ‹è¯•httpè¯·æ±‚" title="Direct link to heading">#</a></h3><p>ä¸‹é¢ä½¿ç”¨<code>postman</code>æ¨¡æ‹Ÿ<code>http</code>çš„æ–¹å¼æ¥è¯·æ±‚ä½ çš„<code>http</code>æœåŠ¡ï¼š</p><p><img alt="start-demo-post-http" src="/zh/assets/images/start-demo-post-http-a7e95883d3147d67e6080236d980d72b.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="ä½¿ç”¨æ›´å¤šæ’ä»¶"></a>ä½¿ç”¨æ›´å¤šæ’ä»¶<a class="hash-link" href="#ä½¿ç”¨æ›´å¤šæ’ä»¶" title="Direct link to heading">#</a></h3><p>æˆ‘ä»¬å¯ä»¥å‚è€ƒ <a href="/zh/blog/docs/index">å®˜æ–¹æ–‡æ¡£</a>ï¼Œæ¥ä½¿ç”¨å…¶ä»–çš„æ’ä»¶ã€‚</p><p>è¿™é‡Œä»¥ä½¿ç”¨ param-mapping æ’ä»¶ä¸ºä¾‹ã€‚</p><p>åœ¨ <code>BasicConfig -&gt; Plugin</code> ç¼–è¾‘ param-mapping æ’ä»¶ï¼Œè®¾ç½® <code>status</code>ã€‚</p><p><img alt="start-demo-plugin" src="/zh/assets/images/start-demo-plugin-8525f3812e42bed70e28ce23540069b7.png"></p><p>åœ¨ <code>PluginList -&gt; http process</code> é…ç½®é€‰æ‹©å™¨å’Œè§„åˆ™ã€‚</p><p><img alt="start-demo-selector" src="/zh/assets/images/start-demo-selector-98b0b1ae460bdbed17edc40ab730a182.png"></p><p><img alt="start-demo-rules" src="/zh/assets/images/start-demo-rules-581013f9d7f0f9996b01aab85efcc8e7.png"></p><p>ç„¶åä½¿ç”¨ <code>postman</code> å‘ <code>/http/test/payment</code> å‘èµ·httpè¯·æ±‚ã€‚</p><p><img alt="start-demo-post-param-mapping" src="/zh/assets/images/start-demo-post-param-mapping-d5d632dc96eb1f0080c451820e8f7df4.png"></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/DataSync-SourceCode-Analysis-Http-Data-Sync">Httpé•¿è½®è¯¢æ•°æ®åŒæ­¥æºç åˆ†æ</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-02-20T14:25:01.580Z">2022å¹´2æœˆ20æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/midnight2104" target="_blank" rel="noopener noreferrer">midnight2104</a></div><small class="avatar__subtitle">Apache ShenYu Committer</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„ï¼Œé«˜æ€§èƒ½çš„ï¼Œè·¨è¯­è¨€çš„ï¼Œå“åº”å¼çš„ <code>API</code> ç½‘å…³ã€‚</p></blockquote><p>åœ¨<code>ShenYu</code>ç½‘å…³ä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯æŒ‡ï¼Œå½“åœ¨åå°ç®¡ç†ç³»ç»Ÿä¸­ï¼Œæ•°æ®å‘é€äº†æ›´æ–°åï¼Œå¦‚ä½•å°†æ›´æ–°çš„æ•°æ®åŒæ­¥åˆ°ç½‘å…³ä¸­ã€‚<code>Apache ShenYu</code> ç½‘å…³å½“å‰æ”¯æŒ<code>ZooKeeper</code>ã€<code>WebSocket</code>ã€<code>Httpé•¿è½®è¯¢</code>ã€<code>Nacos</code> ã€<code>Etcd</code> å’Œ <code>Consul</code> è¿›è¡Œæ•°æ®åŒæ­¥ã€‚æœ¬æ–‡çš„ä¸»è¦å†…å®¹æ˜¯åŸºäº<code>Httpé•¿è½®è¯¢</code>çš„æ•°æ®åŒæ­¥æºç åˆ†æã€‚</p><blockquote><p>æœ¬æ–‡åŸºäº<code>shenyu-2.4.0</code>ç‰ˆæœ¬è¿›è¡Œæºç åˆ†æï¼Œå®˜ç½‘çš„ä»‹ç»è¯·å‚è€ƒ <a href="https://shenyu.apache.org/zh/docs/design/data-sync" target="_blank" rel="noopener noreferrer">æ•°æ®åŒæ­¥åŸç†</a> ã€‚</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-httpé•¿è½®è¯¢"></a>1. Httpé•¿è½®è¯¢<a class="hash-link" href="#1-httpé•¿è½®è¯¢" title="Direct link to heading">#</a></h3><p>è¿™é‡Œç›´æ¥å¼•ç”¨å®˜ç½‘çš„ç›¸å…³æè¿°ï¼š</p><blockquote><p><code>Zookeeper</code>å’Œ<code>WebSocket</code> æ•°æ®åŒæ­¥çš„æœºåˆ¶æ¯”è¾ƒç®€å•ï¼Œè€Œ <code>Httpé•¿è½®è¯¢</code>åˆ™æ¯”è¾ƒå¤æ‚ã€‚ <code>Apache ShenYu</code> å€Ÿé‰´äº† <code>Apollo</code>ã€<code>Nacos</code> çš„è®¾è®¡æ€æƒ³ï¼Œå–å…¶ç²¾åï¼Œè‡ªå·±å®ç°äº† <code>Httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚æ³¨æ„ï¼Œè¿™é‡Œå¹¶éä¼ ç»Ÿçš„ <code>ajax</code> é•¿è½®è¯¢ï¼</p></blockquote><p><img src="/zh/assets/images/http-long-polling-zh-bc8bd8fe6c4aa883a959f59fce05078a.png"></p><p><code>Httpé•¿è½®è¯¢</code> æœºåˆ¶å¦‚ä¸Šæ‰€ç¤ºï¼Œ<code>Apache ShenYu</code>ç½‘å…³ä¸»åŠ¨è¯·æ±‚ <code>shenyu-admin</code> çš„é…ç½®æœåŠ¡ï¼Œè¯»å–è¶…æ—¶æ—¶é—´ä¸º <code>90s</code>ï¼Œæ„å‘³ç€ç½‘å…³å±‚è¯·æ±‚é…ç½®æœåŠ¡æœ€å¤šä¼šç­‰å¾… <code>90s</code>ï¼Œè¿™æ ·ä¾¿äº <code>shenyu-admin</code> é…ç½®æœåŠ¡åŠæ—¶å“åº”å˜æ›´æ•°æ®ï¼Œä»è€Œå®ç°å‡†å®æ—¶æ¨é€ã€‚</p><p><code>Httpé•¿è½®è¯¢</code> æœºåˆ¶æ˜¯ç”±ç½‘å…³ä¸»åŠ¨è¯·æ±‚ <code>shenyu-admin</code> ï¼Œæ‰€ä»¥è¿™æ¬¡çš„æºç åˆ†æï¼Œæˆ‘ä»¬ä»ç½‘å…³è¿™ä¸€ä¾§å¼€å§‹ã€‚</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-ç½‘å…³æ•°æ®åŒæ­¥"></a>2. ç½‘å…³æ•°æ®åŒæ­¥<a class="hash-link" href="#2-ç½‘å…³æ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-åŠ è½½é…ç½®"></a>2.1 åŠ è½½é…ç½®<a class="hash-link" href="#21-åŠ è½½é…ç½®" title="Direct link to heading">#</a></h4><p><code>Httpé•¿è½®è¯¢</code> æ•°æ®åŒæ­¥é…ç½®çš„åŠ è½½æ˜¯é€šè¿‡<code>spring boot</code>çš„<code>starter</code>æœºåˆ¶ï¼Œå½“æˆ‘ä»¬å¼•å…¥ç›¸å…³ä¾èµ–å’Œåœ¨é…ç½®æ–‡ä»¶ä¸­æœ‰å¦‚ä¸‹é…ç½®æ—¶ï¼Œå°±ä¼šåŠ è½½ã€‚</p><p>åœ¨<code>pom</code>æ–‡ä»¶ä¸­å¼•å…¥ä¾èµ–ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI xm"><pre tabindex="0" class="prism-code language-xm codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;!--shenyu data sync start use http--&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;dependency&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;groupId&gt;org.apache.shenyu&lt;/groupId&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;artifactId&gt;shenyu-spring-boot-starter-sync-data-http&lt;/artifactId&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            &lt;version&gt;${project.version}&lt;/version&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &lt;/dependency&gt;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åœ¨<code>application.yml</code>é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½®ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">9095</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å½“ç½‘å…³å¯åŠ¨æ—¶ï¼Œé…ç½®ç±»<code>HttpSyncDataConfiguration</code>å°±ä¼šæ‰§è¡Œï¼ŒåŠ è½½ç›¸åº”çš„<code>Bean</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Http sync data configuration for spring boot.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnClass(HttpSyncDataService.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http sync data service.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ›å»º HttpSyncDataService </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param httpConfig         httpçš„é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginSubscriber   æ’ä»¶æ•°æ®è®¢é˜…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaSubscribers    å…ƒæ•°æ®è®¢é˜…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authSubscribers    è®¤è¯æ•°æ®è®¢é˜…</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SyncDataService httpSyncDataService(final ObjectProvider&lt;HttpConfig&gt; httpConfig, final ObjectProvider&lt;PluginDataSubscriber&gt; pluginSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                           final ObjectProvider&lt;List&lt;MetaDataSubscriber&gt;&gt; metaSubscribers, final ObjectProvider&lt;List&lt;AuthDataSubscriber&gt;&gt; authSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;you use http long pull sync shenyu data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new HttpSyncDataService(Objects.requireNonNull(httpConfig.getIfAvailable()), Objects.requireNonNull(pluginSubscriber.getIfAvailable()),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                metaSubscribers.getIfAvailable(Collections::emptyList), authSubscribers.getIfAvailable(Collections::emptyList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Http config http config.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è¯»å–httpçš„é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the http config</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConfigurationProperties(prefix = &quot;shenyu.sync.http&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpConfig httpConfig() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new HttpConfig();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>HttpSyncDataConfiguration</code>æ˜¯<code>Httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥çš„é…ç½®ç±»ï¼Œè´Ÿè´£åˆ›å»º<code>HttpSyncDataService</code>ï¼ˆè´Ÿè´£<code>http</code>æ•°æ®åŒæ­¥çš„å…·ä½“å®ç°ï¼‰å’Œ<code>HttpConfig</code>ï¼ˆ<code>admin</code>å±æ€§é…ç½®ï¼‰ã€‚å®ƒçš„æ³¨è§£å¦‚ä¸‹ï¼š</p><ul><li><code>@Configuration</code>ï¼šè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé…ç½®ç±»ï¼›</li><li><code>@ConditionalOnClass(HttpSyncDataService.class)</code>ï¼šæ¡ä»¶æ³¨è§£ï¼Œè¡¨ç¤ºè¦æœ‰<code>HttpSyncDataService</code>è¿™ä¸ªç±»ï¼›</li><li><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.http&quot;, name = &quot;url&quot;)</code>ï¼šæ¡ä»¶æ³¨è§£ï¼Œè¦æœ‰<code>shenyu.sync.http.url</code>è¿™ä¸ªå±æ€§é…ç½®ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-å±æ€§åˆå§‹åŒ–"></a>2.2 å±æ€§åˆå§‹åŒ–<a class="hash-link" href="#22-å±æ€§åˆå§‹åŒ–" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService</li></ul><p>åœ¨<code>HttpSyncDataService</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œå®Œæˆå±æ€§åˆå§‹åŒ–ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class HttpSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥äº†å±æ€§å­—æ®µ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpSyncDataService(final HttpConfig httpConfig, final PluginDataSubscriber pluginDataSubscriber, final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1.åˆ›å»ºæ•°æ®å¤„ç†å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.factory = new DataRefreshFactory(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2.è·å–adminå±æ€§é…ç½®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.httpConfig = httpConfig;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // shenyu-adminçš„urlï¼Œ å¤šä¸ªç”¨é€—å·(,)åˆ†å‰²</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.serverList = Lists.newArrayList(Splitter.on(&quot;,&quot;).split(httpConfig.getUrl()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3.åˆ›å»ºhttpClientï¼Œç”¨äºå‘adminå‘èµ·è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.httpClient = createRestTemplate();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4.å¼€å§‹æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.start();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä¸Šé¢ä»£ç ä¸­çœç•¥äº†å…¶ä»–å‡½æ•°å’Œç›¸å…³å­—æ®µï¼Œåœ¨æ„é€ å‡½æ•°ä¸­å®Œæˆå±æ€§çš„åˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯ï¼š</p><ul><li><p>åˆ›å»ºæ•°æ®å¤„ç†å™¨ï¼Œç”¨äºåç»­ç¼“å­˜å„ç§ç±»å‹çš„æ•°æ®ï¼ˆæ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œè®¤è¯æ•°æ®ï¼‰ï¼›</p></li><li><p>è·å–<code>admin</code>å±æ€§é…ç½®ï¼Œä¸»è¦æ˜¯è·å–<code>admin</code>çš„<code>url</code>ï¼Œ<code>admin</code>æœ‰å¯èƒ½æ˜¯é›†ç¾¤ï¼Œå¤šä¸ªç”¨é€—å·<code>(,)</code>åˆ†å‰²ï¼›</p></li><li><p>åˆ›å»º<code>httpClient</code>ï¼Œä½¿ç”¨çš„æ˜¯<code>RestTemplate</code>ï¼Œç”¨äºå‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼›</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private RestTemplate createRestTemplate() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        OkHttp3ClientHttpRequestFactory factory = new OkHttp3ClientHttpRequestFactory();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å»ºç«‹è¿æ¥è¶…æ—¶æ—¶é—´ä¸º 10s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setConnectTimeout((int) this.connectionTimeout.toMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç½‘å…³ä¸»åŠ¨è¯·æ±‚ shenyu-admin çš„é…ç½®æœåŠ¡ï¼Œè¯»å–è¶…æ—¶æ—¶é—´ä¸º 90s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setReadTimeout((int) HttpConstants.CLIENT_POLLING_READ_TIMEOUT);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new RestTemplate(factory);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>å¼€å§‹æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡ã€‚</p></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-å¼€å§‹é•¿è½®è¯¢"></a>2.3 å¼€å§‹é•¿è½®è¯¢<a class="hash-link" href="#23-å¼€å§‹é•¿è½®è¯¢" title="Direct link to heading">#</a></h4><ul><li>HttpSyncDataService#start()</li></ul><p>åœ¨<code>start()</code>æ–¹æ³•ä¸­ï¼Œå¹²äº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€ä¸ªæ˜¯è·å–å…¨é‡æ•°æ®ï¼Œå³è¯·æ±‚<code>admin</code>ç«¯è·å–æ‰€æœ‰éœ€è¦åŒæ­¥çš„æ•°æ®ï¼Œç„¶åå°†è·å–åˆ°çš„æ•°æ®ç¼“å­˜åˆ°ç½‘å…³å†…å­˜ä¸­ã€‚å¦ä¸€ä¸ªæ˜¯å¼€å¯å¤šçº¿ç¨‹æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åªåˆå§‹åŒ–ä¸€æ¬¡ï¼Œé€šè¿‡åŸå­ç±»å®ç°ã€‚ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        RUNNING = new AtomicBoolean(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It could be initialized multiple times, so you need to control that.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch all group configs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆæ¬¡å¯åŠ¨ï¼Œè·å–å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¸€ä¸ªåå°æœåŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // start long polling, each server creates a thread to listen for changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¼€å§‹é•¿è½®è¯¢ï¼Œä¸€ä¸ªadminæœåŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨äºæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="231-è·å–å…¨é‡æ•°æ®"></a>2.3.1 è·å–å…¨é‡æ•°æ®<a class="hash-link" href="#231-è·å–å…¨é‡æ•°æ®" title="Direct link to heading">#</a></h5><ul><li>HttpSyncDataService#fetchGroupConfig()</li></ul><p><code>ShenYu</code>å°†æ‰€æœ‰éœ€è¦åŒæ­¥çš„æ•°æ®è¿›è¡Œäº†åˆ†ç»„ï¼Œä¸€å…±æœ‰5ç§æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯æ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®å’Œè®¤è¯æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public enum ConfigGroupEnum {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    APP_AUTH, // è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    PLUGIN, //æ’ä»¶</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    RULE, // è§„åˆ™</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    SELECTOR, // é€‰æ‹©å™¨</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    META_DATA; // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>admin</code>æœ‰å¯èƒ½æ˜¯é›†ç¾¤ï¼Œè¿™é‡Œé€šè¿‡å¾ªç¯çš„æ–¹å¼å‘æ¯ä¸ª<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œæœ‰ä¸€ä¸ªæ‰§è¡ŒæˆåŠŸäº†ï¼Œé‚£ä¹ˆå‘<code>admin</code>è·å–å…¨é‡æ•°æ®å¹¶ç¼“å­˜åˆ°ç½‘å…³çš„æ“ä½œå°±æ‰§è¡ŒæˆåŠŸã€‚å¦‚æœå‡ºç°äº†å¼‚å¸¸ï¼Œå°±å‘ä¸‹ä¸€ä¸ª<code>admin</code>å‘èµ·è¯·æ±‚ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void fetchGroupConfig(final ConfigGroupEnum... groups) throws ShenyuException {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // adminæœ‰å¯èƒ½æ˜¯é›†ç¾¤ï¼Œè¿™é‡Œé€šè¿‡å¾ªç¯çš„æ–¹å¼å‘æ¯ä¸ªadminå‘èµ·è¯·æ±‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int index = 0; index &lt; this.serverList.size(); index++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String server = serverList.get(index);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœŸæ­£å»æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.doFetchGroupConfig(server, groups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æœ‰ä¸€ä¸ªæˆåŠŸï¼Œå°±æˆåŠŸäº†ï¼Œå¯ä»¥é€€å‡ºå¾ªç¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (ShenyuException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å‡ºç°å¼‚å¸¸ï¼Œå°è¯•æ‰§è¡Œä¸‹ä¸€ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æœ€åä¸€ä¸ªä¹Ÿæ‰§è¡Œå¤±è´¥äº†ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // no available server, throw exception.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (index &gt;= serverList.size() - 1) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw e;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.warn(&quot;fetch config fail, try another one: {}&quot;, serverList.get(index + 1));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doFetchGroupConfig()</li></ul><p>åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ‹¼è£…è¯·æ±‚å‚æ•°ï¼Œç„¶åé€šè¿‡<code>httpClient</code>å‘èµ·è¯·æ±‚ï¼Œåˆ°<code>admin</code>ä¸­è·å–æ•°æ®ï¼Œæœ€åå°†è·å–åˆ°çš„æ•°æ®æ›´æ–°åˆ°ç½‘å…³å†…å­˜ä¸­ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// å‘adminåå°ç®¡ç†ç³»ç»Ÿå‘èµ·è¯·æ±‚ï¼Œè·å–æ‰€æœ‰åŒæ­¥æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">private void doFetchGroupConfig(final String server, final ConfigGroupEnum... groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. æ‹¼è¯·æ±‚å‚æ•°ï¼Œæ‰€æœ‰åˆ†ç»„æšä¸¾ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    StringBuilder params = new StringBuilder();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (ConfigGroupEnum groupKey : groups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        params.append(&quot;groupKeys&quot;).append(&quot;=&quot;).append(groupKey.name()).append(&quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // adminç«¯æä¾›çš„æ¥å£  /configs/fetch</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String url = server + &quot;/configs/fetch?&quot; + StringUtils.removeEnd(params.toString(), &quot;&amp;&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.info(&quot;request configs: [{}]&quot;, url);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    String json = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. å‘èµ·è¯·æ±‚ï¼Œè·å–å˜æ›´æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        json = this.httpClient.getForObject(url, String.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String message = String.format(&quot;fetch config fail from server[%s], %s&quot;, url, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.warn(message);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // update local cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3. æ›´æ–°ç½‘å…³å†…å­˜ä¸­æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean updated = this.updateCacheWithJson(json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æ›´æ–°æˆåŠŸï¼Œæ­¤æ–¹æ³•å°±æ‰§è¡Œå®Œæˆäº†</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (updated) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;get latest configs: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // not updated. it is likely that the current config server has not been updated yet. wait a moment.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.info(&quot;The config of the server[{}] has not been updated or is out of date. Wait for 30s to listen for changes again.&quot;, server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // æœåŠ¡ç«¯æ²¡æœ‰æ•°æ®æ›´æ–°ï¼Œå°±ç­‰30s</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    ThreadUtils.sleep(TimeUnit.SECONDS, 30);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»ä»£ç ä¸­ï¼Œå¯ä»¥çœ‹åˆ° <code>admin</code>ç«¯æä¾›çš„è·å–å…¨é‡æ•°æ®æ¥å£æ˜¯  <code>/configs/fetch</code>ï¼Œè¿™é‡Œå…ˆä¸è¿›ä¸€æ­¥æ·±å…¥ï¼Œæ”¾åœ¨åæ–‡å†åˆ†æã€‚</p><p>è·å–åˆ°<code>admin</code>è¿”å›ç»“æœæ•°æ®ï¼Œå¹¶æˆåŠŸæ›´æ–°ï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•å°±æ‰§è¡Œç»“æŸäº†ã€‚å¦‚æœæ²¡æœ‰æ›´æ–°æˆåŠŸï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æ˜¯æœåŠ¡ç«¯æ²¡æœ‰æ•°æ®æ›´æ–°ï¼Œå°±ç­‰å¾…<code>30s</code>ã€‚</p><p>è¿™é‡Œéœ€è¦æå‰è¯´æ˜ä¸€ä¸‹ï¼Œç½‘å…³åœ¨åˆ¤æ–­æ˜¯å¦æ›´æ–°æˆåŠŸæ—¶ï¼Œæœ‰æ¯”å¯¹æ•°æ®çš„æ“ä½œï¼Œé©¬ä¸Šå°±ä¼šæåˆ°ã€‚</p><ul><li>HttpSyncDataService#updateCacheWithJson()</li></ul><p>æ›´æ–°ç½‘å…³å†…å­˜ä¸­çš„æ•°æ®ã€‚ä½¿ç”¨<code>GSON</code>è¿›è¡Œååºåˆ—åŒ–ï¼Œä»å±æ€§<code>data</code>ä¸­æ‹¿çœŸæ­£çš„æ•°æ®ï¼Œç„¶åäº¤ç»™<code>DataRefreshFactory</code>å»åšæ›´æ–°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean updateCacheWithJson(final String json) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ä½¿ç”¨GSONè¿›è¡Œååºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject jsonObject = GSON.fromJson(json, JsonObject.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject data = jsonObject.getAsJsonObject(&quot;data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // if the config cache will be updated?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory.executor(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataRefreshFactory#executor()</li></ul><p>æ ¹æ®ä¸åŒæ•°æ®ç±»å‹å»æ›´æ–°æ•°æ®ï¼Œè¿”å›æ›´æ–°ç»“æœã€‚è¿™é‡Œé‡‡ç”¨äº†<code>parallelStream()</code>è¿›è¡Œå¹¶è¡Œæ›´æ–°ï¼Œå…·ä½“æ›´æ–°é€»è¾‘äº¤ç»™äº†<code>dataRefresh.refresh()</code>æ–¹æ³•ã€‚åœ¨æ›´æ–°ç»“æœä¸­ï¼Œæœ‰ä¸€ç§æ•°æ®ç±»å‹è¿›è¡Œäº†æ›´æ–°ï¼Œå°±è¡¨ç¤ºæ­¤æ¬¡æ“ä½œå‘ç”Ÿäº†æ›´æ–°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean executor(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å¹¶è¡Œæ›´æ–°æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;Boolean&gt; result = ENUM_MAP.values().parallelStream()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(dataRefresh -&gt; dataRefresh.refresh(data))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æœ‰ä¸€ä¸ªæ›´æ–°å°±è¡¨ç¤ºæ­¤æ¬¡å‘ç”Ÿäº†æ›´æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return result.stream().anyMatch(Boolean.TRUE::equals);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#refresh()</li></ul><p>æ•°æ®æ›´æ–°é€»è¾‘é‡‡ç”¨çš„æ˜¯æ¨¡æ¿æ–¹æ³•è®¾è®¡æ¨¡å¼ï¼Œé€šç”¨æ“ä½œåœ¨æŠ½è±¡æ–¹æ³•ä¸­å®Œæˆï¼Œä¸åŒçš„å®ç°é€»è¾‘ç”±å­ç±»å®Œæˆã€‚5ç§æ•°æ®ç±»å‹å…·ä½“çš„æ›´æ–°é€»è¾‘æœ‰äº›å·®å¼‚ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨é€šç”¨çš„æ›´æ–°é€»è¾‘ï¼Œç±»å›¾å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/data-refresh-a5628c71ea221ffb0a7a45f4ed40ae0e.png"></p><p>åœ¨é€šç”¨çš„<code>refresh()</code>æ–¹æ³•ä¸­ï¼Œè´Ÿè´£æ•°æ®ç±»å‹è½¬æ¢ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå’Œå®é™…çš„æ•°æ®åˆ·æ–°æ“ä½œã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Boolean refresh(final JsonObject data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        boolean updated = false;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ•°æ®ç±»å‹è½¬æ¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonObject jsonObject = convert(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (null != jsonObject) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¾—åˆ°æ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;T&gt; result = fromJson(jsonObject);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // æ˜¯å¦éœ€è¦æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.updateCacheIfNeed(result)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                updated = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // çœŸæ­£çš„æ›´æ–°é€»è¾‘ï¼Œæ•°æ®åˆ·æ–°æ“ä½œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                refresh(result.getData());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return updated;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataRefresh#updateCacheIfNeed()</li></ul><p>æ•°æ®è½¬æ¢çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ ¹æ®ä¸åŒçš„æ•°æ®ç±»å‹è¿›è¡Œè½¬æ¢ï¼Œæˆ‘ä»¬å°±ä¸å†è¿›ä¸€æ­¥è¿½è¸ªäº†ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦éœ€è¦æ›´æ–°çš„é€»è¾‘ã€‚æ–¹æ³•åæ˜¯<code>updateCacheIfNeed()</code>ï¼Œé€šè¿‡æ–¹æ³•é‡è½½å®ç°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// resultæ˜¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected abstract boolean updateCacheIfNeed(ConfigData&lt;T&gt; result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// newValæ˜¯è·å–åˆ°çš„æœ€æ–°çš„å€¼</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// groupEnum æ˜¯å“ªç§æ•°æ®ç±»å‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected boolean updateCacheIfNeed(final ConfigData&lt;T&gt; newVal, final ConfigGroupEnum groupEnum) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆç›´æ¥æ”¾åˆ°cacheä¸­ï¼Œè¿”å› trueï¼Œè¡¨ç¤ºæ­¤æ¬¡è¿›è¡Œäº†æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (GROUP_CACHE.putIfAbsent(groupEnum, newVal) == null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ResultHolder holder = new ResultHolder(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        GROUP_CACHE.merge(groupEnum, newVal, (oldVal, value) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // md5 å€¼ç›¸åŒï¼Œä¸éœ€è¦æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (StringUtils.equals(oldVal.getMd5(), newVal.getMd5())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;Get the same config, the [{}] config cache will not be updated, md5:{}&quot;, groupEnum, oldVal.getMd5());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å½“å‰ç¼“å­˜çš„æ•°æ®ä¿®æ”¹æ—¶é—´å¤§äº æ–°æ¥çš„æ•°æ®ï¼Œä¸éœ€è¦æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // must compare the last update time</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (oldVal.getLastModifyTime() &gt;= newVal.getLastModifyTime()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;Last update time earlier than the current configuration, the [{}] config cache will not be updated&quot;, groupEnum);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return oldVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;update {} config: {}&quot;, groupEnum, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            holder.result = true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return newVal;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return holder.result;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ä»ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸¤ç§æƒ…å†µä¸éœ€è¦æ›´æ–°ï¼š</p><ul><li>ä¸¤ä¸ªçš„æ•°æ®çš„<code>md5</code> å€¼ç›¸åŒï¼Œä¸éœ€è¦æ›´æ–°;</li><li>å½“å‰ç¼“å­˜çš„æ•°æ®ä¿®æ”¹æ—¶é—´å¤§äº æ–°æ¥çš„æ•°æ®ï¼Œä¸éœ€è¦æ›´æ–°ã€‚</li></ul><p>å…¶ä»–æƒ…å†µéœ€è¦æ›´æ–°æ•°æ®ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œï¼Œå°±å°†<code>start()</code> æ–¹æ³•ä¸­åˆæ¬¡å¯åŠ¨ï¼Œè·å–å…¨é‡æ•°æ®çš„é€»è¾‘åˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥æ˜¯é•¿è½®è¯¢çš„æ“ä½œã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘å°†<code>start()</code>æ–¹æ³•å†ç²˜è´´ä¸€æ¬¡ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void start() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // It could be initialized multiple times, so you need to control that.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (RUNNING.compareAndSet(false, true)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch all group configs.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // åˆæ¬¡å¯åŠ¨ï¼Œè·å–å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.fetchGroupConfig(ConfigGroupEnum.values());</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¸€ä¸ªåå°æœåŠ¡ï¼Œä¸€ä¸ªçº¿ç¨‹</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            int threadSize = serverList.size();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // è‡ªå®šä¹‰çº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.executor = new ThreadPoolExecutor(threadSize, threadSize, 60L, TimeUnit.SECONDS,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    new LinkedBlockingQueue&lt;&gt;(),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    ShenyuThreadFactory.create(&quot;http-long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // start long polling, each server creates a thread to listen for changes.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å¼€å§‹é•¿è½®è¯¢ï¼Œä¸€ä¸ªadminæœåŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨äºæ•°æ®åŒæ­¥</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.serverList.forEach(server -&gt; this.executor.execute(new HttpLongPollingTask(server)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;shenyu http long polling was started, executor=[{}]&quot;, executor);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="232-æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡"></a>2.3.2 æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡<a class="hash-link" href="#232-æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡" title="Direct link to heading">#</a></h5><ul><li>HttpLongPollingTask#run()</li></ul><p>é•¿è½®è¯¢ä»»åŠ¡æ˜¯<code>HttpLongPollingTask</code>ï¼Œå®ƒå®ç°äº†<code>Runnable</code>æ¥å£ï¼Œä»»åŠ¡é€»è¾‘åœ¨<code>run()</code>æ–¹æ³•ä¸­ã€‚é€šè¿‡<code>while()</code>å¾ªç¯å®ç°ä¸æ–­æ‰§è¡Œä»»åŠ¡ï¼Œå³é•¿è½®è¯¢ã€‚åœ¨æ¯ä¸€æ¬¡çš„è½®è¯¢ä¸­æœ‰ä¸‰æ¬¡é‡è¯•é€»è¾‘ï¼Œä¸€æ¬¡è½®è¯¢ä»»åŠ¡å¤±è´¥äº†ï¼Œç­‰ <code>5s</code> å†ç»§ç»­ï¼Œ<code>3</code> æ¬¡éƒ½å¤±è´¥äº†ï¼Œç­‰<code>5</code> åˆ†é’Ÿå†è¯•ã€‚</p><p>å¼€å§‹é•¿è½®è¯¢ï¼Œä¸€ä¸ª<code>admin</code>æœåŠ¡ï¼Œåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç”¨äºæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class HttpLongPollingTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private String server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤é‡è¯• 3 æ¬¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private final int retryTimes = 3;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpLongPollingTask(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.server = server;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ä¸€ç›´è½®è¯¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            while (RUNNING.get()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                for (int time = 1; time &lt;= retryTimes; time++) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        doLongPolling(server);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // print warnning log.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        if (time &lt; retryTimes) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            log.warn(&quot;Long polling failed, tried {} times, {} times left, will be suspended for a while! {}&quot;,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    time, retryTimes - time, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            // é•¿è½®è¯¢å¤±è´¥äº†ï¼Œç­‰ 5s å†ç»§ç»­</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            ThreadUtils.sleep(TimeUnit.SECONDS, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // print error, then suspended for a while.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        log.error(&quot;Long polling failed, try again after 5 minutes!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        // 3 æ¬¡éƒ½å¤±è´¥äº†ï¼Œç­‰ 5 åˆ†é’Ÿå†è¯•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        ThreadUtils.sleep(TimeUnit.MINUTES, 5);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.warn(&quot;Stop http long polling.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpSyncDataService#doLongPolling()</li></ul><p>æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘ï¼š</p><ul><li>æ ¹æ®æ•°æ®ç±»å‹ç»„è£…è¯·æ±‚å‚æ•°ï¼š<code>md5</code> å’Œ <code>lastModifyTime</code>ï¼›</li><li>ç»„è£…è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ï¼›</li><li>å‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li><li>æ ¹æ®å‘ç”Ÿå˜æ›´çš„ç»„ï¼Œå†å»è·å–æ•°æ®ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">private void doLongPolling(final String server) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç»„è£…è¯·æ±‚å‚æ•°ï¼šmd5 å’Œ lastModifyTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;(8);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;?&gt; cacheConfig = factory.cacheConfigData(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (cacheConfig != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                String value = String.join(&quot;,&quot;, cacheConfig.getMd5(), String.valueOf(cacheConfig.getLastModifyTime()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                params.put(group.name(), Lists.newArrayList(value));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç»„è£…è¯·æ±‚å¤´å’Œè¯·æ±‚ä½“</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpHeaders headers = new HttpHeaders();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpEntity httpEntity = new HttpEntity(params, headers);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String listenerUrl = server + &quot;/configs/listener&quot;;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.debug(&quot;request listener configs: [{}]&quot;, listenerUrl);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        JsonArray groupJson = null;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //å‘adminå‘èµ·è¯·æ±‚ï¼Œåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //è¿™é‡Œåªæ˜¯åˆ¤æ–­äº†æŸä¸ªç»„æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String json = this.httpClient.postForEntity(listenerUrl, httpEntity, String.class).getBody();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.debug(&quot;listener result: [{}]&quot;, json);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            groupJson = GSON.fromJson(json, JsonObject.class).getAsJsonArray(&quot;data&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (RestClientException e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String message = String.format(&quot;listener configs fail, server:[%s], %s&quot;, server, e.getMessage());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new ShenyuException(message, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ ¹æ®å‘ç”Ÿå˜æ›´çš„ç»„ï¼Œå†å»è·å–æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * å®˜ç½‘å¯¹æ­¤å¤„çš„è§£é‡Šï¼š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * ç½‘å…³æ”¶åˆ°å“åº”ä¿¡æ¯ä¹‹åï¼ŒåªçŸ¥é“æ˜¯å“ªä¸ª Group å‘ç”Ÿäº†é…ç½®å˜æ›´ï¼Œè¿˜éœ€è¦å†æ¬¡è¯·æ±‚è¯¥ Group çš„é…ç½®æ•°æ®ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨ä¸€ä¸ªç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥å°†å˜æ›´çš„æ•°æ®å†™å‡ºï¼Ÿ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™ï¼Œä¹Ÿæ·±å…¥è®¨è®ºè¿‡è¯¥é—®é¢˜ï¼Œå› ä¸º http é•¿è½®è¯¢æœºåˆ¶åªèƒ½ä¿è¯å‡†å®æ—¶ï¼Œå¦‚æœåœ¨ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * æˆ–è€…ç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®ï¼Œå¾ˆæœ‰å¯èƒ½ä¾¿é”™è¿‡äº†æŸä¸ªé…ç½®å˜æ›´çš„æ¨é€ï¼Œå®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬åªå‘ŠçŸ¥æŸä¸ª Group ä¿¡æ¯å‘ç”Ÿäº†å˜æ›´ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * ä¸ªäººç†è§£ï¼š</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * å¦‚æœå°†å˜æ›´æ•°æ®ç›´æ¥å†™å‡ºï¼Œå½“ç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®æ—¶ï¼Œç¬¬ä¸€æ¬¡æ›´æ–°äº†ï¼Œå°†clientç§»é™¤é˜»å¡é˜Ÿåˆ—ï¼Œè¿”å›å“åº”ä¿¡æ¯ç»™ç½‘å…³ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * å¦‚æœè¿™ä¸ªæ—¶å€™è¿›è¡Œäº†ç¬¬äºŒæ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆå½“å‰çš„clientæ˜¯ä¸åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡çš„å˜æ›´å°±ä¼šé”™è¿‡ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œä¹Ÿæ˜¯åŒç†ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * è¿™æ˜¯ä¸€ä¸ªé•¿è½®è¯¢ï¼Œä¸€ä¸ªç½‘å…³ä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼Œå¯èƒ½å­˜åœ¨è€—æ—¶çš„è¿‡ç¨‹ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * å¦‚æœadminæœ‰æ•°æ®å˜æ›´ï¼Œå½“å‰ç½‘å…³clientæ˜¯æ²¡æœ‰åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå°±ä¸åˆ°æ•°æ®ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (groupJson != null) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // fetch group configuration async.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigGroupEnum[] changedGroups = GSON.fromJson(groupJson, ConfigGroupEnum[].class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (ArrayUtils.isNotEmpty(changedGroups)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;Group config changed: {}&quot;, Arrays.toString(changedGroups));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ä¸»åŠ¨å‘adminè·å–å˜æ›´çš„æ•°æ®ï¼Œæ ¹æ®åˆ†ç»„ä¸åŒï¼Œå…¨é‡æ‹¿æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.doFetchGroupConfig(server, changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è¿™é‡Œéœ€è¦ç‰¹åˆ«è§£é‡Šä¸€ç‚¹çš„æ˜¯ï¼šåœ¨é•¿è½®è¯¢ä»»åŠ¡ä¸­ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥æ‹¿åˆ°å˜æ›´çš„æ•°æ®ï¼Ÿè€Œæ˜¯å…ˆåˆ¤æ–­å“ªä¸ªåˆ†ç»„æ•°æ®å‘ç”Ÿäº†å˜æ›´ï¼Œç„¶åå†æ¬¡è¯·æ±‚<code>admin</code>ï¼Œè·å–å˜æ›´æ•°æ®ï¼Ÿ</p><p>å®˜ç½‘å¯¹æ­¤å¤„çš„è§£é‡Šæ˜¯ï¼š</p><blockquote><p>ç½‘å…³æ”¶åˆ°å“åº”ä¿¡æ¯ä¹‹åï¼ŒåªçŸ¥é“æ˜¯å“ªä¸ª Group å‘ç”Ÿäº†é…ç½®å˜æ›´ï¼Œè¿˜éœ€è¦å†æ¬¡è¯·æ±‚è¯¥ Group çš„é…ç½®æ•°æ®ã€‚
è¿™é‡Œå¯èƒ½ä¼šå­˜åœ¨ä¸€ä¸ªç–‘é—®ï¼šä¸ºä»€ä¹ˆä¸æ˜¯ç›´æ¥å°†å˜æ›´çš„æ•°æ®å†™å‡ºï¼Ÿ
æˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™ï¼Œä¹Ÿæ·±å…¥è®¨è®ºè¿‡è¯¥é—®é¢˜ï¼Œå› ä¸º <code>http</code> é•¿è½®è¯¢æœºåˆ¶åªèƒ½ä¿è¯å‡†å®æ—¶ï¼Œå¦‚æœåœ¨ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œ
æˆ–è€…ç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®ï¼Œå¾ˆæœ‰å¯èƒ½ä¾¿é”™è¿‡äº†æŸä¸ªé…ç½®å˜æ›´çš„æ¨é€ï¼Œå®‰å…¨èµ·è§ï¼Œæˆ‘ä»¬åªå‘ŠçŸ¥æŸä¸ª Group ä¿¡æ¯å‘ç”Ÿäº†å˜æ›´ã€‚</p></blockquote><p>ä¸ªäººç†è§£æ˜¯ï¼š</p><blockquote><p>å¦‚æœå°†å˜æ›´æ•°æ®ç›´æ¥å†™å‡ºï¼Œç®¡ç†å‘˜é¢‘ç¹æ›´æ–°é…ç½®æ—¶ï¼Œç¬¬ä¸€æ¬¡æ›´æ–°äº†ï¼Œå°†<code>client</code>ç§»é™¤é˜»å¡é˜Ÿåˆ—ï¼Œè¿”å›å“åº”ä¿¡æ¯ç»™ç½‘å…³ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™è¿›è¡Œäº†ç¬¬äºŒæ¬¡æ›´æ–°ï¼Œé‚£ä¹ˆå½“å‰çš„<code>client</code>æ˜¯ä¸åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡çš„å˜æ›´å°±ä¼šé”™è¿‡ã€‚ç½‘å…³å±‚å¤„ç†ä¸åŠæ—¶ï¼Œä¹Ÿæ˜¯åŒç†ã€‚ è¿™æ˜¯ä¸€ä¸ªé•¿è½®è¯¢ï¼Œä¸€ä¸ªç½‘å…³ä¸€ä¸ªåŒæ­¥çº¿ç¨‹ï¼Œå¯èƒ½å­˜åœ¨è€—æ—¶çš„è¿‡ç¨‹ã€‚å¦‚æœ<code>admin</code>æœ‰æ•°æ®å˜æ›´ï¼Œå½“å‰ç½‘å…³clientæ˜¯æ²¡æœ‰åœ¨é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå°±ä¸åˆ°æ•°æ®ã€‚</p></blockquote><p>æˆ‘ä»¬è¿˜æ²¡æœ‰åˆ†æåˆ°<code>admin</code>ç«¯çš„å¤„ç†é€»è¾‘ï¼Œå…ˆå¤§æ¦‚è¯´ä¸€ä¸‹ã€‚åœ¨<code>admin</code>ç«¯ï¼Œä¼šå°†ç½‘å…³<code>client</code>æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œæœ‰æ•°æ®å˜æ›´ï¼Œç½‘å…³<code>client</code>å°±ä¼šå‡ºé˜Ÿåˆ—ï¼Œå‘é€å˜æ›´æ•°æ®ã€‚æ‰€ä»¥ï¼Œå¦‚æœæœ‰æ•°æ®å˜æ›´æ—¶ï¼Œç½‘å…³<code>client</code>ä¸åœ¨é˜»å¡é˜Ÿåˆ—ï¼Œé‚£ä¹ˆå°±æ— æ³•å¾—åˆ°å½“å‰å˜æ›´çš„æ•°æ®ã€‚</p><p>çŸ¥é“å“ªä¸ªåˆ†ç»„æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œä¸»åŠ¨å†å‘<code>admin</code>è·å–å˜æ›´çš„æ•°æ®ï¼Œæ ¹æ®åˆ†ç»„ä¸åŒï¼Œå…¨é‡æ‹¿æ•°æ®ã€‚è°ƒç”¨æ–¹æ³•æ˜¯<code>doFetchGroupConfig()</code>ï¼Œè¿™ä¸ªåœ¨å‰é¢å·²ç»åˆ†æè¿‡äº†ã€‚</p><p>åˆ†æåˆ°è¿™é‡Œï¼Œç½‘å…³ç«¯çš„æ•°æ®åŒæ­¥æ“ä½œå°±å®Œæˆäº†ã€‚é•¿è½®è¯¢ä»»åŠ¡å°±æ˜¯ä¸æ–­å‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œçœ‹çœ‹æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼Œå¦‚æœæœ‰åˆ†ç»„æ•°æ®å‘ç”Ÿå˜æ›´ï¼Œé‚£ä¹ˆå°±å†ä¸»åŠ¨å‘<code>admin</code>å‘èµ·è¯·æ±‚ï¼Œè·å–å˜æ›´æ•°æ®ï¼Œç„¶åæ›´æ–°ç½‘å…³å†…å­˜ä¸­çš„æ•°æ®ã€‚</p><p>ç½‘å…³ç«¯é•¿è½®è¯¢ä»»åŠ¡æµç¨‹ï¼š</p><p><img src="/zh/assets/images/http-long-polling-sequence-zh-9d03d97d038b1f3348c31b9eb0133086.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-adminæ•°æ®åŒæ­¥"></a>3. adminæ•°æ®åŒæ­¥<a class="hash-link" href="#3-adminæ•°æ®åŒæ­¥" title="Direct link to heading">#</a></h3><p>ä»å‰é¢åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œç½‘å…³ç«¯ä¸»è¦è°ƒç”¨<code>admin</code>çš„ä¸¤ä¸ªæ¥å£ï¼š</p><ul><li><code>/configs/listener</code>ï¼šåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li><li><code>/configs/fetch</code>ï¼šè·å–å˜æ›´ç»„æ•°æ®ã€‚</li></ul><p>ç›´æ¥ä»è¿™ä¸¤ä¸ªæ¥å£åˆ†æçš„è¯ï¼Œå¯èƒ½æœ‰çš„åœ°æ–¹ä¸å¥½ç†è§£ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ä»<code>admin</code>å¯åŠ¨æµç¨‹å¼€å§‹åˆ†ææ•°æ®åŒæ­¥è¿‡ç¨‹ã€‚</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-åŠ è½½é…ç½®"></a>3.1 åŠ è½½é…ç½®<a class="hash-link" href="#31-åŠ è½½é…ç½®" title="Direct link to heading">#</a></h4><p>å¦‚æœåœ¨é…ç½®æ–‡ä»¶<code>application.yml</code>ä¸­ï¼Œè¿›è¡Œäº†å¦‚ä¸‹é…ç½®ï¼Œå°±è¡¨ç¤ºé€šè¿‡<code>httpé•¿è½®è¯¢</code>çš„æ–¹å¼è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">shenyu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">sync</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>ç¨‹åºå¯åŠ¨æ—¶ï¼Œé€šè¿‡<code>springboot</code>æ¡ä»¶è£…é…å®ç°æ•°æ®åŒæ­¥ç±»çš„é…ç½®åŠ è½½ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šåˆ›å»º<code>HttpLongPollingDataChangedListener</code>ï¼Œè´Ÿè´£å¤„ç†é•¿è½®è¯¢çš„ç›¸å…³å®ç°é€»è¾‘ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®åŒæ­¥é…ç½®ç±»</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * é€šè¿‡springbootæ¡ä»¶è£…é…å®ç°</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * httpé•¿è½®è¯¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * http long polling.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(name = &quot;shenyu.sync.http.enabled&quot;, havingValue = &quot;true&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(HttpSyncProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class HttpLongPollingListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public HttpLongPollingDataChangedListener httpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new HttpLongPollingDataChangedListener(httpSyncProperties);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-æ•°æ®å˜æ›´ç›‘å¬å™¨å®ä¾‹åŒ–"></a>3.2 æ•°æ®å˜æ›´ç›‘å¬å™¨å®ä¾‹åŒ–<a class="hash-link" href="#32-æ•°æ®å˜æ›´ç›‘å¬å™¨å®ä¾‹åŒ–" title="Direct link to heading">#</a></h4><ul><li>HttpLongPollingDataChangedListener</li></ul><p>æ•°æ®å˜æ›´ç›‘å¬å™¨é€šè¿‡æ„é€ å‡½æ•°çš„æ–¹å¼å®Œæˆå®ä¾‹åŒ–å’Œåˆå§‹åŒ–æ“ä½œã€‚åœ¨æ„é€ å‡½æ•°ä¸­ä¼šåˆ›å»ºé˜»å¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾å®¢æˆ·ç«¯ï¼›åˆ›å»ºçº¿ç¨‹æ± ï¼Œç”¨äºæ‰§è¡Œå»¶è¿Ÿä»»åŠ¡ï¼Œå‘¨æœŸä»»åŠ¡ï¼›ä¿å­˜é•¿è½®è¯¢ç›¸å…³å±æ€§ä¿¡æ¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    public HttpLongPollingDataChangedListener(final HttpSyncProperties httpSyncProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é»˜è®¤å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œæ˜¯ç½‘å…³ï¼‰1024ä¸ª</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.clients = new ArrayBlockingQueue&lt;&gt;(1024);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åˆ›å»ºçº¿ç¨‹æ± </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ScheduledThreadPoolExecutor å¯ä»¥æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡ï¼Œå‘¨æœŸä»»åŠ¡ï¼Œæ™®é€šä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.scheduler = new ScheduledThreadPoolExecutor(1,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                ShenyuThreadFactory.create(&quot;long-polling&quot;, true));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é•¿è½®è¯¢çš„å±æ€§ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.httpSyncProperties = httpSyncProperties;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å¦å¤–ï¼Œå®ƒçš„ç±»å›¾å…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-1c8e4c0f4279cdb33b27c52cc933cac5.png"></p><p>å®ç°äº†<code>InitializingBean</code>æ¥å£ï¼Œæ‰€ä»¥åœ¨<code>bean</code>çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ<code>afterInitialize()</code>æ–¹æ³•ã€‚é€šè¿‡çº¿ç¨‹æ± æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼šæ›´æ–°å†…å­˜ä¸­<code>ï¼ˆCACHEï¼‰</code>çš„æ•°æ®æ¯éš”<code>5</code>åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œ<code>5</code>åˆ†é’Ÿåå¼€å§‹æ‰§è¡Œã€‚åˆ·æ–°æœ¬åœ°ç¼“å­˜å°±æ˜¯ä»æ•°æ®åº“è¯»å–æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆè¿™é‡Œå°±æ˜¯å†…å­˜ï¼‰ï¼Œé€šè¿‡<code>refreshLocalCache()</code>å®Œæˆã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åœ¨ InitializingBeanæ¥å£ä¸­çš„afterPropertiesSet()æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œå³åœ¨beançš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void afterInitialize() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        long syncInterval = httpSyncProperties.getRefreshInterval().toMillis();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Periodically check the data for changes and update the cache</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼šæ›´æ–°å†…å­˜ä¸­ï¼ˆCACHEï¼‰çš„æ•°æ®æ¯éš”5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œ5åˆ†é’Ÿåå¼€å§‹æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // é˜²æ­¢adminå…ˆå¯åŠ¨ä¸€æ®µæ—¶é—´åï¼Œäº§ç”Ÿäº†æ•°æ®ï¼›ç„¶åç½‘å…³åˆæ¬¡è¿æ¥æ—¶ï¼Œæ²¡æœ‰æ‹¿åˆ°å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.scheduleWithFixedDelay(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;http sync strategy refresh config start.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ä»æ•°æ®åº“è¯»å–æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆè¿™é‡Œå°±æ˜¯å†…å­˜ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.refreshLocalCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;http sync strategy refresh config success.&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;http sync strategy refresh config error!&quot;, e);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, syncInterval, syncInterval, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;http sync strategy refresh interval: {}ms&quot;, syncInterval);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>refreshLocalCache()</li></ul><p>åˆ†åˆ«å¯¹5ç§æ•°æ®ç±»å‹è¿›è¡Œæ›´æ–°ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    // ä»æ•°æ®åº“è¯»å–æ•°æ®åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆè¿™é‡Œå°±æ˜¯å†…å­˜ï¼‰</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void refreshLocalCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ›´æ–°è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateAppAuthCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ›´æ–°æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ›´æ–°è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateRuleCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ›´æ–°é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateSelectorCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ›´æ–°å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateMetaDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>5ä¸ªæ›´æ–°æ–¹æ³•çš„é€»è¾‘æ˜¯ç±»ä¼¼çš„ï¼Œè°ƒç”¨<code>service</code>æ–¹æ³•è·å–æ•°æ®ï¼Œç„¶åæ”¾åˆ°å†…å­˜<code>CACHE</code>ä¸­ã€‚ä»¥æ›´æ–°è§„åˆ™æ•°æ®æ–¹æ³•<code>updateRuleCache()</code>ä¸ºä¾‹ï¼Œä¼ å…¥è§„åˆ™æšä¸¾ç±»å‹ï¼Œè°ƒç”¨<code>ruleService.listAll()</code>ä»æ•°æ®åº“è·å–æ‰€æœ‰è§„åˆ™æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Update rule cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void updateRuleCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updateCache(ConfigGroupEnum.RULE, ruleService.listAll());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>updateCache()</li></ul><p>ä½¿ç”¨æ•°æ®åº“ä¸­çš„æ•°æ®æ›´æ–°å†…å­˜ä¸­çš„æ•°æ®ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// ç¼“å­˜æ•°æ®çš„ Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">protected static final ConcurrentMap&lt;String, ConfigDataCache&gt; CACHE = new ConcurrentHashMap&lt;&gt;();</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * if md5 is not the same as the original, then update lcoal cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param group ConfigGroupEnum</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param &lt;T&gt; the type of class</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the new config data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected &lt;T&gt; void updateCache(final ConfigGroupEnum group, final List&lt;T&gt; data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ•°æ®åºåˆ—åŒ–</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String json = GsonUtils.getInstance().toJson(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //ä¼ å…¥md5å€¼å’Œä¿®æ”¹æ—¶é—´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache newVal = new ConfigDataCache(group.name(), json, Md5Utils.md5(json), System.currentTimeMillis());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //æ›´æ–°åˆ†ç»„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache oldVal = CACHE.put(newVal.getGroup(), newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.info(&quot;update config cache[{}], old: {}, updated: {}&quot;, group, oldVal, newVal);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>åˆå§‹åŒ–çš„è¿‡ç¨‹å°±æ˜¯å¯åŠ¨å‘¨æœŸæ€§ä»»åŠ¡ï¼Œå®šæ—¶ä»æ•°æ®åº“è·å–æ•°æ®æ›´æ–°å†…å­˜æ•°æ®ã€‚</p><p>æ¥ä¸‹æ¥å¼€å§‹å¯¹ä¸¤ä¸ªæ¥å£å¼€å§‹åˆ†æï¼š</p><ul><li><code>/configs/listener</code>ï¼šåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li><li><code>/configs/fetch</code>ï¼šè·å–å˜æ›´ç»„æ•°æ®ã€‚</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33--æ•°æ®å˜æ›´è½®è¯¢æ¥å£"></a>3.3  æ•°æ®å˜æ›´è½®è¯¢æ¥å£<a class="hash-link" href="#33--æ•°æ®å˜æ›´è½®è¯¢æ¥å£" title="Direct link to heading">#</a></h4><ul><li><code>/configs/listener</code>ï¼šåˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼›</li></ul><p>æ¥å£ç±»æ˜¯<code>ConfigController</code>ï¼Œåªæœ‰ä½¿ç”¨<code>httpé•¿è½®è¯¢</code>è¿›è¡Œæ•°æ®åŒæ­¥æ—¶æ‰ä¼šç”Ÿæ•ˆã€‚æ¥å£æ–¹æ³•<code>listener()</code>æ²¡æœ‰å…¶ä»–é€»è¾‘ï¼Œç›´æ¥è°ƒç”¨<code>doLongPolling()</code>æ–¹æ³•ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">   </span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * This Controller only when HttpLongPollingDataChangedListener exist, will take effect.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // çœç•¥å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * ç›‘å¬æ•°æ®å˜æ›´ï¼Œæ‰§è¡Œé•¿è½®è¯¢</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request  the request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response the response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(value = &quot;/listener&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void listener(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        longPollingListener.doLongPolling(request, response);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#doLongPolling()</li></ul><p>æ‰§è¡Œé•¿è½®è¯¢ä»»åŠ¡ï¼šå¦‚æœæœ‰æ•°æ®å˜æ›´ï¼Œå°†ä¼šç«‹å³å“åº”ç»™å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ç«¯ï¼‰ã€‚å¦åˆ™ï¼Œå®¢æˆ·ç«¯ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®å˜æ›´æˆ–è€…è¶…æ—¶ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æ‰§è¡Œé•¿è½®è¯¢ï¼šå¦‚æœæœ‰æ•°æ®å˜æ›´ï¼Œä¼šç«‹å³å“åº”ç»™å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ç«¯ï¼‰ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å¦åˆ™ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šä¸€ç›´è¢«é˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®å˜æ›´æˆ–è€…è¶…æ—¶ã€‚</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param response</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doLongPolling(final HttpServletRequest request, final HttpServletResponse response) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // compare group md5</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ¯”è¾ƒmd5ï¼Œåˆ¤æ–­ç½‘å…³çš„æ•°æ®å’Œadminç«¯çš„æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Œå¾—åˆ°å‘ç”Ÿå˜æ›´çš„æ•°æ®ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConfigGroupEnum&gt; changedGroup = compareChangedGroup(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String clientIp = getRemoteIp(request);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // response immediately.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æœ‰å˜æ›´çš„æ•°æ®ï¼Œåˆ™ç«‹å³å‘ç½‘å…³å“åº”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isNotEmpty(changedGroup)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            this.generateResponse(response, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(&quot;send response with the changed group, ip={}, group={}&quot;, clientIp, changedGroup);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         // æ²¡æœ‰å˜æ›´ï¼Œåˆ™å°†å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ï¼‰æ”¾è¿›é˜»å¡é˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // listen for configuration changed.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final AsyncContext asyncContext = request.startAsync();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // AsyncContext.settimeout() does not timeout properly, so you have to control it yourself</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        asyncContext.setTimeout(0L);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // block client&#x27;s thread.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.execute(new LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>HttpLongPollingDataChangedListener#compareChangedGroup()</li></ul><p>åˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´ï¼Œåˆ¤æ–­é€»è¾‘æ˜¯æ¯”è¾ƒç½‘å…³ç«¯å’Œ<code>admin</code>ç«¯çš„<code>md5</code>å€¼å’Œ<code>lastModifyTime</code>ã€‚</p><ul><li>å¦‚æœ<code>md5</code>å€¼ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–°ï¼›</li><li>å¦‚æœ<code>admin</code>ç«¯çš„<code>lastModifyTime</code>å¤§äºç½‘å…³ç«¯çš„<code>lastModifyTime</code>ï¼Œé‚£ä¹ˆéœ€è¦æ›´æ–°ã€‚</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param request</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;ConfigGroupEnum&gt; compareChangedGroup(final HttpServletRequest request) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConfigGroupEnum&gt; changedGroup = new ArrayList&lt;&gt;(ConfigGroupEnum.values().length);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (ConfigGroupEnum group : ConfigGroupEnum.values()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ç½‘å…³ç«¯æ•°æ®çš„md5å€¼å’ŒlastModifyTime</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String[] params = StringUtils.split(request.getParameter(group.name()), &#x27;,&#x27;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (params == null || params.length != 2) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new ShenyuException(&quot;group param invalid:&quot; + request.getParameter(group.name()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String clientMd5 = params[0];</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            long clientModifyTime = NumberUtils.toLong(params[1]);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigDataCache serverCache = CACHE.get(group.name());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // do check. åˆ¤æ–­ç»„æ•°æ®æ˜¯å¦å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (this.checkCacheDelayAndUpdate(serverCache, clientMd5, clientModifyTime)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                changedGroup.add(group);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return changedGroup;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>LongPollingClient</li></ul><p>æ²¡æœ‰å˜æ›´æ•°æ®ï¼Œåˆ™å°†å®¢æˆ·ç«¯ï¼ˆè¿™é‡Œå°±æ˜¯ç½‘å…³ï¼‰æ”¾è¿›é˜»å¡é˜Ÿåˆ—ã€‚é˜»å¡æ—¶é—´æ˜¯60ç§’ï¼Œå³60ç§’åç§»é™¤ï¼Œå¹¶å“åº”å®¢æˆ·ç«¯ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class LongPollingClient implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      // çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 60ç§’åç§»é™¤ï¼Œå¹¶å“åº”å®¢æˆ·ç«¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                this.asyncTimeoutFuture = scheduler.schedule(() -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    clients.remove(LongPollingClient.this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    List&lt;ConfigGroupEnum&gt; changedGroups = compareChangedGroup((HttpServletRequest) asyncContext.getRequest());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    sendResponse(changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }, timeoutTime, TimeUnit.MILLISECONDS);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ·»åŠ åˆ°é˜»å¡é˜Ÿåˆ—</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.add(this);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception ex) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.error(&quot;add long polling client error&quot;, ex);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Send response.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param changedGroups the changed groups</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        void sendResponse(final List&lt;ConfigGroupEnum&gt; changedGroups) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // cancel scheduler</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (null != asyncTimeoutFuture) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                asyncTimeoutFuture.cancel(false);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“åº”å˜æ›´çš„ç»„</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            generateResponse((HttpServletResponse) asyncContext.getResponse(), changedGroups);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            asyncContext.complete();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34--è·å–å˜æ›´æ•°æ®æ¥å£"></a>3.4  è·å–å˜æ›´æ•°æ®æ¥å£<a class="hash-link" href="#34--è·å–å˜æ›´æ•°æ®æ¥å£" title="Direct link to heading">#</a></h4><ul><li><code>/configs/fetch</code>ï¼šè·å–å˜æ›´æ•°æ®ï¼›</li></ul><p>æ ¹æ®ç½‘å…³ä¼ å…¥çš„å‚æ•°ï¼Œè·å–åˆ†ç»„æ•°æ®ï¼Œè¿”å›ç»“æœã€‚ä¸»è¦å®ç°æ–¹æ³•æ˜¯<code>longPollingListener.fetchConfig()</code>ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConditionalOnBean(HttpLongPollingDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/configs&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConfigController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Resource</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private HttpLongPollingDataChangedListener longPollingListener;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Fetch configs shenyu result.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * å…¨é‡è·å–åˆ†ç»„æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupKeys the group keys</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the shenyu result</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/fetch&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult fetchConfigs(@NotNull final String[] groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, ConfigData&lt;?&gt;&gt; result = Maps.newHashMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String groupKey : groupKeys) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConfigData&lt;?&gt; data = longPollingListener.fetchConfig(ConfigGroupEnum.valueOf(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            result.put(groupKey, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.SUCCESS, result);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  // çœç•¥äº†å…¶ä»–æ¥å£</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>AbstractDataChangedListener#fetchConfig()</li></ul><p>æ•°æ®è·å–ç›´æ¥ä»<code>CACHE</code>ä¸­æ‹¿ï¼Œç„¶åæ ¹æ®ä¸åŒåˆ†ç»„ç±»å‹è¿›è¡ŒåŒ¹é…ï¼Œå°è£…ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * fetch configuration from cache.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * è·å–åˆ†ç»„ä¸‹çš„å…¨é‡æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param groupKey the group key</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the configuration data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ConfigData&lt;?&gt; fetchConfig(final ConfigGroupEnum groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ç›´æ¥ä» CACHE ä¸­æ‹¿æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConfigDataCache config = CACHE.get(groupKey.name()); </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (groupKey) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case APP_AUTH: // è®¤è¯æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;AppAuthData&gt; appAuthList = GsonUtils.getGson().fromJson(config.getJson(), new TypeToken&lt;List&lt;AppAuthData&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }.getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), appAuthList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case PLUGIN: // æ’ä»¶æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;PluginData&gt; pluginList = GsonUtils.getGson().fromJson(config.getJson(), new TypeToken&lt;List&lt;PluginData&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }.getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), pluginList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case RULE:   // è§„åˆ™æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;RuleData&gt; ruleList = GsonUtils.getGson().fromJson(config.getJson(), new TypeToken&lt;List&lt;RuleData&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }.getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), ruleList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case SELECTOR:  // é€‰æ‹©å™¨æ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;SelectorData&gt; selectorList = GsonUtils.getGson().fromJson(config.getJson(), new TypeToken&lt;List&lt;SelectorData&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }.getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), selectorList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case META_DATA: // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;MetaData&gt; metaList = GsonUtils.getGson().fromJson(config.getJson(), new TypeToken&lt;List&lt;MetaData&gt;&gt;() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }.getType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                return new ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), metaList);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new IllegalStateException(&quot;Unexpected groupKey: &quot; + groupKey);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="35-æ•°æ®å˜æ›´"></a>3.5 æ•°æ®å˜æ›´<a class="hash-link" href="#35-æ•°æ®å˜æ›´" title="Direct link to heading">#</a></h4><p>åœ¨ä¹‹å‰çš„<code>websocket</code>æ•°æ®åŒæ­¥å’Œ<code>zookeeper</code>æ•°æ®åŒæ­¥æºç åˆ†ææ–‡ç« ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“<code>admin</code>ç«¯æ•°æ®åŒæ­¥è®¾è®¡ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/zh/assets/images/data-changed-listener-admin-2f384e703652e9e28db8447b1cbdaea7.png"></p><p>å„ç§æ•°æ®å˜æ›´ç›‘å¬å™¨éƒ½æ˜¯<code>DataChangedListener</code>çš„å­ç±»ã€‚</p><p>å½“åœ¨<code>admin</code>ç«¯ä¿®æ”¹æ•°æ®åï¼Œé€šè¿‡<code>Spring</code>çš„äº‹ä»¶å¤„ç†æœºåˆ¶ï¼Œå‘é€äº‹ä»¶é€šçŸ¥ã€‚å‘é€é€»è¾‘å¦‚ä¸‹ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Event forwarders, which forward the changed events to each ConfigEventListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®å˜æ›´äº‹ä»¶åˆ†å‘å™¨ï¼šå½“adminç«¯æœ‰æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œå°†å˜æ›´æ•°æ®åŒæ­¥åˆ° ShenYu ç½‘å…³</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * æ•°æ®å˜æ›´ä¾èµ–äºSpringçš„äº‹ä»¶ç›‘å¬æœºåˆ¶ï¼šApplicationEventPublisher --&gt; ApplicationEvent --&gt; ApplicationListener</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   //çœç•¥äº†å…¶ä»–é€»è¾‘</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œè°ƒç”¨æ­¤æ–¹æ³•</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // éå†æ•°æ®å˜æ›´ç›‘å¬å™¨(ä¸€èˆ¬ä½¿ç”¨ä¸€ç§æ•°æ®åŒæ­¥çš„æ–¹å¼å°±å¥½äº†)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // å“ªç§æ•°æ®å‘ç”Ÿå˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // è®¤è¯ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // æ’ä»¶ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // è§„åˆ™ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // é€‰æ‹©å™¨ä¿¡æ¯</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // å…ƒæ•°æ®</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // å…¶ä»–ç±»å‹ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>å‡è®¾ï¼Œå¯¹æ’ä»¶ä¿¡æ¯è¿›è¡Œäº†ä¿®æ”¹ï¼Œé€šè¿‡<code>httpé•¿è½®è¯¢</code>çš„æ–¹å¼è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œé‚£ä¹ˆ<code>listener.onPluginChanged()</code>çš„å®é™…è°ƒç”¨çš„æ˜¯<code>org.apache.shenyu.admin.listener.AbstractDataChangedListener#onPluginChanged</code>ï¼š</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * åœ¨adminçš„æ“ä½œï¼Œæœ‰æ’ä»¶å‘ç”Ÿäº†æ›´æ–°</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param changed   the changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param eventType the event type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (CollectionUtils.isEmpty(changed)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ›´æ–°å†…å­˜CACHE</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.updatePluginCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // æ‰§è¡Œå˜æ›´ä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.afterPluginChanged(changed, eventType);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>æœ‰ä¸¤ä¸ªå¤„ç†æ“ä½œï¼Œä¸€æ˜¯æ›´æ–°å†…å­˜<code>CACHE</code>ï¼Œè¿™ä¸ªåœ¨å‰é¢åˆ†æè¿‡äº†ï¼›å¦ä¸€ä¸ªæ˜¯æ‰§è¡Œå˜æ›´ä»»åŠ¡ï¼Œåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œã€‚</p><ul><li>HttpLongPollingDataChangedListener#afterPluginChanged()</li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void afterPluginChanged(final List&lt;PluginData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        scheduler.execute(new DataChangeTask(ConfigGroupEnum.PLUGIN));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ul><li>DataChangeTask</li></ul><p>æ•°æ®å˜æ›´ä»»åŠ¡ï¼šå°†é˜»å¡é˜Ÿåˆ—ä¸­çš„å®¢æˆ·ç«¯ä¾æ¬¡ç§»é™¤ï¼Œå¹¶å‘é€å“åº”ï¼Œé€šçŸ¥ç½‘å…³æœ‰ç»„æ•°æ®å‘ç”Ÿå˜æ›´ã€‚</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">class DataChangeTask implements Runnable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        //çœç•¥äº†å…¶ä»–é€»è¾‘ </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void run() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é˜»å¡é˜Ÿåˆ—ä¸­çš„å®¢æˆ·ç«¯è¶…è¿‡äº†ç»™å®šçš„å€¼100ï¼Œåˆ™åˆ†æ‰¹æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (clients.size() &gt; httpSyncProperties.getNotifyBatchSize()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;LongPollingClient&gt; targetClients = new ArrayList&lt;&gt;(clients.size());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                clients.drainTo(targetClients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                List&lt;List&lt;LongPollingClient&gt;&gt; partitionClients = Lists.partition(targetClients, httpSyncProperties.getNotifyBatchSize());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">               // åˆ†æ‰¹æ‰§è¡Œ</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                partitionClients.forEach(item -&gt; scheduler.execute(() -&gt; doRun(item)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // æ‰§è¡Œä»»åŠ¡</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                doRun(clients);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        private void doRun(final Collection&lt;LongPollingClient&gt; clients) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯å‘ç”Ÿäº†æ•°æ®å˜æ›´</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (Iterator&lt;LongPollingClient&gt; iter = clients.iterator(); iter.hasNext();) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                LongPollingClient client = iter.next();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                iter.remove();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // å‘é€å“åº”</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                client.sendResponse(Collections.singletonList(groupKey));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                log.info(&quot;send response with the changed group,ip={}, group={}, changeTime={}&quot;, client.ip, groupKey, changeTime);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>è‡³æ­¤ï¼Œ<code>admin</code>ç«¯æ•°æ®åŒæ­¥é€»è¾‘å°±åˆ†æå®Œäº†ã€‚åœ¨åŸºäº<code>httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥æ˜¯ï¼Œå®ƒä¸»è¦æœ‰ä¸‰ä¸ªåŠŸèƒ½ï¼š</p><ul><li>æä¾›æ•°æ®å˜æ›´ç›‘å¬æ¥å£ï¼›</li><li>æä¾›è·å–å˜æ›´æ•°æ®æ¥å£ï¼›</li><li>æœ‰æ•°æ®å˜æ›´æ—¶ï¼Œç§»é™¤é˜»å¡é˜Ÿåˆ—ä¸­çš„å®¢æˆ·ç«¯ï¼Œå¹¶å“åº”ç»“æœã€‚</li></ul><p>æœ€åï¼Œç”¨ä¸‰å¼ å›¾æè¿°ä¸‹<code>admin</code>ç«¯é•¿è½®è¯¢ä»»åŠ¡æµç¨‹ï¼š</p><ul><li><code>/configs/listener</code>æ•°æ®å˜æ›´ç›‘å¬æ¥å£ï¼š</li></ul><p><img src="/zh/assets/images/http-long-polling-listener-zh-a0458f05d312cb977f000662b3791567.png"></p><ul><li><code>/configs/fetch</code>è·å–å˜æ›´æ•°æ®æ¥å£ï¼š</li></ul><p><img src="/zh/assets/images/http-long-polling-fetch-zh-59963a9119cc79d08e95aa5f4442f413.png"></p><ul><li>åœ¨adminåå°ç®¡ç†ç³»ç»Ÿæ›´æ–°æ•°æ®ï¼Œè¿›è¡Œæ•°æ®åŒæ­¥ï¼š</li></ul><p><img src="/zh/assets/images/http-long-polling-admin-update-zh-97645cfabead723acf9243cfae2d2dbc.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-æ€»ç»“"></a>4. æ€»ç»“<a class="hash-link" href="#4-æ€»ç»“" title="Direct link to heading">#</a></h3><p>æœ¬æ–‡ä¸»è¦å¯¹<code>ShenYu</code>ç½‘å…³ä¸­çš„<code>httpé•¿è½®è¯¢</code>æ•°æ®åŒæ­¥è¿›è¡Œäº†æºç åˆ†æã€‚æ¶‰åŠåˆ°çš„ä¸»è¦çŸ¥è¯†ç‚¹å¦‚ä¸‹ï¼š</p><ul><li><code>httpé•¿è½®è¯¢</code>ç”±ç½‘å…³ç«¯ä¸»åŠ¨å‘èµ·è¯·æ±‚ï¼Œä¸æ–­è¯·æ±‚<code>admin</code>ç«¯ï¼›</li><li>å˜æ›´æ•°æ®ä»¥ç»„ä¸ºç²’åº¦ï¼ˆè®¤è¯ä¿¡æ¯ã€æ’ä»¶ã€é€‰æ‹©å™¨ã€è§„åˆ™ã€å…ƒæ•°æ®ï¼‰ï¼›</li><li><code>httpé•¿è½®è¯¢</code>ç»“æœåªæ‹¿åˆ°äº†å˜æ›´ç»„ï¼Œè¿˜éœ€è¦å†æ¬¡å‘èµ·è¯·æ±‚è·å–ç»„æ•°æ®ï¼›</li><li>æ•°æ®æ˜¯å¦æ›´æ–°ç”±<code>md5</code>å€¼å’Œä¿®æ”¹æ—¶é—´<code>lastModifyTime</code>å†³å®šã€‚</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/http">http</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="blogPostTitle_d4p0"><a href="/zh/blog/code-analysis-etcd-data-sync">Etcd Data Synchronization Source Code Analysis</a></h2><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-02-20T14:25:01.576Z">2022å¹´2æœˆ20æ—¥</time> Â· One min read</div><div class="avatar margin-vert--md"><div class="avatar__intro"><div class="avatar__name"><a href="https://github.com/4zd" target="_blank" rel="noopener noreferrer">4zd</a></div><small class="avatar__subtitle">Apache ShenYu Contributor</small></div></div></header><div class="markdown"><blockquote><p><a href="https://shenyu.apache.org/zh/docs/index" target="_blank" rel="noopener noreferrer">Apache ShenYu</a> is an asynchronous, high-performance, cross-language, responsive API gateway.</p></blockquote><p>In <code>ShenYu</code> gateway, data synchronization refers to how to synchronize the updated data to the gateway after the data is sent in the background management system. The Apache ShenYu gateway currently supports data synchronization for <code>ZooKeeper</code>, <code>WebSocket</code>, <code>http long poll</code>, <code>Nacos</code>, <code>Etcd</code> and <code>Consul</code>. The main content of this article is based on <code>Etcd</code> data synchronization source code analysis.</p><blockquote><p>This paper based on <code>shenyu-2.4.0</code> version of the source code analysis, the official website of the introduction of please refer to the <a href="https://shenyu.apache.org/docs/design/data-sync/" target="_blank" rel="noopener noreferrer">Data Synchronization Design</a> .</p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-about-etcd"></a>1. About Etcd<a class="hash-link" href="#1-about-etcd" title="Direct link to heading">#</a></h3><p><a href="https://etcd.io" target="_blank" rel="noopener noreferrer">Etcd</a> is a strongly consistent, distributed key-value store that provides a reliable way to store data that needs to be accessed by a distributed system or cluster of machines.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-admin-data-sync"></a>2. Admin Data Sync<a class="hash-link" href="#2-admin-data-sync" title="Direct link to heading">#</a></h3><p>We traced the source code from a real case, such as updating a selector data in the <code>Divide</code> plugin to a weight of 90 in a background administration system:</p><p><img src="/zh/assets/images/update-selector-en-4efb58e488bd424a54213d31929d7eb1.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="21-accept-data"></a>2.1 Accept Data<a class="hash-link" href="#21-accept-data" title="Direct link to heading">#</a></h4><ul><li>SelectorController.createSelector()</li></ul><p>Enter the createSelector() method of the <code>SelectorController</code> class, which validates data, adds or updates data, and returns results.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Validated</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/selector&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorController {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/{id}&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ShenyuAdminResult updateSelector(@PathVariable(&quot;id&quot;) final String id, @Valid @RequestBody final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // set the current selector data ID</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        selectorDTO.setId(id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // create or update operation</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Integer updateCount = selectorService.createOrUpdate(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // return result </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ShenyuAdminResult.success(ShenyuResultMessage.UPDATE_SUCCESS, updateCount);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="22-handle-data"></a>2.2 Handle Data<a class="hash-link" href="#22-handle-data" title="Direct link to heading">#</a></h4><ul><li>SelectorServiceImpl.createOrUpdate()</li></ul><p>Convert data in the <code>SelectorServiceImpl</code> class using the <code>createOrUpdate()</code> method, save it to the database, publish the event, update <code>upstream</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SelectorServiceImpl implements SelectorService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Transactional(rollbackFor = Exception.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public int createOrUpdate(final SelectorDTO selectorDTO) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        int selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build data DTO --&gt; DO</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        SelectorDO selectorDO = SelectorDO.buildSelectorDO(selectorDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorConditionDTO&gt; selectorConditionDTOs = selectorDTO.getSelectorConditions();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // insert or update ?</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (StringUtils.isEmpty(selectorDTO.getId())) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //  insert into data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.insertSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // insert into condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // check selector add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (dataPermissionMapper.listByUserId(JwtUtils.getUserInfo().getUserId()).size() &gt; 0) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                DataPermissionDTO dataPermissionDTO = new DataPermissionDTO();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setUserId(JwtUtils.getUserInfo().getUserId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionDTO.setDataType(AdminConstants.SELECTOR_DATA_TYPE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                dataPermissionMapper.insertSelective(DataPermissionDO.buildPermissionDO(dataPermissionDTO));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // update data, delete and then insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorCount = selectorMapper.updateSelective(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //delete rule condition then add</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionMapper.deleteByQuery(new SelectorConditionQuery(selectorDO.getId()));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            selectorConditionDTOs.forEach(selectorConditionDTO -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionDTO.setSelectorId(selectorDO.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorConditionDO selectorConditionDO = SelectorConditionDO.buildSelectorConditionDO(selectorConditionDTO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                selectorConditionMapper.insertSelective(selectorConditionDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        publishEvent(selectorDO, selectorConditionDTOs);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // update upstream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        updateDivideUpstream(selectorDO);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return selectorCount;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>In the <code>Service</code> class to persist data, i.e. to the database, this should be familiar, not expand. The update upstream operation is analyzed in the corresponding section below, focusing on the publish event operation, which performs data synchronization.</p><p>The logic of the <code>publishEvent()</code>  method is to find the plugin corresponding to the selector, build the conditional data, and publish the change data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">       private void publishEvent(final SelectorDO selectorDO, final List&lt;SelectorConditionDTO&gt; selectorConditionDTOs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // find plugin of selector</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        PluginDO pluginDO = pluginMapper.selectById(selectorDO.getPluginId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // build condition data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;ConditionData&gt; conditionDataList =                selectorConditionDTOs.stream().map(ConditionTransfer.INSTANCE::mapToSelectorDTO).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // publish event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, DataEventTypeEnum.UPDATE,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                Collections.singletonList(SelectorDO.transFrom(selectorDO, pluginDO.getName(), conditionDataList))));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Change data released by <code>eventPublisher.PublishEvent()</code> is complete, the <code>eventPublisher</code> object is a <code>ApplicationEventPublisher</code> class, The fully qualified class name is <code>org.springframework.context.ApplicationEventPublisher</code>. Here we see that publishing data is done through <code>Spring</code> related functionality.</p><blockquote><p><code>ApplicationEventPublisher</code>ï¼š</p><p>When a state change, the publisher calls <code>ApplicationEventPublisher</code> of <code>publishEvent</code> method to release an event, <code>Spring</code> container broadcast event for all observers, The observer&#x27;s <code>onApplicationEvent</code> method is called to pass the event object to the observer. There are two ways to call <code>publishEvent</code> method, one is to implement the interface by the container injection <code>ApplicationEventPublisher</code> object and then call the method, the other is a direct call container, the method of two methods of publishing events not too big difference.</p><ul><li><code>ApplicationEventPublisher</code>: publish event;</li><li><code>ApplicationEvent</code>: <code>Spring</code> event, record the event source, time, and data;</li><li><code>ApplicationListener</code>: event listener, observer.</li></ul></blockquote><p>In Spring event publishing mechanism, there are three objects,</p><p>An object is a publish event <code>ApplicationEventPublisher</code>, in <code>ShenYu</code> through the constructor in the injected a <code>eventPublisher</code>.</p><p>The other object is <code>ApplicationEvent</code> , inherited from <code>ShenYu</code> through <code>DataChangedEvent</code>, representing the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEvent extends ApplicationEvent {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The last object is <code>ApplicationListener</code> in <code>ShenYu</code> in through <code>DataChangedEventDispatcher</code> class implements this interface, as the event listener, responsible for handling the event object.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="23-dispatch-data"></a>2.3 Dispatch Data<a class="hash-link" href="#23-dispatch-data" title="Direct link to heading">#</a></h4><ul><li>DataChangedEventDispatcher.onApplicationEvent()</li></ul><p>Released when the event is completed, will automatically enter the <code>DataChangedEventDispatcher</code> class <code>onApplicationEvent()</code> method of handling events.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataChangedEventDispatcher implements ApplicationListener&lt;DataChangedEvent&gt;, InitializingBean {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * This method is called when there are data changes</span></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param event</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // What kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case APP_AUTH: // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onAppAuthChanged((List&lt;AppAuthData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case PLUGIN:  // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onPluginChanged((List&lt;PluginData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case RULE:    // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onRuleChanged((List&lt;RuleData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case META_DATA:  // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onMetaDataChanged((List&lt;MetaData&gt;) event.getSource(), event.getEventType());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                default:  // other types throw exception</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                  throw new IllegalStateException(&quot;Unexpected value: &quot; + event.getGroupKey());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When there is a data change, the <code>onApplicationEvent</code> method is called and all the data change listeners are iterated to determine the data type and handed over to the appropriate data listener for processing.</p><p>ShenYu groups all the data into five categories: <code>APP_AUTH</code>, <code>PLUGIN</code>, <code>RULE</code>, <code>SELECTOR</code> and <code>META_DATA</code>.</p><p>Here the data change listener (<code>DataChangedListener</code>) is an abstraction of the data synchronization policy. Its concrete implementation is:</p><p><img src="/zh/assets/images/data-changed-listener-b01d7410746ca4afd526d8c9df865e9b.png"></p><p>These implementation classes are the synchronization strategies currently supported by ShenYu:</p><ul><li><code>WebsocketDataChangedListener</code>: data synchronization based on Websocket;</li><li><code>ZookeeperDataChangedListener</code>:data synchronization based on Zookeeper;</li><li><code>ConsulDataChangedListener</code>: data synchronization based on Consul;</li><li><code>EtcdDataDataChangedListener</code>ï¼šdata synchronization based on etcd;</li><li><code>HttpLongPollingDataChangedListener</code>ï¼šdata synchronization based on http long polling;</li><li><code>NacosDataChangedListener</code>ï¼šdata synchronization based on nacos;</li></ul><p>Given that there are so many implementation strategies, how do you decide which to use?</p><p>Because this paper is based on <code>Etcd</code> data synchronization source code analysis, so here to <code>EtcdDataDataChangedListener</code> as an example, the analysis of how it is loaded and implemented.</p><p>A global search in the source code project shows that its implementation is done in the <code>DataSyncConfiguration</code> class.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data Sync Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * By springboot conditional assembly</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The type Data sync configuration.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DataSyncConfiguration {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * The type Etcd listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Configuration</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EnableConfigurationProperties(EtcdProperties.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    static class EtcdListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public EtcdClient etcdClient(final EtcdProperties etcdProperties) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Client client = Client.builder()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .endpoints(etcdProperties.getUrl())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdClient(client);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * Config event listener data changed listener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param etcdClient the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the data changed listener</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(EtcdDataDataChangedListener.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public DataChangedListener etcdDataChangedListener(final EtcdClient etcdClient) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdDataDataChangedListener(etcdClient);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * data init.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param etcdClient        the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @param syncDataService the sync data service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         * @return the etcd data init</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Bean</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        @ConditionalOnMissingBean(EtcdDataInit.class)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        public EtcdDataInit etcdDataInit(final EtcdClient etcdClient, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new EtcdDataInit(etcdClient, syncDataService);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // other code is omitted......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This configuration class is implemented through the SpringBoot conditional assembly class. The <code>EtcdListener</code> class has several annotations:</p><ul><li><p><code>@Configuration</code>: Configuration file, application context;</p></li><li><p><code>@ConditionalOnProperty(prefix = &quot;shenyu.sync.etcd&quot;, name = &quot;url&quot;)</code>: attribute condition. The configuration class takes effect only when the condition is met. That is, when we have the following configuration, <code>etcd</code> is used for data synchronization.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI properties"><pre tabindex="0" class="prism-code language-properties codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">shenyu:  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  sync:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     etcd:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">          url: localhost:2181</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p><code>@EnableConfigurationProperties(EtcdProperties.class)</code>ï¼šimport <code>EtcdProperties</code>; The properties in the class <code>EtcdProperties</code> is relative to the properties which is with <code>shenyu.sync.etcd</code> as prefix in the configuration file.</p></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"> @Data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@ConfigurationProperties(prefix = &quot;shenyu.sync.etcd&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdProperties {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String url;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer sessionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private Integer connectionTimeout;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private String serializer;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>When the <code>shenyu.sync.etcd.url</code> property is set in the configuration file, <code>Admin</code> would use the <code>etcd</code> data synchronization, <code>EtcdListener</code> is generated and the beans with type <code>EtcdClient</code>, <code>EtcdDataDataChangedListener</code> and <code>EtcdDataInit</code> would also be generated. </p><ul><li>The bean with the type <code>EtcdClient</code> would be generated, named <code>etcdClient</code>. This bean configues the connection properties of the <code>etcd</code> server based on the configuration file and can operate the <code>etcd</code>nodes directly.</li><li>The bean with the type <code>EtcdDataDataChangedListener</code> would be generated, named <code>etcdDataDataChangedListener</code>.  This bean use the bean <code>etcdClient</code> as a member variable and so when the event is listened, <code>etcdDataDataChangedListener</code> would call the callback method and use the <code>etcdClient</code>  to operate the <code>etcd</code> nodes.</li><li>The bean with the type <code>EtcdDataInit</code> would be generated, named <code>etcdDataInit</code>. This bean use the bean <code>etcdClient</code> and <code>syncDataService</code> as member variables, and use <code>etcdClient</code> to judge whether the data are initialized, if not, would use <code>syncDataService</code> to refresh data. We would dive into the details later.       </li></ul><p>So in the event handler <code>onApplicationEvent()</code>, it goes to the corresponding <code>listener</code>. In our case, it is a selector data update, data synchronization is <code>etcd</code>, so, the code will enter the <code>EtcdDataDataChangedListener</code> selector data change process.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @SuppressWarnings(&quot;unchecked&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onApplicationEvent(final DataChangedEvent event) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Iterate through the data change listener (usually using a data synchronization approach is fine)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (DataChangedListener listener : listeners) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // what kind of data has changed</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         switch (event.getGroupKey()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // other code logic is omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                case SELECTOR:   // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    listener.onSelectorChanged((List&lt;SelectorData&gt;) event.getSource(), event.getEventType());   // In our case, will enter the EtcdDataDataChangedListener selector data change process</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="24-etcd-data-changed-listener"></a>2.4 Etcd Data Changed Listener<a class="hash-link" href="#24-etcd-data-changed-listener" title="Direct link to heading">#</a></h4><ul><li>EtcdDataDataChangedListener.onSelectorChanged()</li></ul><p>In the <code>onSelectorChanged()</code> method, determine the type of action, whether to refresh synchronization or update or create synchronization. Determine whether the node is in <code>etcd</code> based on the current selector data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataDataChangedListener.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataDataChangedListener implements DataChangedListener {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorChanged(final List&lt;SelectorData&gt; changed, final DataEventTypeEnum eventType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (eventType == DataEventTypeEnum.REFRESH &amp;&amp; !changed.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorParentPath = DefaultPathConstants.buildSelectorParentPath(changed.get(0).getPluginName());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            etcdClient.deleteEtcdPathRecursive(selectorParentPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (SelectorData data : changed) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            String selectorRealPath = DefaultPathConstants.buildSelectorRealPath(data.getPluginName(), data.getId());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (eventType == DataEventTypeEnum.DELETE) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                etcdClient.delete(selectorRealPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                continue;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            //create or update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            updateNode(selectorRealPath, data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This part is very important. The variable <code>changed</code> represents the <code>SelectorData</code> list, the variable <code>eventType</code> reprents the event type. When the event type is <code>REFRESH</code> and the <code>SelectorData</code> has changed, all the <code>selector</code> nodes under this <code>plugin</code> would be deleted in <code>etcd</code>. We should notice that the condition that the <code>SelectorData</code> has changed is necessary, otherwise a bug would appear that all the selector nodes would be deleted when no <code>SelectorData</code> data has changed. </p><p>As long as the changed data is correctly written to the <code>etcd</code> node, the <code>admin</code> side of the operation is complete. </p><p>In our current case, updating one of the selector data in the <code>Divide</code> plugin with a weight of 90 updates specific nodes in the graph.</p><p><img src="/zh/assets/images/zookeeper-node-c7628b680a1f1afa0eada97b66fcd5b1.png"></p><p>We series the above update flow with a sequence diagram.</p><p><img src="/zh/assets/images/etcd-sync-sequence-admin-en-29e7ea74b69fcc2faa148fc0459fc16d.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-gateway-data-sync"></a>3. Gateway Data Sync<a class="hash-link" href="#3-gateway-data-sync" title="Direct link to heading">#</a></h3><p>Assume that the ShenYu gateway is already running properly, and the data synchronization mode is also <code>etcd</code>. How does the gateway receive and process the selector data after updating it on the admin side and sending the changed data to etcd? Let&#x27;s continue our source code analysis to find out.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="31-etcdclient-accept-data"></a>3.1 EtcdClient Accept Data<a class="hash-link" href="#31-etcdclient-accept-data" title="Direct link to heading">#</a></h4><ul><li>EtcdClient.watchDataChange()</li></ul><p>There is a <code>EtcdSyncDataService</code> class on the gateway, which subscribing to the data node through <code>etcdClient</code> and can sense when the data changes.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribeSelectorDataChanges(final String path) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      etcdClient.watchDataChange(path, (updateNode, updateValue) -&gt; cacheSelectorData(updateValue),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              this::unCacheSelectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  //other codes omitted</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Etcd&#x27;s  <code>Watch</code> mechanism notifies subscribing clients of node changes. In our case, updating the selector information goes to the <code>watchDataChange()</code> method. <code>cacheSelectorData()</code> is used to process data.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="32-handle-data"></a>3.2 Handle Data<a class="hash-link" href="#32-handle-data" title="Direct link to heading">#</a></h4><ul><li>EtcdSyncDataService.cacheSelectorData()</li></ul><p>The data is not null, and caching the selector data is again handled by <code>PluginDataSubscriber</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">    private void cacheSelectorData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><code>PluginDataSubscriber</code> is an interface, it is only a <code>CommonPluginDataSubscriber</code> implementation class, responsible for data processing plugin, selector and rules.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="33-common-plugin-data-subscriber"></a>3.3 Common Plugin Data Subscriber<a class="hash-link" href="#33-common-plugin-data-subscriber" title="Direct link to heading">#</a></h4><ul><li>PluginDataSubscriber.onSelectorSubscribe()</li></ul><p>It has no additional logic and calls the <code>subscribeDataHandler()</code> method directly. Within methods, there are data types (plugins, selectors, or rules) and action types (update or delete) to perform different logic.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The common plugin data subscriber, responsible for handling all plug-in, selector, and rule information</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CommonPluginDataSubscriber implements PluginDataSubscriber {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //......</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     // handle selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onSelectorSubscribe(final SelectoData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribeDataHandler(selectorData, DataEventTypeEnum.UPDATE);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // A subscription data handler that handles updates or deletions of data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; void subscribeDataHandler(final T classData, final DataEventTypeEnum dataType) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(classData).ifPresent(data -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (data instanceof PluginData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                PluginData pluginData = (PluginData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                     BaseDataCache.getInstance().cachePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.handlerPlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removePluginData(pluginData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(pluginData.getName())).ifPresent(handler -&gt; handler.removePlugin(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof SelectorData) {  // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                SelectorData selectorData = (SelectorData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) {  // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.removeSelector(selectorData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else if (data instanceof RuleData) {  // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                RuleData ruleData = (RuleData) data;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (dataType == DataEventTypeEnum.UPDATE) { // update</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().cacheRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.handlerRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                } else if (dataType == DataEventTypeEnum.DELETE) { // delete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // delete the data from gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    BaseDataCache.getInstance().removeRuleData(ruleData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Optional.ofNullable(handlerMap.get(ruleData.getPluginName())).ifPresent(handler -&gt; handler.removeRule(ruleData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="34-data-cached-to-memory"></a>3.4 Data cached to Memory<a class="hash-link" href="#34-data-cached-to-memory" title="Direct link to heading">#</a></h4><p>Adding a selector will enter the following logic:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// save the data to gateway memory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">BaseDataCache.getInstance().cacheSelectData(selectorData);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">// If each plugin has its own processing logic, then do it</span></span><span class="token-line" style="color:#393A34"><span class="token plain">Optional.ofNullable(handlerMap.get(selectorData.getPluginName())).ifPresent(handler -&gt; handler.handlerSelector(selectorData));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>One is to save the data to the gateway&#x27;s memory. BaseDataCache is the class that ultimately caches data, implemented in a singleton pattern. The selector data is stored in the <code>SELECTOR_MAP</code> Map. In the subsequent use, also from this data.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">public final class BaseDataCache {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final BaseDataCache INSTANCE = new BaseDataCache();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // private constructor</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BaseDataCache() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Gets instance.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *  public method</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return the instance</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static BaseDataCache getInstance() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return INSTANCE;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      * A Map of the cache selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * pluginName -&gt; SelectorData.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConcurrentMap&lt;String, List&lt;SelectorData&gt;&gt; SELECTOR_MAP = Maps.newConcurrentMap();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void cacheSelectData(final SelectorData selectorData) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(selectorData).ifPresent(this::selectorAccept);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span></span><span class="token-line" style="color:#393A34"><span class="token plain">   /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * cache selector data.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param data the selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void selectorAccept(final SelectorData data) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String key = data.getPluginName();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (SELECTOR_MAP.containsKey(key)) { // Update operation, delete before insert</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            List&lt;SelectorData&gt; existList = SELECTOR_MAP.get(key);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; resultList = existList.stream().filter(r -&gt; !r.getId().equals(data.getId())).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            resultList.add(data);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            final List&lt;SelectorData&gt; collect = resultList.stream().sorted(Comparator.comparing(SelectorData::getSort)).collect(Collectors.toList());</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, collect);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {  // Add new operations directly to Map</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            SELECTOR_MAP.put(key, Lists.newArrayList(data));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Second, if each plugin has its own processing logic, then do it. Through the <code>IDEA</code> editor, you can see that after adding a selector, there are the following plugins and processing. We&#x27;re not going to expand it here.</p><p><img src="/zh/assets/images/handler-selector-bf05b8fdf80a428aa53606178a42bae6.png"></p><p>After the above source tracking, and through a practical case, in the <code>admin</code> end to update a selector data, the <code>ZooKeeper</code> data synchronization process analysis is clear.</p><p>Let&#x27;s series the data synchronization process on the gateway side through the sequence diagram:</p><p><img src="/zh/assets/images/etcd-sync-sequence-gateway-en-4da1d7160168a3ee75741e84d7298e0d.png"></p><p>The data synchronization process has been analyzed. In order to prevent the synchronization process from being interrupted, other logic is ignored during the analysis. We also need to analyze the process of Admin synchronization data initialization and gateway synchronization operation initialization.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-admin-data-sync--initialization"></a>4. Admin Data Sync  initialization<a class="hash-link" href="#4-admin-data-sync--initialization" title="Direct link to heading">#</a></h3><p>When <code>admin</code> starts, the current data will be fully synchronized to <code>etcd</code>, the implementation logic is as follows:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EtcdDataInit.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdDataInit implements CommandLineRunner {</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final EtcdClient etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final SyncDataService syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public EtcdDataInit(final EtcdClient client, final SyncDataService syncDataService) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.etcdClient = client;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.syncDataService = syncDataService;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void run(final String... args) throws Exception {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String pluginPath = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String authPath = DefaultPathConstants.APP_AUTH_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String metaDataPath = DefaultPathConstants.META_DATA;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!etcdClient.exists(pluginPath) &amp;&amp; !etcdClient.exists(authPath) &amp;&amp; !etcdClient.exists(metaDataPath)) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.info(&quot;Init all data from database&quot;);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      syncDataService.syncAll(DataEventTypeEnum.REFRESH);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Check whether there is data in <code>etcd</code>, if not, then synchronize.</p><p><code>EtcdDataInit</code> implements the <code>CommandLineRunner</code> interface. It is an interface provided by <code>SpringBoot</code> that executes the <code>run()</code> method after all <code>Spring Beans</code> initializations and is often used for initialization operations in a project.</p><ul><li>SyncDataService.syncAll()</li></ul><p>Query data from the database, and then perform full data synchronization, all authentication information, plugin information, selector information, rule information, and metadata information. Synchronous events are published primarily through <code>eventPublisher</code>. After publishing the event via <code>publishEvent()</code>, the <code>ApplicationListener</code> performs the event change operation. In <code>ShenYu</code> is mentioned in <code>DataChangedEventDispatcher</code>.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SyncDataServiceImpl implements SyncDataService {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // eventPublisher</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ApplicationEventPublisher eventPublisher;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">     /***</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * sync all data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param type the type</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @return</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean syncAll(final DataEventTypeEnum type) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // app auth data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        appAuthService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // plugin data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;PluginData&gt; pluginDataList = pluginService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.PLUGIN, type, pluginDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // selector data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SelectorData&gt; selectorDataList = selectorService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.SELECTOR, type, selectorDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // rule data</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;RuleData&gt; ruleDataList = ruleService.listAll();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventPublisher.publishEvent(new DataChangedEvent(ConfigGroupEnum.RULE, type, ruleDataList));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // metadata</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        metaDataService.syncData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-gateway-data-sync-init"></a>5. Gateway Data Sync Init<a class="hash-link" href="#5-gateway-data-sync-init" title="Direct link to heading">#</a></h3><p>The initial operation of data synchronization on the gateway side is mainly the node in the subscription <code>etcd</code>. When there is a data change, the changed data will be received. This relies on the <code>Watch</code> mechanism of <code>etcd</code>. In <code>ShenYu</code>, the one responsible for <code>etcd</code> data synchronization is <code>EtcdSyncDataService</code>, also mentioned earlier.</p><p>The function logic of <code>EtcdSyncDataService</code> is completed in the process of instantiation: the subscription to <code>Shenyu</code> data synchronization node in <code>etcd</code> is completed. Subscription here is divided into two kinds, one kind is existing node data updated above, through this <code>etcdClient.subscribeDataChanges()</code> method; Another kind is under the current node, add or delete nodes change namely child nodes, it through <code>etcdClient.subscribeChildChanges()</code> method.</p><p><code>EtcdSyncDataService</code> code is a bit too much, here we use plugin data read and subscribe to track, other types of data operation principle is the same.</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Data synchronize of etcd.</span></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EtcdSyncDataService implements SyncDataService, AutoCloseable {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * Instantiates a new Zookeeper cache manager.</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     *</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param etcdClient             the etcd client</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param pluginDataSubscriber the plugin data subscriber</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param metaDataSubscribers  the meta data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     * @param authDataSubscribers  the auth data subscribers</span></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    public EtcdSyncDataService(final EtcdClient etcdClient, final PluginDataSubscriber pluginDataSubscriber,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    final List&lt;MetaDataSubscriber&gt; metaDataSubscribers, final List&lt;AuthDataSubscriber&gt; authDataSubscribers) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.etcdClient = etcdClient;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.pluginDataSubscriber = pluginDataSubscriber;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.metaDataSubscribers = metaDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.authDataSubscribers = authDataSubscribers;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchAppAuth();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watchMetaData();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherData() {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String pluginParent = DefaultPathConstants.PLUGIN_PARENT;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;String&gt; pluginZKs = etcdClientGetChildren(pluginParent);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (String pluginName : pluginZKs) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            watcherAll(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        etcdClient.watchChildChange(pluginParent, (updateNode, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (!updateNode.isEmpty()) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                watcherAll(updateNode);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, null);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherAll(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherPlugin(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherSelector(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        watcherRule(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void watcherPlugin(final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        String pluginPath = DefaultPathConstants.buildPluginPath(pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        cachePluginData(etcdClient.get(pluginPath));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        subscribePluginDataChanges(pluginPath, pluginName);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void cachePluginData(final String dataString) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        final PluginData pluginData = GsonUtils.getInstance().fromJson(dataString, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Optional.ofNullable(pluginData)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                .flatMap(data -&gt; Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -&gt; e.onSubscribe(pluginData));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    private void subscribePluginDataChanges(final String pluginPath, final String pluginName) {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    etcdClient.watchDataChange(pluginPath, (updatePath, updateValue) -&gt; {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataPath = buildRealPath(pluginPath, updatePath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final String dataStr = etcdClient.get(dataPath);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      final PluginData data = GsonUtils.getInstance().fromJson(dataStr, PluginData.class);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">      Optional.ofNullable(data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">              .ifPresent(d -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSubscribe(d)));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }, deleteNode -&gt; deletePlugin(pluginName));</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The above source code is given comments, I believe you can understand. The main logic for subscribing to plug-in data is as follows:</p><blockquote><ol><li>Create the current plugin path</li><li>Read the current node data on etcd and deserialize it</li><li>The plugin data is cached in the gateway memory</li><li>Subscribe to the plug-in node</li></ol></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-summary"></a>6. Summary<a class="hash-link" href="#6-summary" title="Direct link to heading">#</a></h3><p>This paper through a practical case, <code>etcd</code> data synchronization principle source code analysis. The main knowledge points involved are as follows:</p><ul><li><p>Data synchronization based on <code>etcd</code> is mainly implemented through <code>watch</code> mechanism;</p></li><li><p>Complete event publishing and listening via <code>Spring</code>;</p></li><li><p>Support multiple synchronization strategies through abstract <code>DataChangedListener</code> interface, interface oriented programming;</p></li><li><p>Use singleton design pattern to cache data class <code>BaseDataCache</code>;</p></li><li><p>Loading of configuration classes via conditional assembly of <code>SpringBoot</code> and <code>starter</code> loading mechanism.</p></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><a class="margin-horiz--sm" href="/zh/blog/tags/etcd">etcd</a><a class="margin-horiz--sm" href="/zh/blog/tags/data-sync">data sync</a><a class="margin-horiz--sm" href="/zh/blog/tags/apache-shen-yu">Apache ShenYu</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh/blog"><div class="pagination-nav__label">Â« Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ShenYu</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/download">ä¸‹è½½</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/docs/index">æ–‡æ¡£</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/news">æ–°é—»</a></li><li class="footer__item"><a class="footer__link-item" href="/zh/blog">åšå®¢</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>ç‰ˆæœ¬<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">ç¤¾åŒº</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/community/subscribe-email">ç¤¾åŒº</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-shenyu/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">è®¢é˜…é‚®ä»¶ç»„</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh/community/subscribe-email">å¦‚ä½•è®¢é˜…</a></li><li class="footer__item"><a href="mailto://dev-subscribe@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>è®¢é˜…é‚®ä»¶<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@shenyu.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>é‚®ä»¶å½’æ¡£<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div><img style="height:50px" alt="Apache Software Foundation" src="/img/incubator-logo.png"><p style="color:#ffffffcf;font-size:14px;text-align:left">Apache ShenYu is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
      <p style="color:white;font-size:14px;"> Copyright Â© 2021 The Apache Software Foundation. Licensed under the Apache License, Version 2.0. Apache ShenYu, Apache Incubator, Apache, the Apache feather logo, the Apache ShenYu logo and the Apache Incubator project logo are trademarks of The Apache Software Foundation.</p>
      <div></div></div></div></div></div></footer></div>
<script src="/zh/assets/js/runtime~main.0e06cfab.js"></script>
<script src="/zh/assets/js/main.b8c1dc42.js"></script>
</body>
</html>